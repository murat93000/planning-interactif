<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning BLINK - Version Cloud</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- SheetJS pour export Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        min-height: 100vh;
        padding: 20px;
        animation: gradientShift 15s ease infinite;
        padding-left: 320px;
    }

    @keyframes gradientShift {
        0%, 100% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
        33% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%); }
        66% { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 50%, #764ba2 100%); }
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 24px;
        padding: 30px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
    }

    .header h1 {
        font-size: 2.8em;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
    }

    .auth-section {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 16px;
        transition: all 0.3s ease;
        font-size: 14px;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        margin: 5px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
    }

    .btn.admin {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .btn.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .btn.warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-right: 2px solid rgba(102, 126, 234, 0.3);
        padding: 20px;
        box-shadow: 10px 0 40px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        overflow-y: auto;
        display: none;
    }

    .sidebar.show {
        display: block;
    }

    .sidebar-section {
        margin-bottom: 30px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .sidebar-title {
        font-size: 16px;
        font-weight: 700;
        color: #374151;
        margin-bottom: 15px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .sidebar-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .sidebar .time-slot-template,
    .sidebar .template {
        padding: 12px 16px;
        border-radius: 12px;
        cursor: move;
        font-size: 18px;
        font-weight: 700;
        color: white;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
        position: relative;
    }

    .sidebar .time-slot-template {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .sidebar .time-slot-template:hover,
    .sidebar .template:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    .controls {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .control-group label {
        font-weight: 600;
        color: #374151;
        font-size: 12px;
    }

    .control-group input {
        padding: 10px 15px;
        border: 2px solid rgba(102, 126, 234, 0.3);
        border-radius: 12px;
        font-size: 14px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
        min-width: 150px;
    }

    .control-group input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .time-slots-config {
        margin-bottom: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .time-slots-list {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .time-slot-template {
        padding: 10px 16px;
        border-radius: 16px;
        cursor: move;
        font-size: 14px;
        font-weight: 700;
        color: white;
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        position: relative;
    }

    .time-slot-template:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .time-slot-template .delete-slot {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .time-slot-template:hover .delete-slot {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .time-slot-template .delete-slot:hover {
        background: #dc2626;
        transform: scale(1.2);
    }

    .time-slot-creator {
        display: flex;
        justify-content: center;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .templates-section {
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .templates-title {
        text-align: center;
        font-weight: 700;
        color: #374151;
        margin-bottom: 15px;
        font-size: 16px;
    }

    .templates {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .template {
        padding: 12px 20px;
        border-radius: 20px;
        cursor: move;
        font-size: 13px;
        font-weight: 700;
        color: white;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
    }

    .template.repos {
        background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    .template.absent {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .template.cours {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .template.conges {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .template.retard {
        background: linear-gradient(135deg, #f97316, #ea580c);
    }

    .template.ferie {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .template.custom {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .template:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    }

    .template.dragging {
        opacity: 0.7;
        transform: rotate(8deg) scale(0.95);
    }

    .template .delete-template {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .template:hover .delete-template {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .template .delete-template:hover {
        background: #dc2626;
        transform: scale(1.2);
    }

    .custom-template-creator {
        display: flex;
        justify-content: center;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .color-picker {
        width: 40px;
        height: 40px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .color-picker:hover {
        transform: scale(1.1);
        border-color: #667eea;
    }

    .week-templates {
        margin-bottom: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .week-template-controls {
        display: flex;
        justify-content: center;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .week-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 24px;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .current-week {
        font-weight: 700;
        min-width: 250px;
        text-align: center;
        color: #374151;
        font-size: 16px;
    }

    .planning-grid {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 30px;
    }

    .grid {
        display: grid;
        grid-template-columns: 200px repeat(7, 1fr);
        gap: 2px;
        background: #f8fafc;
        border-radius: 16px;
        padding: 8px;
    }

    .grid-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 16px 8px;
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        border-radius: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .employee-cell {
        background: linear-gradient(135deg, #374151, #1f2937);
        color: white;
        padding: 16px 12px;
        font-weight: 600;
        font-size: 13px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-start;
        border-radius: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 4px 12px rgba(55, 65, 81, 0.3);
        position: relative;
        min-height: 80px;
    }

    .employee-name {
        font-weight: 800;
        margin-bottom: 4px;
        font-size: 16px;
    }

    .employee-role {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .employee-hours {
        font-size: 12px;
        opacity: 0.7;
        margin-top: auto;
    }

    .remove-emp {
        position: absolute;
        top: 4px;
        right: 4px;
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .employee-cell:hover .remove-emp {
        opacity: 1;
    }

    .copy-week-btn {
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 9px;
        cursor: pointer;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .employee-cell:hover .copy-week-btn {
        opacity: 1;
    }

    .paste-week-btn {
        position: absolute;
        bottom: 4px;
        right: 4px;
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 9px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .day-cell {
        background: white;
        min-height: 65px;
        padding: 8px;
        border: 2px dashed #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .day-cell:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .day-cell.drag-over {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
        border-style: solid;
        transform: scale(1.02);
    }

    .shift-card {
        padding: 8px 10px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 700;
        color: white;
        position: relative;
        cursor: move;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-align: center;
        user-select: none;
    }

    .shift-card.work {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .shift-card.repos {
        background: linear-gradient(135deg, #6b7280, #4b5563);
    }

    .shift-card.absent {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .shift-card.cours {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .shift-card.conges {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .shift-card.retard {
        background: linear-gradient(135deg, #f97316, #ea580c);
    }

    .shift-card.ferie {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .shift-card.custom {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .shift-card:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .shift-card .actions {
        position: absolute;
        top: -8px;
        right: -8px;
        display: none;
        gap: 2px;
    }

    .shift-card:hover .actions {
        display: flex;
    }

    .shift-card .action-btn {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 9px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .shift-card .action-btn.copy {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .shift-card .action-btn.delete {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .shift-card .action-btn.paste {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
        padding: 20px;
        border-radius: 16px;
        text-align: center;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .summary-card h4 {
        margin-bottom: 10px;
        color: #374151;
        font-weight: 600;
        font-size: 14px;
    }

    .summary-card .value {
        font-size: 2em;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* NOUVEAU : R√©capitulatif toujours visible */
    .employee-recap {
        margin-top: 30px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    }

    .recap-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    }

    .recap-title {
        font-size: 1.8em;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .recap-period-selector {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .recap-period-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: #667eea;
        transition: all 0.3s ease;
    }

    .recap-period-btn.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .recap-period-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        backdrop-filter: blur(10px);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }

    .modal h2 {
        margin-bottom: 20px;
        text-align: center;
        color: #374151;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #374151;
    }

    .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-group input:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        font-weight: 600;
        z-index: 1001;
        animation: toastSlide 0.3s ease;
    }

    .toast.success {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    @keyframes toastSlide {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .admin-panel {
        display: none;
    }

    @media (max-width: 1200px) {
        body {
            padding-left: 20px;
        }
        
        .sidebar {
            display: none !important;
        }
        
        .grid {
            grid-template-columns: 180px repeat(7, 1fr);
        }
    }

    @media (max-width: 900px) {
        .grid {
            grid-template-columns: 150px repeat(7, 1fr);
            font-size: 12px;
        }
    }

    @media (max-width: 600px) {
        .container {
            padding: 15px;
        }
        
        .grid {
            grid-template-columns: 120px repeat(7, 1fr);
            font-size: 10px;
        }
        
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
    }

    .shift-card .action-btn.edit {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .shift-card .action-btn.edit:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        transform: scale(1.1);
    }

    .shift-card.dragging {
        opacity: 0.5 !important;
        transform: rotate(5deg) scale(0.95);
        z-index: 1000;
    }

    .employee-cell.draggable-employee {
        cursor: move;
    }

    .employee-cell.dragging-employee {
        opacity: 0.6;
        transform: scale(0.98);
        z-index: 1000;
        border: 2px dashed #667eea;
    }

    .employee-row.drag-over-employee {
        border-top: 3px solid #667eea;
        background: rgba(102, 126, 234, 0.1);
    }

    .drag-indicator {
        position: absolute;
        left: 0;
        right: 0;
        height: 3px;
        background: #667eea;
        z-index: 999;
        animation: dragPulse 1s infinite;
    }

    @keyframes dragPulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; }
    }

    .cloud-sync-info {
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        z-index: 1002;
        opacity: 0;
        transform: translateX(400px);
        transition: all 0.5s ease;
    }

    .cloud-sync-info.show {
    opacity: 1;
        
        font-size: 16px;
        margin-right: 8px;
    }
/* üîí S√âCURIT√â : D√©sactivation en mode lecteur */
    body:not(.admin-mode) .btn:not(.mode-toggle-btn):not(.btn-login):not(.btn-cancel):not(.week-nav-btn):not(.modal-btn),
    body:not(.admin-mode) input:not(#adminPassword):not(#employeePassword),
    body:not(.admin-mode) select,
    body:not(.admin-mode) textarea,
    body:not(.admin-mode) .template,
    body:not(.admin-mode) .time-slot-template,
    body:not(.admin-mode) [draggable="true"] {
        pointer-events: none;
        opacity: 0.5;
        cursor: not-allowed !important;
    }

    body:not(.admin-mode) .time-slot,
    body:not(.admin-mode) .employee-cell {
        cursor: default !important;
    }

    /* üîí Barre de statut Admin */
    .admin-status-bar {
    position: fixed;
    top: 20px;
    left: 20px;     ‚Üê CHANG√â ICI
    padding: 15px 25px;
    border-radius: 16px;
    font-weight: 700;
    font-size: 14px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 10px;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

    .admin-status-bar.reader-mode {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .admin-status-bar.admin-mode {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .admin-status-bar button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 8px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .admin-status-bar button:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }
       
</style>
</head>
<body>

<!-- üîí NOUVEAUT√â : Barre de statut Admin -->
<div class="admin-status-bar reader-mode" id="adminStatusBar">
    <span id="statusText">üîí Mode Lecteur</span>
    <button class="mode-toggle-btn" onclick="toggleMode()">D√©verrouiller</button>
</div>

    <div class="container">
        <div class="header">
            <h1>üìÖ Planning Optic2000 Cloud</h1>
            <p>Syst√®me de gestion d'√©quipe boutique BLINK avec synchronisation cloud Firebase</p>
            <div id="connectionStatus" style="margin-top: 10px; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;">
                <span id="statusText">üîÑ Connexion en cours...</span>
                <span id="userInfo" style="margin-left: 10px;"></span>
            </div>
        </div>
    <div class="auth-section">
        
        <button class="btn" id="authBtn" onclick="toggleAuth()">üîë Se connecter</button>
        <button class="btn warning" onclick="logoutEmployee()" style="margin-left: 10px;">üö™ D√©connexion</button>
        <div class="admin-panel" style="margin-top: 15px;">
            <button class="btn admin" onclick="openEmployeeModal()">üë§ Ajouter Employ√©</button>
            <button class="btn admin" onclick="openBulkFillModal()">üìÖ Remplissage par Date</button>
            <button class="btn warning" onclick="saveToCloud()">‚òÅÔ∏è Sauver sur Cloud</button>
            <button class="btn warning" onclick="forceLoadFromCloud()">üîÑ Recharger Cloud</button>
            <button class="btn warning" onclick="saveData()">üíæ Sauver Local+Cloud</button>
            <button class="btn" onclick="undo()" id="undoBtn" title="Ctrl+Z">‚Ü∂ Annuler</button>
            <button class="btn" onclick="redo()" id="redoBtn" title="Ctrl+Y">‚Ü∑ Refaire</button>
            <button class="btn" onclick="shareOpening()">üîó Partager Planning</button>
            <button class="btn warning" onclick="exportToJSON()">üì• Export JSON</button>
            <button class="btn warning" onclick="importFromJSON()">üì§ Import JSON</button>
            <button class="btn danger" onclick="clearCurrentWeek()">üóëÔ∏è Vider Semaine Courante</button>
            <button class="btn warning" onclick="openArchivesModal()" style="margin-left: 10px;">üì¶ Archives</button>
        </div>
    </div>

    <div class="controls admin-panel">
        <div class="control-group">
            <label>üë§ Nom employ√©</label>
            <input type="text" id="empName" placeholder="Nom complet">
        </div>
        <div class="control-group">
            <label>üíº Poste</label>
            <input type="text" id="empRole" placeholder="Fonction">
        </div>
        <div class="control-group">
            <label>üìã Contrat (h/sem)</label>
            <input type="number" id="empContractHours" placeholder="35" value="35" min="1" max="48" step="0.5" style="width: 80px;">
        </div>
        <button class="btn" onclick="addEmployee()">‚ûï Ajouter</button>
    </div>

    <div class="time-slots-config admin-panel">
        <div class="templates-title">‚è∞ Cr√©neaux Horaires - Glissez dans le planning</div>
        <div class="time-slots-list" id="timeSlotsContainer"></div>
        <div class="time-slot-creator">
            <input type="text" id="slotName" placeholder="Nom du cr√©neau (ex: Journ√©e A)" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; width: 150px;">
            <input type="time" id="slotStart" value="09:00" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px;">
            <span style="font-weight: bold; color: #374151;">-</span>
            <input type="time" id="slotEnd" value="18:30" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px;">
            <button class="btn" onclick="addTimeSlot()">‚ú® Cr√©er Cr√©neau</button>
        </div>
    </div>

    <div class="templates-section admin-panel">
        <div class="templates-title">üé® Cases Types - Glissez dans le planning</div>
        <div class="templates" id="templatesContainer">
            <div class="template repos" draggable="true" data-type="repos">üò¥ Repos</div>
            <div class="template absent" draggable="true" data-type="absent">‚ùå Absent</div>
            <div class="template cours" draggable="true" data-type="cours">üìö Cours</div>
            <div class="template conges" draggable="true" data-type="conges">üèñÔ∏è Cong√©s</div>
            <div class="template ferie" draggable="true" data-type="ferie" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">üéå F√©ri√©</div>
            <div class="template retard" draggable="true" data-type="retard" style="background: linear-gradient(135deg, #f97316, #ea580c);">‚è∞ Retard</div>
        </div>
        
        <div class="custom-template-creator">
            <input type="text" id="customText" placeholder="Case personnalis√©e..." style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px;">
            <input type="color" id="customColor" class="color-picker" value="#8b5cf6" title="Choisir couleur">
            <button class="btn" onclick="addCustomTemplate()">‚ú® Cr√©er Case</button>
        </div>
    </div>

    <div class="week-templates admin-panel">
        <div class="templates-title">üìã Semaines Types</div>
        <div class="week-template-controls">
            <select id="weekTemplateSelect" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; min-width: 200px;">
                <option value="">S√©lectionner une semaine type...</option>
            </select>
            <button class="btn" onclick="saveWeekTemplate()">üíæ Sauver Semaine Type</button>
            <button class="btn" onclick="applyWeekTemplate()">üìã Appliquer Semaine Type</button>
            <button class="btn danger" onclick="deleteWeekTemplate()">üóëÔ∏è Supprimer Type</button>
        </div>
    </div>

    <div class="week-nav">
        <button class="btn week-nav-btn" onclick="changeWeek(-1)">‚¨ÖÔ∏è Semaine pr√©c√©dente</button>
        <div class="current-week" id="weekDisplay">Semaine courante</div>
        <button class="btn week-nav-btn" onclick="changeWeek(1)">Semaine suivante ‚û°Ô∏è</button>
    </div>

    <div class="planning-grid">
        <div class="grid" id="planningGrid"></div>
    </div>

    <div class="summary">
        <div class="summary-card">
            <h4>üë• Employ√©s</h4>
            <div class="value" id="empCount">0</div>
        </div>
        <div class="summary-card">
            <h4>üìã Cases assign√©es</h4>
            <div class="value" id="shiftCount">0</div>
        </div>
        <div class="summary-card">
            <h4>üìä Taux occupation</h4>
            <div class="value" id="occupationRate">0%</div>
        </div>
    </div>

    <!-- NOUVEAU : R√©capitulatif toujours visible -->
    <div class="employee-recap">
        <div class="recap-header">
            <h3 class="recap-title">üìä R√©capitulatif D√©taill√©</h3>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <div class="recap-period-selector">
                    <button class="recap-period-btn active" id="weekRecapBtn" onclick="switchRecapPeriod('week')">Semaine</button>
                    <button class="recap-period-btn" id="monthRecapBtn" onclick="switchRecapPeriod('month')">Mois</button>
                </div>
                <div class="admin-panel" style="display: flex; gap: 8px;">
                    <button class="btn" onclick="openRegularisationModal()" style="padding: 8px 12px; font-size: 12px;">üí∞ R√©gulariser</button>
                    <button class="btn admin" onclick="openExportMailModal()" style="padding: 8px 12px; font-size: 12px;">üìß Export Mail</button>
                </div>
            </div>
        </div>
        <div id="employeeRecap" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;"></div>
    </div>
</div>

<div class="sidebar admin-panel" id="sidebar">
    <div class="sidebar-section">
        <div class="sidebar-title">‚è∞ Cr√©neaux Horaires</div>
        <div class="sidebar-content" id="sidebarTimeSlots"></div>
    </div>
    
    <div class="sidebar-section">
        <div class="sidebar-title">üé® Cases Types</div>
        <div class="sidebar-content" id="sidebarTemplates"></div>
    </div>
</div>

<div id="employeeModal" class="modal">
    <div class="modal-content">
        <h2>üë§ Ajouter un Employ√©</h2>
        <form id="employeeForm">
            <div class="form-group">
                <label>Nom complet:</label>
                <input type="text" id="modalEmpName" required>
            </div>
            <div class="form-group">
                <label>Poste/Fonction:</label>
                <input type="text" id="modalEmpRole" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn modal-btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn admin">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<div id="bulkFillModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h2>üìÖ Remplissage Automatique par Date</h2>
        <form id="bulkFillForm">
            <div class="form-group">
                <label>üë§ Employ√© :</label>
                <select id="bulkEmployeeSelect" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <option value="">S√©lectionner un employ√©...</option>
                    <option value="ALL">üåü TOUS LES EMPLOY√âS</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üìÖ Date de d√©but :</label>
                <input type="date" id="bulkStartDate" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div class="form-group">
                <label>üìÖ Date de fin :</label>
                <input type="date" id="bulkEndDate" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            
            <div class="form-group">
                <label>üéØ Type de case :</label>
                <select id="bulkCaseType" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <option value="">S√©lectionner un type...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üìã Cr√©neaux horaires (pour les jours de travail) :</label>
                <select id="bulkTimeSlot" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <option value="">Aucun cr√©neau sp√©cifique</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>üìÜ Jours de la semaine :</label>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="dayMon" checked> Lundi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="dayTue" checked> Mardi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="dayWed" checked> Mercredi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="dayThu" checked> Jeudi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="dayFri" checked> Vendredi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="daySat"> Samedi
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: normal;">
                        <input type="checkbox" id="daySun"> Dimanche
                    </label>
                    <button type="button" onclick="toggleAllDays()" style="grid-column: 1 / -1; padding: 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        üîÑ Tout cocher/d√©cocher
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                    <input type="checkbox" id="replaceExisting">
                    ‚ö†Ô∏è Remplacer les cases existantes
                </label>
                <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                    Si d√©coch√©, les nouvelles cases s'ajouteront aux existantes
                </small>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn admin">üöÄ Remplir Planning</button>
            </div>
        </form>
    </div>
</div>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h2>üîí Acc√®s Administrateur</h2>
        <form id="passwordForm">
            <div class="form-group">
                <label>Mot de passe:</label>
                <input type="password" id="adminPassword" required>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn admin modal-btn">Valider</button>
            </div>
        </form>
    </div>
</div>

<div id="employeeAuthModal" class="modal">
    <div class="modal-content">
        <h2>üîí Acc√®s Planning</h2>
        <p style="text-align: center; color: #6b7280; margin-bottom: 20px;">
            Entrez le mot de passe pour acc√©der au planning
        </p>
        <form id="employeeAuthForm">
            <div class="form-group">
                <label>Mot de passe employ√©:</label>
                <input type="password" id="employeePassword" required placeholder="Tapez le mot de passe...">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn admin">üîì Acc√©der au Planning</button>
            </div>
        </form>
    </div>
</div>

<div id="archivesModal" class="modal">
    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
        <h2>üì¶ Employ√©s Archiv√©s</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            Les employ√©s archiv√©s sont masqu√©s du planning mais leur historique est conserv√©.
        </p>
        <div id="archivesList" style="display: flex; flex-direction: column; gap: 15px;"></div>
        <div class="form-actions" style="margin-top: 20px;">
            <button type="button" class="btn" onclick="closeModal()">Fermer</button>
        </div>
    </div>
</div>

<!-- MODALE √âDITION EMPLOY√â -->
<div id="editEmployeeModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h2>‚úèÔ∏è Modifier l'Employ√©</h2>
        <form id="editEmployeeForm" onsubmit="saveEditedEmployee(event)">
            <input type="hidden" id="editEmpId">
            <div class="form-group">
                <label>üë§ Nom complet:</label>
                <input type="text" id="editEmpName" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>üíº Poste/Fonction:</label>
                <input type="text" id="editEmpRole" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>üìã Heures contrat par semaine:</label>
                <input type="number" id="editEmpContractHours" min="1" max="48" step="0.5" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Exemples: 35h (temps plein), 24h (temps partiel), 39h...</p>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn admin">üíæ Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- MODALE SAISIE RETARD -->
<div id="retardModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <h2>‚è∞ Saisir un Retard</h2>
        <form id="retardForm" onsubmit="saveRetard(event)">
            <input type="hidden" id="retardEmployeeId">
            <input type="hidden" id="retardDay">
            <div class="form-group">
                <label>Dur√©e du retard :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="retardHeures" min="0" max="8" value="0" style="width: 70px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; text-align: center;">
                    <span style="font-weight: 600;">h</span>
                    <input type="number" id="retardMinutes" min="0" max="59" value="30" step="5" style="width: 70px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; text-align: center;">
                    <span style="font-weight: 600;">min</span>
                </div>
            </div>
            <div class="form-group">
                <label>Motif (optionnel) :</label>
                <input type="text" id="retardMotif" placeholder="Ex: Transport, RDV m√©dical..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn warning">‚è∞ Ajouter Retard</button>
            </div>
        </form>
    </div>
</div>

<!-- MODALE SAISIE HEURES (Cours/Cong√©s/F√©ri√©) -->
<div id="heuresAbsenceModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <h2 id="heuresAbsenceTitle">üìö Saisir les heures</h2>
        <form id="heuresAbsenceForm" onsubmit="saveHeuresAbsence(event)">
            <input type="hidden" id="heuresAbsenceEmployeeId">
            <input type="hidden" id="heuresAbsenceDay">
            <input type="hidden" id="heuresAbsenceType">
            <div class="form-group">
                <label>üïê Horaires (optionnel) :</label>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <input type="time" id="heuresAbsenceStart" value="09:00" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <span style="font-weight: 600;">-</span>
                    <input type="time" id="heuresAbsenceEnd" value="17:00" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <button type="button" onclick="calculateHeuresFromTime()" class="btn" style="padding: 8px 12px; font-size: 12px;">üìä Calculer</button>
                </div>
            </div>
            <div class="form-group">
                <label>Heures √† comptabiliser :</label>
                <p style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">Ces heures seront ajout√©es au total travaill√©</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="heuresAbsenceHeures" min="0" max="12" value="7" style="width: 80px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; text-align: center; font-weight: 700;">
                    <span style="font-weight: 600;">h</span>
                    <input type="number" id="heuresAbsenceMinutes" min="0" max="59" value="0" step="5" style="width: 80px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; text-align: center; font-weight: 700;">
                    <span style="font-weight: 600;">min</span>
                </div>
            </div>
            <div class="form-group">
                <label>Note (optionnel) :</label>
                <input type="text" id="heuresAbsenceNote" placeholder="Ex: Formation CFA, Toussaint..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </div>
            <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-top: 15px;">
                <p style="color: #1e40af; font-size: 13px;">üí° <strong>Astuce :</strong> Renseigne les horaires et clique sur "Calculer" pour remplir automatiquement les heures</p>
            </div>
            <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn admin" id="heuresAbsenceSubmitBtn">‚úÖ Valider</button>
            </div>
        </form>
    </div>
</div>

<!-- MODALE R√âGULARISATION -->
<div id="regularisationModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <h2>üí∞ R√©gularisation des heures</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            R√©gularisez les heures suppl√©mentaires ou le d√©ficit d'un employ√©
        </p>
        
        <div class="form-group">
            <label>üë§ Employ√© :</label>
            <select id="regularisationEmploye" onchange="updateRegularisationSolde()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
            </select>
        </div>
        
        <div id="regularisationInfo" style="background: #f3f4f6; border-radius: 12px; padding: 15px; margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-weight: 600; color: #374151;">Solde actuel :</span>
                <span id="regularisationSoldeActuel" style="font-size: 1.5em; font-weight: 700; color: #667eea;">+0h</span>
            </div>
            <div id="regularisationSoldeCumuleContainer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px dashed #d1d5db;">
                <span style="font-weight: 500; color: #6b7280;">üìä Solde cumul√© :</span>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="regularisationSoldeCumule" style="font-size: 1.2em; font-weight: 700; color: #667eea;">0h</span>
                    <button type="button" onclick="openRazCumulModal()" class="btn" style="padding: 4px 8px; font-size: 11px; background: #fee2e2; color: #dc2626;">üîÑ RAZ</button>
                </div>
            </div>
            <div id="regularisationHistorique" style="font-size: 12px; color: #6b7280;"></div>
        </div>
        
        <div class="form-group">
            <label>üìù Type de r√©gularisation :</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; flex: 1;">
                    <input type="radio" name="regularisationType" value="paye" checked onchange="updateRegularisationUI()">
                    <span>üíµ Pay√©</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; flex: 1;">
                    <input type="radio" name="regularisationType" value="recupere" onchange="updateRegularisationUI()">
                    <span>üîÑ R√©cup√©r√©</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; flex: 1;">
                    <input type="radio" name="regularisationType" value="reporte" onchange="updateRegularisationUI()">
                    <span>üìÖ Tout reporter</span>
                </label>
            </div>
        </div>
        
        <div id="regularisationHeuresGroup" class="form-group">
            <label>‚è±Ô∏è Heures √† r√©gulariser :</label>
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                <input type="number" id="regularisationHeures" min="0" max="200" value="0" style="width: 100px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;" onchange="updateRegularisationReste()">
                <span style="font-weight: 600;">h</span>
                <input type="number" id="regularisationMinutes" min="0" max="59" value="0" step="5" style="width: 80px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;" onchange="updateRegularisationReste()">
                <span style="font-weight: 600;">min</span>
                <button type="button" onclick="regulariserTout()" class="btn" style="padding: 8px 12px; font-size: 12px;">Tout</button>
            </div>
            <div id="regularisationReste" style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 8px; font-size: 13px; color: #92400e;">
                üìå Reste √† reporter : <strong>0h</strong>
            </div>
        </div>
        
        <div class="form-group">
            <label>üìù Note (optionnel) :</label>
            <input type="text" id="regularisationNote" placeholder="Ex: Pay√© sur paie novembre, R√©cup√©r√© le 15/11..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeModal()">Annuler</button>
            <button type="button" class="btn admin" onclick="executeRegularisation()">‚úÖ Valider</button>
        </div>
    </div>
</div>

<!-- MODALE RAZ CUMUL -->
<div id="razCumulModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h2>üîÑ Ajustement du cumul</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            D√©finir le point de d√©part et le solde initial du cumul
        </p>
        
        <div class="form-group">
            <label>üë§ Employ√© :</label>
            <div id="razCumulEmployeeName" style="padding: 12px; background: #f3f4f6; border-radius: 8px; font-weight: 600;"></div>
        </div>
        
        <div class="form-group">
            <label>üìÖ D√©marrer le cumul √† partir de :</label>
            <input type="month" id="razCumulDate" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        
        <div class="form-group">
            <label>üí∞ Solde de d√©part (optionnel) :</label>
            <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
                <select id="razCumulSigne" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    <option value="-">‚àí D√©ficit</option>
                    <option value="+">+ Exc√©dent</option>
                </select>
                <input type="number" id="razCumulHeures" min="0" max="9999" value="0" placeholder="0" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;">
                <span style="font-weight: 600;">h</span>
                <input type="number" id="razCumulMinutes" min="0" max="59" value="0" step="5" style="width: 70px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 18px; text-align: center; font-weight: 700;">
                <span style="font-weight: 600;">min</span>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                üí° Laisse √† 0 pour repartir de z√©ro, ou saisis une valeur pour reprendre un solde existant.
            </p>
        </div>
        
        <div style="background: #dbeafe; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 13px; color: #1e40af;">
            üìä Le cumul sera : <strong>Solde de d√©part + Soldes des mois √† partir du mois s√©lectionn√©</strong>
        </div>
        
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeRazCumulModal()">Annuler</button>
            <button type="button" class="btn admin" onclick="executeRazCumul()">‚úÖ Valider</button>
        </div>
    </div>
</div>

<!-- MODALE EXPORT COMPTABLE -->
<div id="exportComptableModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <h2>üì§ Export Comptable</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            G√©n√©rez un r√©capitulatif pour votre comptable
        </p>
        
        <div class="form-group">
            <label>üìÖ Mois :</label>
            <input type="month" id="exportMois" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
            <label>üë• Employ√©s √† inclure :</label>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <button type="button" onclick="selectAllExportEmployees(true)" class="btn" style="padding: 6px 12px; font-size: 12px;">‚úÖ Tout s√©lectionner</button>
                <button type="button" onclick="selectAllExportEmployees(false)" class="btn" style="padding: 6px 12px; font-size: 12px;">‚ùå Tout d√©s√©lectionner</button>
            </div>
            <div id="exportEmployesList" style="max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px;">
                <!-- Liste des employ√©s avec cases √† cocher -->
            </div>
        </div>
        
        <div class="form-group" style="margin-top: 15px;">
            <label>üìã Format :</label>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; flex: 1;">
                    <input type="radio" name="exportFormat" value="texte" checked>
                    <span>üìÑ Texte (.txt)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; flex: 1;">
                    <input type="radio" name="exportFormat" value="email">
                    <span>üìß Copier pour email</span>
                </label>
            </div>
        </div>
        
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeModal()">Annuler</button>
            <button type="button" class="btn admin" onclick="executeExportComptable()">üì§ Exporter</button>
        </div>
    </div>
</div>
        </div>
    </div>
</div>

<!-- MODALE RAZ SOLDES -->
<div id="razSoldesModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h2>üîÑ Remise √† Z√©ro des Soldes</h2>
        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            Remettez les soldes d'heures √† z√©ro apr√®s r√©gularisation ou en d√©but de p√©riode.
        </p>
        <div class="form-group">
            <label>üë• S√©lection :</label>
            <select id="razSelection" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                <option value="tous">üåü TOUS les employ√©s</option>
            </select>
        </div>
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; margin-top: 15px;">
            <p style="color: #92400e; font-size: 13px;">‚ö†Ô∏è <strong>Attention :</strong> Cette action remet le solde d'heures cumul√© √† 0. L'historique des plannings est conserv√©.</p>
        </div>
        <div class="form-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn" onclick="closeModal()">Annuler</button>
            <button type="button" class="btn danger" onclick="executeRazSoldes()">üîÑ Remettre √† Z√©ro</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAfR_JWPDlpvSLA3NzmQbaznZ4F96eUJ9A",
        authDomain: "planning-pro-o2.firebaseapp.com",
        projectId: "planning-pro-o2",
        storageBucket: "planning-pro-o2.firebasestorage.app",
        messagingSenderId: "995287000230",
        appId: "1:995287000230:web:a649b621b84ead3e1c4067"
    };

    let db = null;
    let auth = null;
    let currentUser = null;
    let isFirebaseEnabled = false;
    const ADMIN_PASSWORD = '123123';
    const EMPLOYEE_PASSWORD = '2010';
    let isEmployeeAuthenticated = false;
    let undoStack = [];
    let redoStack = [];
    const MAX_UNDO_STEPS = 20;
    let globalState = {
        employees: [],
        currentWeek: new Date(),
        isAdminMode: false,
        draggedItem: null,
        customTemplates: [],
        timeSlots: [],
        weekTemplates: [],
        copiedShift: null,
        copiedWeek: null,
        recapPeriod: 'week' // NOUVEAU : par d√©faut sur semaine
    };
    let draggedShiftData = null;
    let draggedEmployeeData = null;

    function initFirebase() {
        try {
            if (firebaseConfig.apiKey === "VOTRE_API_KEY") {
                console.warn("‚ö†Ô∏è Firebase non configur√© - fonctionnement en mode local uniquement");
                updateConnectionStatus("local", "Firebase non configur√© - Mode local");
                return false;
            }

            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            isFirebaseEnabled = true;

            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateAuthDisplay();
                if (user) {
                    updateConnectionStatus("connected", `Connect√©: ${user.email}`);
                    loadFromCloud();
                } else {
                    updateConnectionStatus("disconnected", "Non connect√©");
                }
            });

            updateConnectionStatus("ready", "Firebase pr√™t");
            return true;
        } catch (error) {
            console.error("Erreur initialisation Firebase:", error);
            updateConnectionStatus("error", "Erreur Firebase");
            return false;
        }
    }

    function updateConnectionStatus(status, message) {
        const statusDiv = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');

        if (!statusDiv || !statusText) return;

        statusText.textContent = message;

        switch(status) {
            case 'connected':
                statusDiv.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                statusDiv.style.color = 'white';
                break;
            case 'disconnected':
            case 'local':
                statusDiv.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                statusDiv.style.color = 'white';
                break;
            case 'error':
                statusDiv.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                statusDiv.style.color = 'white';
                break;
            default:
                statusDiv.style.background = 'linear-gradient(135deg, #6b7280, #4b5563)';
                statusDiv.style.color = 'white';
        }
    }

    function updateAuthDisplay() {
        const authBtn = document.getElementById('authBtn');
        if (!authBtn) return;

        if (currentUser) {
            authBtn.textContent = 'üö™ Se d√©connecter';
            authBtn.className = 'btn danger';
        } else {
            authBtn.textContent = 'üîë Se connecter';
            authBtn.className = 'btn';
        }
    }

    function toggleAuth() {
        if (!isFirebaseEnabled) {
            showToast('Firebase non configur√©', 'error');
            return;
        }

        if (currentUser) {
            signOut();
        } else {
            signInWithGoogle();
        }
    }

    function signInWithGoogle() {
        if (!auth) return;

        const provider = new firebase.auth.GoogleAuthProvider();
        
        auth.signInWithPopup(provider)
            .then((result) => {
                showToast('Connexion Google r√©ussie ‚úÖ', 'success');
                console.log('Utilisateur connect√©:', result.user.email);
            })
            .catch((error) => {
                console.error('Erreur connexion Google:', error);
                showToast('Erreur de connexion Google', 'error');
            });
    }

    function signOut() {
        if (!auth) return;

        auth.signOut()
            .then(() => {
                showToast('D√©connexion r√©ussie', 'success');
            })
            .catch((error) => {
                console.error('Erreur d√©connexion:', error);
                showToast('Erreur de d√©connexion', 'error');
            });
    }

    function logoutEmployee() {
        if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
            sessionStorage.removeItem('employeeAuth');
            isEmployeeAuthenticated = false;
            location.reload();
        }
    }

    function saveToCloud() {
    if (!isFirebaseEnabled || !db) {
        showToast('Firebase non disponible', 'error');
        return;
    }

    try {
        console.log('üîç V√©rification globalState:', globalState);
        
        if (!globalState) {
            showToast('‚ùå Donn√©es non initialis√©es', 'error');
            return;
        }

        const cleanEmployees = (globalState.employees || []).map(emp => {
            const cleanEmp = {
                id: emp.id,
                name: emp.name || '',
                role: emp.role || '',
                contractHours: emp.contractHours || 35,
                planning: {},
                // üî• AJOUT : Sauvegarder les propri√©t√©s d'archivage
                archived: emp.archived || false,
                archivedDate: emp.archivedDate || null
            };
            
            if (emp.planning && typeof emp.planning === 'object') {
                Object.keys(emp.planning).forEach(weekKey => {
                    if (emp.planning[weekKey] && typeof emp.planning[weekKey] === 'object') {
                        cleanEmp.planning[weekKey] = {};
                        Object.keys(emp.planning[weekKey]).forEach(day => {
                            if (Array.isArray(emp.planning[weekKey][day])) {
                                cleanEmp.planning[weekKey][day] = emp.planning[weekKey][day].map(shift => ({
                                    id: shift.id || generateId(),
                                    type: shift.type || 'work',
                                    text: shift.text || '',
                                    hours: shift.hours || '',
                                    backgroundColor: shift.backgroundColor || '',
                                    slot: shift.slot ? {
                                        id: shift.slot.id,
                                        name: shift.slot.name,
                                        start: shift.slot.start,
                                        end: shift.slot.end
                                    } : null
                                })).filter(shift => shift.id);
                            }
                        });
                    }
                });
            }
            
            return cleanEmp;
        });

        const cleanCustomTemplates = (globalState.customTemplates || []).map(template => ({
            id: template.id || generateId(),
            text: template.text || '',
            color: template.color || '#8b5cf6'
        })).filter(template => template.text);

        const cleanTimeSlots = (globalState.timeSlots || []).map(slot => ({
            id: slot.id || generateId(),
            name: slot.name || '',
            start: slot.start || '09:00',
            end: slot.end || '18:00'
        })).filter(slot => slot.name);

        const dataToSave = {
            employees: cleanEmployees,
            customTemplates: cleanCustomTemplates,
            timeSlots: cleanTimeSlots,
            weekTemplates: globalState.weekTemplates || [],
            currentWeek: globalState.currentWeek.toISOString(),
            lastSave: new Date().toISOString(),
            version: '3.1',
            userId: currentUser ? currentUser.uid : 'shared'
        };

        const dataString = JSON.stringify(dataToSave);
        const sizeKB = Math.round(dataString.length / 1024);
        console.log(`üìä Taille des donn√©es: ${sizeKB} KB`);
        
        if (sizeKB > 900) {
            showToast(`‚ö†Ô∏è Donn√©es volumineuses (${sizeKB} KB). Sauvegarde risqu√©e.`, 'error');
        }

        console.log('üíæ D√©but sauvegarde Firebase...');
        
        db.collection('plannings').doc('main').set(dataToSave)
            .then(() => {
                showToast(`‚òÅÔ∏è Sauvegard√© sur le cloud ! (${sizeKB} KB)`, 'success');
                console.log('‚úÖ Sauvegarde cloud r√©ussie');
            })
            .catch((error) => {
                console.error('‚ùå Erreur sauvegarde Firebase:', error);
                showToast(`Erreur Firebase: ${error.message}`, 'error');
            });
            
    } catch (error) {
        console.error('‚ùå Erreur dans saveToCloud:', error);
        showToast(`Erreur pr√©paration: ${error.message}`, 'error');
    }
}

    function loadFromCloud() {
    if (!isFirebaseEnabled || !db) return;

    db.collection('plannings').doc('main').get()
        .then((doc) => {
            if (doc.exists) {
                const cloudData = doc.data();
                console.log('üì° Donn√©es cloud trouv√©es (main):', cloudData);

                if (cloudData.employees && Array.isArray(cloudData.employees)) {
                    // üî• DEBUG & NORMALISATION des retards
                    cloudData.employees.forEach(emp => {
                        if (emp.planning) {
                            Object.keys(emp.planning).forEach(weekKey => {
                                Object.keys(emp.planning[weekKey]).forEach(dayKey => {
                                    const shifts = emp.planning[weekKey][dayKey];
                                    if (Array.isArray(shifts)) {
                                        shifts.forEach(shift => {
                                            if (shift.type === 'retard') {
                                                console.log(`üîç DEBUG RETARD - ${emp.name} - ${weekKey} jour ${dayKey}:`, JSON.stringify(shift));
                                                
                                                // Si retardMinutes existe, le normaliser
                                                if (shift.retardMinutes !== undefined && shift.retardMinutes !== null && shift.retardMinutes !== '') {
                                                    shift.retardMinutes = parseInt(shift.retardMinutes) || 0;
                                                    console.log(`üîß Retard normalis√© depuis retardMinutes: ${shift.retardMinutes} minutes`);
                                                } 
                                                // SINON, extraire depuis le texte (ex: "‚è∞ -1h30" ou "‚è∞ -30min")
                                                else if (shift.text) {
                                                    let extractedMinutes = 0;
                                                    const text = shift.text;
                                                    
                                                    // Pattern: -Xh ou -XhYY ou -Xmin
                                                    const heuresMatch = text.match(/-(\d+)h/);
                                                    const minutesMatch = text.match(/h(\d+)/); // Minutes apr√®s 'h'
                                                    const minOnlyMatch = text.match(/-(\d+)min/); // Seulement minutes
                                                    
                                                    if (heuresMatch) {
                                                        extractedMinutes += parseInt(heuresMatch[1]) * 60;
                                                    }
                                                    if (minutesMatch) {
                                                        extractedMinutes += parseInt(minutesMatch[1]);
                                                    }
                                                    if (minOnlyMatch && !heuresMatch) {
                                                        extractedMinutes = parseInt(minOnlyMatch[1]);
                                                    }
                                                    
                                                    if (extractedMinutes > 0) {
                                                        shift.retardMinutes = extractedMinutes;
                                                        console.log(`üîß Retard extrait depuis texte "${text}": ${extractedMinutes} minutes`);
                                                    }
                                                }
                                            }
                                        });
                                    }
                                });
                            });
                        }
                    });
                    
                    globalState.employees = cloudData.employees;
                    console.log('üë• Employ√©s charg√©s:', globalState.employees.length);
                }

                if (cloudData.customTemplates && Array.isArray(cloudData.customTemplates)) {
                    globalState.customTemplates = cloudData.customTemplates;
                    loadCustomTemplates();
                    console.log('üé® Templates charg√©s:', globalState.customTemplates.length);
                }

                if (cloudData.timeSlots && Array.isArray(cloudData.timeSlots)) {
                    globalState.timeSlots = cloudData.timeSlots;
                    renderTimeSlots();
                    console.log('‚è∞ Cr√©neaux charg√©s:', globalState.timeSlots.length);
                }

                // üî• AJOUT : Charger les semaines types
                if (cloudData.weekTemplates && Array.isArray(cloudData.weekTemplates)) {
                    globalState.weekTemplates = cloudData.weekTemplates;
                    updateWeekTemplateSelect();
                    console.log('üìã Semaines types charg√©es:', globalState.weekTemplates.length);
                }

                // üî• MODIFI√â : Toujours afficher la semaine courante √† l'ouverture
                // On ne charge plus la semaine sauvegard√©e, on garde la date du jour
                const today = new Date();
                const dayOfWeek = today.getDay();
                const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                today.setDate(today.getDate() + diff);
                globalState.currentWeek = today;
                updateWeekDisplay();

                renderPlanning();
                updateSummary();
                
                localStorage.setItem('planning_data', JSON.stringify({
                    employees: globalState.employees,
                    customTemplates: globalState.customTemplates,
                    timeSlots: globalState.timeSlots,
                    weekTemplates: globalState.weekTemplates, // üî• AJOUT : Sauvegarder aussi en local
                    lastSave: cloudData.lastSave,
                    version: cloudData.version
                }));
                
                showToast('üì° Donn√©es synchronis√©es depuis le cloud', 'success');

                if (cloudData.lastSave) {
                    showCloudSyncInfo(cloudData.lastSave);
                }
            } else {
                console.log('‚ùå Aucune donn√©e cloud trouv√©e dans "main"');
                loadData();
            }
        })
        .catch((error) => {
            console.error('‚ùå Erreur chargement cloud:', error);
            showToast('Erreur chargement cloud, utilisation des donn√©es locales', 'error');
            loadData();
        });
}

    function forceLoadFromCloud() {
        if (!isFirebaseEnabled || !db) {
            showToast('Firebase non disponible', 'error');
            return;
        }

        if (confirm('‚ö†Ô∏è Recharger depuis le cloud ?\n\nCela remplacera les donn√©es locales actuelles.')) {
            showToast('üîÑ Rechargement en cours...', 'success');
            
            db.collection('plannings').doc('main').get()
                .then((doc) => {
                    if (doc.exists) {
                        const cloudData = doc.data();
                        console.log('üì° Rechargement forc√© des donn√©es cloud:', cloudData);

                        if (cloudData.employees && Array.isArray(cloudData.employees)) {
                            // üî• NORMALISATION : S'assurer que retardMinutes est bien un nombre
                            cloudData.employees.forEach(emp => {
                                if (emp.planning) {
                                    Object.keys(emp.planning).forEach(weekKey => {
                                        Object.keys(emp.planning[weekKey]).forEach(dayKey => {
                                            const shifts = emp.planning[weekKey][dayKey];
                                            if (Array.isArray(shifts)) {
                                                shifts.forEach(shift => {
                                                    if (shift.type === 'retard') {
                                                        // Si retardMinutes existe, le normaliser
                                                        if (shift.retardMinutes !== undefined && shift.retardMinutes !== null && shift.retardMinutes !== '') {
                                                            shift.retardMinutes = parseInt(shift.retardMinutes) || 0;
                                                        } 
                                                        // SINON, extraire depuis le texte
                                                        else if (shift.text) {
                                                            let extractedMinutes = 0;
                                                            const text = shift.text;
                                                            const heuresMatch = text.match(/-(\d+)h/);
                                                            const minutesMatch = text.match(/h(\d+)/);
                                                            const minOnlyMatch = text.match(/-(\d+)min/);
                                                            
                                                            if (heuresMatch) extractedMinutes += parseInt(heuresMatch[1]) * 60;
                                                            if (minutesMatch) extractedMinutes += parseInt(minutesMatch[1]);
                                                            if (minOnlyMatch && !heuresMatch) extractedMinutes = parseInt(minOnlyMatch[1]);
                                                            
                                                            if (extractedMinutes > 0) shift.retardMinutes = extractedMinutes;
                                                        }
                                                    }
                                                });
                                            }
                                        });
                                    });
                                }
                            });
                            globalState.employees = cloudData.employees;
                        }

                        if (cloudData.customTemplates && Array.isArray(cloudData.customTemplates)) {
                            globalState.customTemplates = cloudData.customTemplates;
                            loadCustomTemplates();
                        }

                        if (cloudData.timeSlots && Array.isArray(cloudData.timeSlots)) {
                            globalState.timeSlots = cloudData.timeSlots;
                            renderTimeSlots();
                        }

                        renderPlanning();
                        updateSummary();
                        
                        showToast('‚úÖ Donn√©es cloud recharg√©es avec succ√®s', 'success');

                        if (cloudData.lastSave) {
                            showCloudSyncInfo(cloudData.lastSave);
                        }
                    } else {
                        showToast('‚ùå Aucune donn√©e cloud trouv√©e', 'error');
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Erreur rechargement cloud:', error);
                    showToast('Erreur lors du rechargement cloud', 'error');
                });
        }
    }

    function loadCustomTemplates() {
        document.querySelectorAll('.template.custom').forEach(el => el.remove());

        if (Array.isArray(globalState.customTemplates)) {
            globalState.customTemplates.forEach(template => {
                const customTemplate = document.createElement('div');
                customTemplate.className = 'template custom';
                customTemplate.draggable = true;
                customTemplate.dataset.type = 'custom';
                customTemplate.style.background = template.color ? 
                    `linear-gradient(135deg, ${template.color}, ${adjustColor(template.color, -20)})` :
                    'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                customTemplate.innerHTML = `‚öôÔ∏è ${template.text}`;
                
                customTemplate.addEventListener('dragstart', handleDragStart);
                customTemplate.addEventListener('dragend', handleDragEnd);
                
                document.getElementById('templatesContainer').appendChild(customTemplate);
            });
        }
    }

    function enableAutoSaveCloud() {
        if (!isFirebaseEnabled || !currentUser) return;

        setInterval(() => {
            if (globalState.employees && globalState.employees.length > 0) {
                saveToCloud();
            }
        }, 300000);
    }

    function getActiveEmployees() {
        return globalState.employees.filter(emp => !emp.archived);
    }

    document.addEventListener('DOMContentLoaded', function() {
        try {
            initFirebase();
            initializeApp();
        } catch (error) {
            console.error('Erreur initialisation:', error);
            showToast('Erreur d\'initialisation, cr√©ation des donn√©es par d√©faut', 'error');
            createDefaultData();
        }
    });

    function initializeApp() {
        const today = new Date();
        globalState.currentWeek = new Date(today);
        const dayOfWeek = today.getDay();
const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
globalState.currentWeek.setDate(today.getDate() + diff);
        
        setupEventListeners();
        updateWeekDisplay();
        renderTimeSlots();
        
        // üîí NOUVEAUT√â : Initialiser en mode lecteur
        document.body.classList.remove('admin-mode');
        globalState.isAdminMode = false;
        
        const statusBar = document.getElementById('adminStatusBar');
        const statusText = document.getElementById('statusText');
        
        if (statusBar && statusText) {
            statusBar.className = 'admin-status-bar reader-mode';
            statusText.textContent = 'üîí Mode Lecteur';
        }
        
        console.log('üîí Application d√©marr√©e en Mode Lecteur');
        
               
        checkEmployeeAuthentication();
        
        if (isFirebaseEnabled) {
            console.log('‚è≥ Attente de Firebase Auth...');
            setTimeout(() => {
                loadData();
                
                if (currentUser) {
                    enableAutoSaveCloud();
                }
            }, 1500);
        } else {
            loadData();
        }
        
        showToast('Planning initialis√© avec succ√®s', 'success');
    }

    function setupEventListeners() {
        try {
            const employeeForm = document.getElementById('employeeForm');
            const passwordForm = document.getElementById('passwordForm');
            const bulkFillForm = document.getElementById('bulkFillForm');
            const employeeAuthForm = document.getElementById('employeeAuthForm');
            
            if (employeeForm) employeeForm.addEventListener('submit', handleEmployeeSubmit);
            if (passwordForm) passwordForm.addEventListener('submit', handlePasswordSubmit);
            if (bulkFillForm) bulkFillForm.addEventListener('submit', handleBulkFillSubmit);
            if (employeeAuthForm) employeeAuthForm.addEventListener('submit', handleEmployeeAuthSubmit);
            
            document.querySelectorAll('.template').forEach(template => {
                template.addEventListener('dragstart', handleDragStart);
                template.addEventListener('dragend', handleDragEnd);
            });
            
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
            });
            
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
        } catch (error) {
            console.error('Erreur setup √©v√©nements:', error);
        }
    }

    function checkEmployeeAuthentication() {
    // Authentification d√©sactiv√©e - acc√®s direct
    isEmployeeAuthenticated = true;
    sessionStorage.setItem('employeeAuth', 'true');
    showPlanningContent();
}

    function showEmployeeAuthModal() {
        hidePlanningContent();
        
        const modal = document.getElementById('employeeAuthModal');
        if (modal) {
            modal.style.display = 'block';
            
            setTimeout(() => {
                const passwordField = document.getElementById('employeePassword');
                if (passwordField) passwordField.focus();
            }, 100);
        }
    }

    function hidePlanningContent() {
        const container = document.querySelector('.container');
        if (container) {
            container.style.display = 'none';
        }
    }

    function showPlanningContent() {
        const container = document.querySelector('.container');
        if (container) {
            container.style.display = 'block';
        }
        
        renderPlanning();
        updateSummary();
        showToast('Planning charg√© avec succ√®s', 'success');
    }

    function handleEmployeeAuthSubmit(e) {
        try {
            e.preventDefault();
            
            const passwordInput = document.getElementById('employeePassword');
            if (!passwordInput) {
                showToast('Erreur d\'interface', 'error');
                return;
            }
            
            const password = passwordInput.value;
            
            if (password === EMPLOYEE_PASSWORD) {
                isEmployeeAuthenticated = true;
                sessionStorage.setItem('employeeAuth', 'true');
                
                const modal = document.getElementById('employeeAuthModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                showPlanningContent();
                showToast('Acc√®s autoris√© - Bienvenue !', 'success');
            } else {
                showToast('Mot de passe incorrect', 'error');
                passwordInput.value = '';
                passwordInput.focus();
            }
        } catch (error) {
            console.error('Erreur authentification employ√©:', error);
            showToast('Erreur de connexion', 'error');
        }
    }
function logoutEmployee() {
    if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
        sessionStorage.removeItem('employeeAuth');
        isEmployeeAuthenticated = false;
        location.reload();
    }
}

function toggleAuth() {
    if (!isFirebaseEnabled) {
        showToast('Firebase non configur√©', 'error');
        return;
    }
    if (currentUser) {
        signOut();
    } else {
        signInWithGoogle();
    }
}
    function handleKeyboardShortcuts(e) {
        try {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        saveData();
                        break;
                    case 'a':
                        if (globalState.isAdminMode) {
                            e.preventDefault();
                            openEmployeeModal();
                        }
                        break;
                    case 'c':
                        e.preventDefault();
                        saveToCloud();
                        break;
                    case 'r':
                        e.preventDefault();
                        forceLoadFromCloud();
                        break;
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                closeModal();
            }
        } catch (error) {
            console.error('Erreur raccourcis clavier:', error);
        }
    }

    function updateSidebarContent() {
        try {
            if (!globalState.isAdminMode) return;
            
            const sidebarTimeSlots = document.getElementById('sidebarTimeSlots');
            const originalTimeSlots = document.getElementById('timeSlotsContainer');
            if (sidebarTimeSlots && originalTimeSlots) {
                sidebarTimeSlots.innerHTML = '';
                originalTimeSlots.querySelectorAll('.time-slot-template').forEach(slot => {
                    const clone = slot.cloneNode(true);
                    const deleteBtn = clone.querySelector('.delete-slot');
                    if (deleteBtn) deleteBtn.remove();
                    
                    clone.addEventListener('dragstart', handleDragStart);
                    clone.addEventListener('dragend', handleDragEnd);
                    sidebarTimeSlots.appendChild(clone);
                });
            }
            
            const sidebarTemplates = document.getElementById('sidebarTemplates');
            const originalTemplates = document.getElementById('templatesContainer');
            if (sidebarTemplates && originalTemplates) {
                sidebarTemplates.innerHTML = '';
                originalTemplates.querySelectorAll('.template').forEach(template => {
                    const clone = template.cloneNode(true);
                    const deleteBtn = clone.querySelector('.delete-template');
                    if (deleteBtn) deleteBtn.remove();
                    
                    clone.addEventListener('dragstart', handleDragStart);
                    clone.addEventListener('dragend', handleDragEnd);
                    sidebarTemplates.appendChild(clone);
                });
            }
        } catch (error) {
            console.error('Erreur update sidebar content:', error);
        }
    }

    function toggleMode() {
        try {
            console.log('toggleMode appel√©, mode actuel:', globalState.isAdminMode);
            
            if (globalState.isAdminMode) {
                // D√©sactiver le mode admin
                globalState.isAdminMode = false;
                document.body.classList.remove('admin-mode');
                
                // Mettre √† jour la barre de statut
                const statusBar = document.getElementById('adminStatusBar');
                const statusText = document.getElementById('statusText');
                
                if (statusBar && statusText) {
                    statusBar.className = 'admin-status-bar reader-mode';
                    statusText.textContent = 'üîí Mode Lecteur';
                    
                    // Changer le bouton
                    const button = statusBar.querySelector('button');
                    if (button) {
                        button.textContent = 'D√©verrouiller';
                        button.onclick = toggleMode;
                    }
                }
                
                updateModeDisplay();
                showToast('Mode lecture activ√©', 'success');
            } else {
                // Demander le mot de passe pour activer
                openModal('passwordModal');
            }
            
        } catch (error) {
            console.error('Erreur toggleMode:', error);
            showToast('Erreur changement de mode', 'error');
        }
    }

    function openModal(modalId) {
        try {
            console.log('Tentative ouverture modal:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
                console.log('Modal ouvert:', modalId);
                
                const firstInput = modal.querySelector('input');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            } else {
                console.error('Modal non trouv√©:', modalId);
                showToast('Erreur d\'ouverture du modal', 'error');
            }
        } catch (error) {
            console.error('Erreur open modal:', error);
            showToast('Erreur d\'interface', 'error');
        }
    }

    function closeModal() {
        try {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
            
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) passwordInput.value = '';
            
            const empNameInput = document.getElementById('modalEmpName');
            const empRoleInput = document.getElementById('modalEmpRole');
            if (empNameInput) empNameInput.value = '';
            if (empRoleInput) empRoleInput.value = '';
        } catch (error) {
            console.error('Erreur close modal:', error);
        }
    }

    function handlePasswordSubmit(e) {
        e.preventDefault();
        
        try {
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) {
                console.error('Champ mot de passe introuvable');
                return;
            }
            
            const password = passwordInput.value;
            
            if (password === ADMIN_PASSWORD) {
                // ‚úÖ MOT DE PASSE CORRECT
                globalState.isAdminMode = true;
                document.body.classList.add('admin-mode');
                
                // Mettre √† jour la barre de statut
                const statusBar = document.getElementById('adminStatusBar');
                const statusText = document.getElementById('statusText');
                
                if (statusBar && statusText) {
                    statusBar.className = 'admin-status-bar admin-mode';
                    statusText.textContent = '‚úÖ Mode Admin';
                    
                    // Changer le bouton
                    const button = statusBar.querySelector('button');
                    if (button) {
                        button.textContent = 'üîí Verrouiller';
                        button.onclick = toggleMode;
                    }
                }
                
                closeModal();
                updateModeDisplay();
                showToast('Mode admin activ√©', 'success');
                
                passwordInput.value = '';
            } else {
                // ‚ùå MAUVAIS MOT DE PASSE
                showToast('Mot de passe incorrect', 'error');
                passwordInput.value = '';
                passwordInput.focus();
            }
            
        } catch (error) {
            console.error('Erreur handlePasswordSubmit:', error);
            showToast('Erreur de connexion', 'error');
        }
    }

    function handleEmployeeSubmit(e) {
        try {
            e.preventDefault();
            
            const name = document.getElementById('modalEmpName').value.trim();
            const role = document.getElementById('modalEmpRole').value.trim();
            
            if (!name) {
                showToast('Le nom est requis', 'error');
                return;
            }
            
            if (!Array.isArray(globalState.employees)) {
                globalState.employees = [];
            }
            
            if (globalState.employees.find(emp => emp.name.toLowerCase() === name.toLowerCase())) {
                showToast('Un employ√© avec ce nom existe d√©j√†', 'error');
                return;
            }
            
            const newEmployee = {
                id: generateId(),
                name: name,
                role: role || 'Employ√©',
                planning: {}
            };
            
            globalState.employees.push(newEmployee);
            
            closeModal();
            renderPlanning();
            updateSummary();
            saveData();
            showToast('Employ√© ajout√© avec succ√®s', 'success');
        } catch (error) {
            console.error('Erreur employee submit:', error);
            showToast('Erreur lors de l\'ajout', 'error');
        }
    }

    function updateModeDisplay() {
        try {
            // üîí AJOUT : G√©rer la classe admin-mode sur le body
            if (globalState.isAdminMode) {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }
            
            const adminPanels = document.querySelectorAll('.admin-panel');
            const sidebar = document.getElementById('sidebar');
            
            if (globalState.isAdminMode) {
                adminPanels.forEach(panel => panel.style.display = 'block');
                if (sidebar) sidebar.classList.add('show');
                addDeleteButtonsToTemplates();
                updateSidebarContent();
            } else {
                adminPanels.forEach(panel => panel.style.display = 'none');
                if (sidebar) sidebar.classList.remove('show');
                removeDeleteButtonsFromTemplates();
            }
            
            renderPlanning();
        } catch (error) {
            console.error('Erreur update mode display:', error);
        }
    }

    function addDeleteButtonsToTemplates() {
        try {
            const templates = document.querySelectorAll('.template');
            templates.forEach(template => {
                if (template.querySelector('.delete-template')) return;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-template';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.title = 'Supprimer';
                deleteBtn.onclick = () => removeTemplate(deleteBtn);
                
                template.appendChild(deleteBtn);
            });
        } catch (error) {
            console.error('Erreur add delete buttons:', error);
        }
    }

    function removeDeleteButtonsFromTemplates() {
        try {
            const deleteButtons = document.querySelectorAll('.delete-template');
            deleteButtons.forEach(btn => btn.remove());
        } catch (error) {
            console.error('Erreur remove delete buttons:', error);
        }
    }

    function openEmployeeModal() { 
        openModal('employeeModal'); 
    }

    function openBulkFillModal() {
        try {
            const employeeSelect = document.getElementById('bulkEmployeeSelect');
            if (employeeSelect) {
                const defaultOptions = employeeSelect.innerHTML;
                employeeSelect.innerHTML = defaultOptions;
                
                const activeEmployees = getActiveEmployees();
                if (activeEmployees.length > 0) {
                    activeEmployees.forEach(employee => {
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${employee.name} (${employee.role})`;
                        employeeSelect.appendChild(option);
                    });
                }
            }
            
            const caseTypeSelect = document.getElementById('bulkCaseType');
            if (caseTypeSelect) {
                caseTypeSelect.innerHTML = `
                    <option value="">S√©lectionner un type...</option>
                    <option value="repos" data-bg="linear-gradient(135deg, #6b7280, #4b5563)">üò¥ Repos</option>
                    <option value="absent" data-bg="linear-gradient(135deg, #ef4444, #dc2626)">‚ùå Absent</option>
                    <option value="cours" data-bg="linear-gradient(135deg, #f59e0b, #d97706)">üìö Cours</option>
                    <option value="conges" data-bg="linear-gradient(135deg, #10b981, #059669)">üèñÔ∏è Cong√©s</option>
                `;
                
                if (Array.isArray(globalState.customTemplates)) {
                    globalState.customTemplates.forEach(template => {
                        const option = document.createElement('option');
                        option.value = 'custom';
                        option.dataset.customText = template.text;
                        option.dataset.bg = template.color ? 
                            `linear-gradient(135deg, ${template.color}, ${adjustColor(template.color, -20)})` :
                            'linear-gradient(135deg, #8b5cf6, #7c3aed)';
                        option.textContent = `‚öôÔ∏è ${template.text}`;
                        caseTypeSelect.appendChild(option);
                    });
                }
            }
            
            const timeSlotSelect = document.getElementById('bulkTimeSlot');
            if (timeSlotSelect) {
                timeSlotSelect.innerHTML = '<option value="">Aucun cr√©neau sp√©cifique</option>';
                
                if (Array.isArray(globalState.timeSlots)) {
                    globalState.timeSlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.id;
                        option.dataset.slot = JSON.stringify(slot);
                        option.textContent = `${slot.name} (${slot.start} - ${slot.end})`;
                        timeSlotSelect.appendChild(option);
                    });
                }
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('bulkStartDate').value = today;
            document.getElementById('bulkEndDate').value = today;
            
            openModal('bulkFillModal');
        } catch (error) {
            console.error('Erreur ouverture bulk fill modal:', error);
            showToast('Erreur d\'ouverture du modal', 'error');
        }
    }

    function toggleAllDays() {
        try {
            const checkboxes = ['dayMon', 'dayTue', 'dayWed', 'dayThu', 'dayFri', 'daySat', 'daySun'];
            const firstChecked = document.getElementById('dayMon').checked;
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = !firstChecked;
                }
            });
        } catch (error) {
            console.error('Erreur toggle all days:', error);
        }
    }

    function handleBulkFillSubmit(e) {
        try {
            e.preventDefault();
            
            const employeeId = document.getElementById('bulkEmployeeSelect').value;
            const startDate = new Date(document.getElementById('bulkStartDate').value);
            const endDate = new Date(document.getElementById('bulkEndDate').value);
            const caseType = document.getElementById('bulkCaseType').value;
            const timeSlotId = document.getElementById('bulkTimeSlot').value;
            const replaceExisting = document.getElementById('replaceExisting').checked;
            
            if (!employeeId || !caseType || isNaN(startDate) || isNaN(endDate)) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showToast('La date de d√©but doit √™tre ant√©rieure √† la date de fin', 'error');
                return;
            }
            
            const selectedDays = [];
            ['dayMon', 'dayTue', 'dayWed', 'dayThu', 'dayFri', 'daySat', 'daySun'].forEach((id, index) => {
                if (document.getElementById(id).checked) {
                    selectedDays.push(index === 6 ? 0 : index + 1);
                }
            });
            
            if (selectedDays.length === 0) {
                showToast('S√©lectionnez au moins un jour de la semaine', 'error');
                return;
            }
            
            const caseTypeSelect = document.getElementById('bulkCaseType');
            const selectedOption = caseTypeSelect.options[caseTypeSelect.selectedIndex];
            const backgroundColor = selectedOption.dataset.bg;
            const customText = selectedOption.dataset.customText;
            
            let shiftData = {
                type: caseType,
                text: customText || selectedOption.textContent.trim(),
                backgroundColor: backgroundColor
            };
            
            if (timeSlotId) {
                const timeSlotSelect = document.getElementById('bulkTimeSlot');
                const slotOption = timeSlotSelect.options[timeSlotSelect.selectedIndex];
                const slotData = JSON.parse(slotOption.dataset.slot);
                
                const hours = calculateHours(slotData.start, slotData.end);
                shiftData = {
                    type: 'work',
                    text: `${slotData.start} - ${slotData.end}`,
                    hours: formatHours(hours),
                    slot: slotData
                };
            }
            
            let affectedDays = 0;
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                
                if (selectedDays.includes(dayOfWeek)) {
                    if (employeeId === 'ALL') {
                        globalState.employees.forEach(employee => {
                            affectedDays += applyShiftToEmployeeDay(employee, new Date(currentDate), shiftData, replaceExisting);
                        });
                    } else {
                        const employee = globalState.employees.find(emp => emp.id === employeeId);
                        if (employee) {
                            affectedDays += applyShiftToEmployeeDay(employee, new Date(currentDate), shiftData, replaceExisting);
                        }
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            if (affectedDays > 0) {
                renderPlanning();
                updateSummary();
                saveData();
                closeModal();
                showToast(`${affectedDays} case(s) ajout√©e(s) avec succ√®s`, 'success');
            } else {
                showToast('Aucune case n\'a √©t√© ajout√©e', 'error');
            }
            
        } catch (error) {
            console.error('Erreur bulk fill submit:', error);
            showToast('Erreur lors du remplissage automatique', 'error');
        }
    }

    function applyShiftToEmployeeDay(employee, date, shiftData, replaceExisting) {
        try {
            const weekStart = new Date(date);
            const dayOfWeek2 = date.getDay();
const diff2 = dayOfWeek2 === 0 ? -6 : 1 - dayOfWeek2;
weekStart.setDate(date.getDate() + diff2);
            
            const year = weekStart.getFullYear();
            const firstDay = new Date(year, 0, 1);
            const pastDays = (weekStart - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            const weekKey = `${year}-W${weekNumber}`;
            
            const dayIndex = date.getDay() === 0 ? 6 : date.getDay() - 1;
            
            if (!employee.planning) employee.planning = {};
            if (!employee.planning[weekKey]) employee.planning[weekKey] = {};
            if (!employee.planning[weekKey][dayIndex]) employee.planning[weekKey][dayIndex] = [];
            
            if (replaceExisting) {
                employee.planning[weekKey][dayIndex] = [];
            }
            
            const newShift = {
                id: generateId(),
                ...shiftData
            };
            
            employee.planning[weekKey][dayIndex].push(newShift);
            return 1;
            
        } catch (error) {
            console.error('Erreur apply shift to employee day:', error);
            return 0;
        }
    }

    function addEmployee() {
        saveStateForUndo();
        
        const name = document.getElementById('empName').value.trim();
        const role = document.getElementById('empRole').value.trim();
        const contractHours = parseFloat(document.getElementById('empContractHours').value) || 35;
        
        if (!name) {
            showToast('Le nom est requis', 'error');
            return;
        }
        
        if (!Array.isArray(globalState.employees)) {
            globalState.employees = [];
        }
        
        if (globalState.employees.find(emp => emp.name.toLowerCase() === name.toLowerCase())) {
            showToast('Un employ√© avec ce nom existe d√©j√†', 'error');
            return;
        }
        
        const newEmployee = {
            id: generateId(),
            name: name,
            role: role || 'Employ√©',
            contractHours: contractHours,
            planning: {}
        };
        
        globalState.employees.push(newEmployee);
        
        document.getElementById('empName').value = '';
        document.getElementById('empRole').value = '';
        document.getElementById('empContractHours').value = '35';
        
        renderPlanning();
        updateSummary();
        saveData();
        showToast('Employ√© ajout√© avec succ√®s', 'success');
    }

    function renderTimeSlots() {
        try {
            const container = document.getElementById('timeSlotsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!Array.isArray(globalState.timeSlots)) {
                globalState.timeSlots = [
                    { id: 'journeeA', name: 'Journ√©e A', start: '09:00', end: '18:30' },
                    { id: 'journeeB', name: 'Journ√©e B', start: '10:30', end: '19:30' },
                    { id: 'journeeC', name: 'Journ√©e C', start: '07:00', end: '15:00' }
                ];
            }
            
            globalState.timeSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = 'time-slot-template work';
                slotElement.draggable = true;
                slotElement.dataset.type = 'timeSlot';
                slotElement.dataset.slotId = slot.id;
                slotElement.innerHTML = `
                    ${slot.name}<br>
                    <small style="opacity: 0.9;">${slot.start}-${slot.end}</small>
                    <button class="delete-slot" onclick="removeTimeSlot('${slot.id}')" title="Supprimer">√ó</button>
                `;
                
                slotElement.addEventListener('dragstart', handleDragStart);
                slotElement.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(slotElement);
            });

            updateSidebarContent();
        } catch (error) {
            console.error('Erreur render time slots:', error);
        }
    }

    function addTimeSlot() {
        try {
            saveStateForUndo();
            
            const name = document.getElementById('slotName').value.trim();
            const start = document.getElementById('slotStart').value;
            const end = document.getElementById('slotEnd').value;
            
            if (!name || !start || !end) {
                showToast('Tous les champs sont requis', 'error');
                return;
            }
            
            if (!Array.isArray(globalState.timeSlots)) {
                globalState.timeSlots = [];
            }
            
            if (globalState.timeSlots.find(slot => slot.name.toLowerCase() === name.toLowerCase())) {
                showToast('Un cr√©neau avec ce nom existe d√©j√†', 'error');
                return;
            }
            
            const newSlot = {
                id: generateId(),
                name: name,
                start: start,
                end: end
            };
            
            globalState.timeSlots.push(newSlot);
            
            document.getElementById('slotName').value = '';
            document.getElementById('slotStart').value = '09:00';
            document.getElementById('slotEnd').value = '18:30';
            
            renderTimeSlots();
            saveData();
            showToast('Cr√©neau horaire cr√©√©', 'success');
        } catch (error) {
            console.error('Erreur add time slot:', error);
            showToast('Erreur lors de la cr√©ation du cr√©neau', 'error');
        }
    }

    function removeTimeSlot(slotId) {
        try {
            if (confirm('Supprimer ce cr√©neau horaire ?')) {
                saveStateForUndo();
                
                if (!Array.isArray(globalState.timeSlots)) {
                    globalState.timeSlots = [];
                    return;
                }
                
                globalState.timeSlots = globalState.timeSlots.filter(slot => slot.id !== slotId);
                renderTimeSlots();
                saveData();
                showToast('Cr√©neau supprim√©', 'success');
            }
        } catch (error) {
            console.error('Erreur remove time slot:', error);
            showToast('Erreur lors de la suppression', 'error');
        }
    }

    function addCustomTemplate() {
        try {
            const text = document.getElementById('customText').value.trim();
            const color = document.getElementById('customColor').value;
            
            if (!text) {
                showToast('Tapez un nom pour la case', 'error');
                return;
            }
            
            const existingTemplates = document.querySelectorAll('.template');
            for (let template of existingTemplates) {
                if (template.textContent.includes(text)) {
                    showToast('Ce nom existe d√©j√†', 'error');
                    return;
                }
            }
            
            const customTemplate = document.createElement('div');
            customTemplate.className = 'template custom';
            customTemplate.draggable = true;
            customTemplate.dataset.type = 'custom';
            customTemplate.style.background = `linear-gradient(135deg, ${color}, ${adjustColor(color, -20)})`;
            customTemplate.innerHTML = `
                ‚öôÔ∏è ${text}
                <button class="delete-template" onclick="removeTemplate(this)" title="Supprimer">√ó</button>
            `;
            
            customTemplate.addEventListener('dragstart', handleDragStart);
            customTemplate.addEventListener('dragend', handleDragEnd);
            
            document.getElementById('templatesContainer').appendChild(customTemplate);
            document.getElementById('customText').value = '';
            
            if (!Array.isArray(globalState.customTemplates)) {
                globalState.customTemplates = [];
            }
            
            globalState.customTemplates.push({
                id: generateId(),
                text: text,
                color: color
            });
            
            updateSidebarContent();
            saveData();
            showToast('Case cr√©√©e : ' + text, 'success');
        } catch (error) {
            console.error('Erreur add custom template:', error);
            showToast('Erreur lors de la cr√©ation de la case', 'error');
        }
    }

    function adjustColor(hex, percent) {
        const num = parseInt(hex.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    function removeTemplate(button) {
        try {
            const template = button.closest('.template');
            const type = template.dataset.type;
            const templateText = template.textContent.replace('√ó', '').trim();
            
            if (confirm(`Supprimer la case "${templateText}" ?`)) {
                if (type === 'custom') {
                    if (!Array.isArray(globalState.customTemplates)) {
                        globalState.customTemplates = [];
                    }
                    globalState.customTemplates = globalState.customTemplates.filter(t => 
                        !templateText.includes(t.text)
                    );
                }
                
                template.remove();
                updateSidebarContent();
                saveData();
                showToast('Case supprim√©e', 'success');
            }
        } catch (error) {
            console.error('Erreur remove template:', error);
            showToast('Erreur lors de la suppression', 'error');
        }
    }

    function handleDragStart(e) {
        try {
            if (!globalState.isAdminMode) return;
            
            const type = e.target.dataset.type;
            
            if (type === 'timeSlot') {
                const slotId = e.target.dataset.slotId;
                const slot = globalState.timeSlots.find(s => s.id === slotId);
                if (slot) {
                    globalState.draggedItem = {
                        type: 'timeSlot',
                        text: `${slot.name} (${slot.start}-${slot.end})`,
                        slot: slot
                    };
                }
            } else {
                const computedStyle = window.getComputedStyle(e.target);
                const backgroundColor = computedStyle.background || computedStyle.backgroundColor;
                
                globalState.draggedItem = {
                    type: e.target.dataset.type,
                    text: e.target.textContent.replace('√ó', '').trim(),
                    backgroundColor: backgroundColor
                };
            }
            
            e.target.classList.add('dragging');
        } catch (error) {
            console.error('Erreur drag start:', error);
        }
    }

    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
    }

    function generateId() {
        return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getWeekKey() {
        try {
            const year = globalState.currentWeek.getFullYear();
            const firstDay = new Date(year, 0, 1);
            const pastDays = (globalState.currentWeek - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            return `${year}-W${weekNumber}`;
        } catch (error) {
            console.error('Erreur get week key:', error);
            return '2024-W1';
        }
    }

    function updateWeekDisplay() {
        try {
            const start = new Date(globalState.currentWeek);
            const end = new Date(globalState.currentWeek);
            end.setDate(end.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const startStr = start.toLocaleDateString('fr-FR', options);
            const endStr = end.toLocaleDateString('fr-FR', options);
            const year = end.getFullYear();
            
            const weekDisplay = document.getElementById('weekDisplay');
            if (weekDisplay) {
                weekDisplay.textContent = `${startStr} - ${endStr} ${year}`;
            }
        } catch (error) {
            console.error('Erreur update week display:', error);
        }
    }

    function changeWeek(direction) {
        try {
            globalState.currentWeek.setDate(globalState.currentWeek.getDate() + (direction * 7));
            updateWeekDisplay();
            renderPlanning();
            updateSummary(); // ‚Üê IMPORTANT : Met √† jour le r√©capitulatif
            saveData();
        } catch (error) {
            console.error('Erreur change week:', error);
        }
    }

    function renderPlanning() {
    try {
        const grid = document.getElementById('planningGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        
        const cornerHeader = document.createElement('div');
        cornerHeader.className = 'grid-header';
        cornerHeader.textContent = 'üë§ Employ√©s';
        grid.appendChild(cornerHeader);
        
        const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        days.forEach((day, index) => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'grid-header';
            const date = new Date(globalState.currentWeek);
            date.setDate(date.getDate() + index);
            
            // V√©rifier si c'est un jour f√©ri√©
            const jourFerie = isJourFerie(date);
            let ferieLabel = '';
            
            if (jourFerie) {
                dayHeader.style.backgroundColor = 'rgba(156, 163, 175, 0.3)';
                ferieLabel = `<br><small style="color: #8b5cf6; font-size: 9px;">üéå ${jourFerie.nom}</small>`;
            }
            
            // Fond gris pour le dimanche
            if (date.getDay() === 0) {
                dayHeader.style.backgroundColor = 'rgba(156, 163, 175, 0.4)';
            }
            
            dayHeader.innerHTML = `${day}<br><small>${date.getDate()}</small>${ferieLabel}`;
            grid.appendChild(dayHeader);
        });
        
        // üî• CORRECTION : Utiliser getActiveEmployees() au lieu de globalState.employees
        const activeEmployees = getActiveEmployees();
        
        if (activeEmployees.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.style.cssText = `
                grid-column: 1 / -1;
                text-align: center;
                padding: 40px;
                color: #6b7280;
                background: rgba(255, 255, 255, 0.8);
                border-radius: 12px;
                margin: 10px;
            `;
            emptyMessage.innerHTML = `
                <h3 style="margin-bottom: 10px;">Aucun employ√© actif</h3>
                <p>Passez en mode administrateur pour commencer √† cr√©er votre planning</p>
            `;
            grid.appendChild(emptyMessage);
            return;
        }
        
        // üî• CORRECTION : Boucler sur activeEmployees au lieu de globalState.employees
        activeEmployees.forEach(employee => {
            // Plus besoin de if (employee.archived) return; 
            // car activeEmployees ne contient d√©j√† que les employ√©s non archiv√©s
            
            const empCell = document.createElement('div');
            empCell.className = 'employee-cell';
            
            makeEmployeeDraggable(empCell, employee.id);
            
            let weekHours = 0;
            let workDays = 0;
            let retardMins = 0;
            const weekKey = getWeekKey();
            
            if (employee.planning && employee.planning[weekKey]) {
                Object.values(employee.planning[weekKey]).forEach(dayShifts => {
                    let hasWork = false;
                    dayShifts.forEach(shift => {
                        // Compter les heures de travail
                        if (shift.type === 'work' && shift.hours) {
                            const hours = parseHours(shift.hours);
                            weekHours += hours;
                            hasWork = true;
                        }
                        // Compter les heures de Cours, Cong√©s et F√©ri√©
                        if (['cours', 'conges', 'ferie'].includes(shift.type) && shift.hours) {
                            const hours = parseHours(shift.hours);
                            weekHours += hours;
                            hasWork = true;
                        }
                        // Soustraire les retards
                        if (shift.type === 'retard') {
                            // Essayer plusieurs sources pour la valeur du retard
                            let mins = 0;
                            if (shift.retardMinutes !== undefined && shift.retardMinutes !== null) {
                                mins = parseInt(shift.retardMinutes) || 0;
                            }
                            if (mins > 0) {
                                console.log(`‚è∞ Retard d√©tect√© pour ${employee.name}: ${mins} minutes (raw: ${shift.retardMinutes}, type: ${typeof shift.retardMinutes})`);
                            }
                            retardMins += mins;
                        }
                    });
                    if (hasWork) workDays++;
                });
            }
            
            const contractHours = employee.contractHours || 35;
            const retardHours = retardMins / 60;
            const effectiveWeekHours = weekHours - retardHours;
            const weekDiff = effectiveWeekHours - contractHours;
            
            // Calcul du solde mensuel (mois courant uniquement)
            const currentDate = new Date(globalState.currentWeek);
            const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
            
            // Couleur du solde semaine
            let weekSoldeColor = '#10b981'; // vert
            if (weekDiff > 0) weekSoldeColor = '#ef4444'; // rouge heures sup
            else if (weekDiff < 0) weekSoldeColor = '#f59e0b'; // orange d√©ficit
            
            // Couleur du solde mois
            let monthSoldeColor = '#10b981'; // vert
            if (monthSolde.solde > 0) monthSoldeColor = '#ef4444'; // rouge heures sup
            else if (monthSolde.solde < 0) monthSoldeColor = '#f59e0b'; // orange d√©ficit
            
            const weekSoldeText = weekDiff >= 0 ? `+${formatHours(weekDiff)}` : `${formatHours(weekDiff)}`;
            const monthSoldeText = monthSolde.solde >= 0 ? `+${formatHours(monthSolde.solde)}` : `${formatHours(monthSolde.solde)}`;
            
            empCell.innerHTML = `
                <div class="employee-name" style="font-size: 14px;">
                    ${globalState.isAdminMode ? '‚¨ç‚¨ç ' : ''}${employee.name}
                </div>
                <div class="employee-role" style="font-size: 12px;">${employee.role}</div>
                <div class="employee-hours" style="font-size: 14px; font-weight: 700;">${formatHours(contractHours)} | ${workDays} jours | <span style="color: #667eea;">${formatHours(effectiveWeekHours)}</span></div>
                <div style="font-size: 12px; color: ${weekSoldeColor}; font-weight: 700; margin-top: 2px;">üìÖ Sem: ${weekSoldeText}</div>
                <div style="font-size: 12px; color: ${monthSoldeColor}; font-weight: 700; margin-top: 1px;">üìä Mois: ${monthSoldeText}</div>
                ${globalState.isAdminMode ? `
                    <button class="remove-emp" onclick="removeEmployee('${employee.id}')" title="Supprimer">√ó</button>
                    <button class="edit-emp" onclick="openEditEmployeeModal('${employee.id}')" title="Modifier contrat" style="position: absolute; top: 5px; left: 5px; background: #8b5cf6; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">‚úèÔ∏è</button>
                    <button class="copy-week-btn" onclick="copyEmployeeWeek('${employee.id}')" title="Copier semaine">üìã</button>
                    <button class="paste-week-btn" onclick="pasteEmployeeWeek('${employee.id}')" title="Coller semaine" style="opacity: ${globalState.copiedWeek ? '1' : '0.3'};">üì•</button>
                    <button class="debug-btn" onclick="debugEmployeeWeek('${employee.id}')" title="Voir d√©tails" style="position: absolute; bottom: 5px; left: 5px; background: #f59e0b; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer;">üîç</button>
                ` : ''}
            `;
            
            if (globalState.isAdminMode) {
                empCell.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (globalState.copiedWeek) {
                        pasteEmployeeWeek(employee.id);
                    }
                });
            }
            
            grid.appendChild(empCell);
            
            for (let day = 0; day < 7; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.dataset.employeeId = employee.id;
                dayCell.dataset.day = day;
                
                // V√©rifier si c'est un jour f√©ri√© pour appliquer le fond gris
                const dayDate = new Date(globalState.currentWeek);
                dayDate.setDate(dayDate.getDate() + day);
                const jourFerie = isJourFerie(dayDate);
                
                if (jourFerie) {
                    dayCell.style.backgroundColor = 'rgba(156, 163, 175, 0.15)';
                }
                
                // Fond gris plus fonc√© pour le dimanche
                if (dayDate.getDay() === 0) {
                    dayCell.style.backgroundColor = 'rgba(156, 163, 175, 0.25)';
                }
                
                if (globalState.isAdminMode) {
                    dayCell.addEventListener('dragover', handleDragOver);
                    dayCell.addEventListener('dragleave', handleDragLeave);
                    dayCell.addEventListener('drop', handleDrop);
                }
                
                const weekKey = getWeekKey();
                if (employee.planning && employee.planning[weekKey] && employee.planning[weekKey][day]) {
                    employee.planning[weekKey][day].forEach(shift => {
                        const shiftCard = createShiftCard(shift, employee.id, day);
                        dayCell.appendChild(shiftCard);
                    });
                }
                
                grid.appendChild(dayCell);
            }
        });
        
    } catch (error) {
        console.error('Erreur render planning:', error);
        const grid = document.getElementById('planningGrid');
        if (grid) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #374151;"><h3>Erreur de chargement du planning</h3></div>';
        }
    }
}

    function createShiftCard(shift, employeeId, day) {
        try {
            const card = document.createElement('div');
            card.className = `shift-card ${shift.type}`;
            card.dataset.shiftId = shift.id;
            card.dataset.employeeId = employeeId;
            card.dataset.day = day;
            
            if (globalState.isAdminMode) {
                card.draggable = true;
                card.addEventListener('dragstart', handleShiftDragStart);
                card.addEventListener('dragend', handleShiftDragEnd);
            }
            
            if (shift.backgroundColor) {
                card.style.background = shift.backgroundColor;
            }
            
            let content = '';
            if (shift.type === 'work') {
                content = `
                    <div style="font-weight: 800; font-size: 16px;">${shift.text}</div>
                    ${shift.hours ? `<div style="font-size: 14px; opacity: 0.9;">${shift.hours}</div>` : ''}
                `;
            } else {
                content = shift.text;
            }
            
            card.innerHTML = `
                ${content}
                ${globalState.isAdminMode ? `
                    <div class="actions">
                        ${shift.type === 'work' ? `<button class="action-btn edit" onclick="editShiftTime('${employeeId}', ${day}, '${shift.id}')" title="Modifier horaires">‚úèÔ∏è</button>` : ''}
                        <button class="action-btn copy" onclick="copyShift('${employeeId}', ${day}, '${shift.id}')" title="Copier">üìã</button>
                        <button class="action-btn delete" onclick="removeShift('${employeeId}', ${day}, '${shift.id}')" title="Supprimer">√ó</button>
                    </div>
                ` : ''}
            `;
            
            if (globalState.isAdminMode) {
                card.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (globalState.copiedShift) {
                        pasteShift(employeeId, day, e.target.closest('.day-cell'));
                    }
                });
            }
            
            return card;
        } catch (error) {
            console.error('Erreur create shift card:', error);
            const card = document.createElement('div');
            card.className = 'shift-card';
            card.textContent = 'Erreur';
            return card;
        }
    }

    function handleDrop(e) {
        try {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            saveStateForUndo();
            
            const employeeId = e.currentTarget.dataset.employeeId;
            const day = parseInt(e.currentTarget.dataset.day);
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (!employee.planning) employee.planning = {};
            const weekKey = getWeekKey();
            if (!employee.planning[weekKey]) employee.planning[weekKey] = {};
            if (!employee.planning[weekKey][day]) employee.planning[weekKey][day] = [];
            
            let newShift;
            
            if (draggedShiftData) {
                newShift = {
                    id: generateId(),
                    type: draggedShiftData.shift.type,
                    text: draggedShiftData.shift.text,
                    hours: draggedShiftData.shift.hours,
                    slot: draggedShiftData.shift.slot,
                    backgroundColor: draggedShiftData.shift.backgroundColor,
                    retardMinutes: draggedShiftData.shift.retardMinutes,
                    motif: draggedShiftData.shift.motif
                };
                
                const originalEmployee = globalState.employees.find(emp => emp.id === draggedShiftData.originalEmployeeId);
                if (originalEmployee && originalEmployee.planning[weekKey] && originalEmployee.planning[weekKey][draggedShiftData.originalDay]) {
                    originalEmployee.planning[weekKey][draggedShiftData.originalDay] = 
                        originalEmployee.planning[weekKey][draggedShiftData.originalDay].filter(s => s.id !== draggedShiftData.originalShiftId);
                    
                    if (originalEmployee.planning[weekKey][draggedShiftData.originalDay].length === 0) {
                        delete originalEmployee.planning[weekKey][draggedShiftData.originalDay];
                    }
                }
                
                draggedShiftData = null;
                showToast('Case d√©plac√©e', 'success');
                
            } else if (globalState.draggedItem) {
                // Si c'est un retard, ouvrir la modale de saisie
                if (globalState.draggedItem.type === 'retard') {
                    openRetardModal(employeeId, day);
                    globalState.draggedItem = null;
                    return;
                }
                
                // Si c'est Cours, Cong√©s, F√©ri√© ou Absent, ouvrir la modale de saisie des heures
                if (['cours', 'conges', 'ferie', 'absent'].includes(globalState.draggedItem.type)) {
                    openHeuresAbsenceModal(employeeId, day, globalState.draggedItem.type);
                    globalState.draggedItem = null;
                    return;
                }
                
                if (globalState.draggedItem.type === 'timeSlot') {
                    const slot = globalState.draggedItem.slot;
                    const hours = calculateHours(slot.start, slot.end);
                    newShift = {
                        id: generateId(),
                        type: 'work',
                        text: `${slot.start} - ${slot.end}`,
                        hours: formatHours(hours),
                        slot: slot
                    };
                } else {
                    newShift = {
                        id: generateId(),
                        type: globalState.draggedItem.type,
                        text: globalState.draggedItem.text,
                        backgroundColor: globalState.draggedItem.backgroundColor
                    };
                }
                
                globalState.draggedItem = null;
                showToast('Cr√©neau ajout√©', 'success');
            } else {
                return;
            }
            
            employee.planning[weekKey][day].push(newShift);
            
            renderPlanning();
            updateSummary();
            saveData();
            
        } catch (error) {
            console.error('Erreur handle drop:', error);
            showToast('Erreur lors de l\'ajout', 'error');
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function copyShift(employeeId, day, shiftId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            if (employee.planning && employee.planning[weekKey] && employee.planning[weekKey][day]) {
                const shift = employee.planning[weekKey][day].find(s => s.id === shiftId);
                if (shift) {
                    globalState.copiedShift = {
                        type: shift.type,
                        text: shift.text,
                        hours: shift.hours,
                        slot: shift.slot,
                        backgroundColor: shift.backgroundColor
                    };
                    showToast('Case copi√©e - Clic droit pour coller', 'success');
                }
            }
        } catch (error) {
            console.error('Erreur copy shift:', error);
        }
    }

    function pasteShift(employeeId, day, dayCell) {
        try {
            if (!globalState.copiedShift) return;
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (!employee.planning) employee.planning = {};
            const weekKey = getWeekKey();
            if (!employee.planning[weekKey]) employee.planning[weekKey] = {};
            if (!employee.planning[weekKey][day]) employee.planning[weekKey][day] = [];
            
            const newShift = {
                id: generateId(),
                type: globalState.copiedShift.type,
                text: globalState.copiedShift.text,
                hours: globalState.copiedShift.hours,
                slot: globalState.copiedShift.slot,
                backgroundColor: globalState.copiedShift.backgroundColor
            };
            
            employee.planning[weekKey][day].push(newShift);
            
            const shiftCard = createShiftCard(newShift, employeeId, day);
            dayCell.appendChild(shiftCard);
            
            updateSummary();
            saveData();
            showToast('Case coll√©e', 'success');
        } catch (error) {
            console.error('Erreur paste shift:', error);
        }
    }

    function removeShift(employeeId, day, shiftId) {
        try {
            saveStateForUndo();
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            if (employee.planning && employee.planning[weekKey] && employee.planning[weekKey][day]) {
                employee.planning[weekKey][day] = employee.planning[weekKey][day].filter(shift => shift.id !== shiftId);
                
                if (employee.planning[weekKey][day].length === 0) {
                    delete employee.planning[weekKey][day];
                }
            }
            
            renderPlanning();
            updateSummary();
            saveData();
            showToast('Cr√©neau supprim√©', 'success');
        } catch (error) {
            console.error('Erreur remove shift:', error);
        }
    }

    function calculateHours(startTime, endTime) {
        try {
            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);
            
            const startDecimal = startHour + (startMin / 60);
            const endDecimal = endHour + (endMin / 60);
            
            let hours = endDecimal - startDecimal;
            if (hours < 0) hours += 24;
            
            if (hours > 6) hours -= 1;
            
            return Math.max(0, hours);
        } catch (error) {
            console.error('Erreur calculate hours:', error);
            return 8;
        }
    }

    function parseHours(hoursString) {
        if (!hoursString) return 0;
        if (typeof hoursString === 'number') return hoursString;
        if (typeof hoursString !== 'string') return 0;
        
        // Format "6h30" ou "8h" ou "7h15"
        const hourMinuteMatch = hoursString.match(/(\d+)h(\d+)/i);
        if (hourMinuteMatch) {
            const hours = parseInt(hourMinuteMatch[1]);
            const minutes = parseInt(hourMinuteMatch[2]);
            return hours + (minutes / 60);
        }
        
        // Format "8h"
        const hourMatch = hoursString.match(/(\d+)h/i);
        if (hourMatch) {
            return parseInt(hourMatch[1]);
        }
        
        // Format d√©cimal "6.5" ou "6,5"
        const cleanString = hoursString.replace(/[^\d.,]/g, '');
        const normalizedString = cleanString.replace(',', '.');
        const hours = parseFloat(normalizedString);
        
        return isNaN(hours) ? 0 : hours;
    }

    function formatHours(hours) {
        if (hours === 0) return '0h';
        
        // G√©rer les nombres n√©gatifs correctement
        const isNegative = hours < 0;
        const absHours = Math.abs(hours);
        
        const wholeHours = Math.floor(absHours);
        const minutes = Math.round((absHours - wholeHours) * 60);
        
        let result;
        if (minutes === 0) {
            result = `${wholeHours}h`;
        } else if (minutes === 30) {
            result = `${wholeHours}h30`;
        } else {
            result = `${wholeHours}h${minutes.toString().padStart(2, '0')}`;
        }
        
        return isNegative ? `-${result}` : result;
    }

    function debugEmployeeWeek(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            const planning = employee.planning?.[weekKey] || {};
            
            let totalHours = 0;
            let totalRetardMinutes = 0;
            let details = `üìä DEBUG ${employee.name} - Semaine ${weekKey}\n`;
            details += `üìã Contrat: ${employee.contractHours}h\n\n`;
            
            const jours = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            
            for (let day = 0; day < 7; day++) {
                const shifts = planning[day] || [];
                let dayHours = 0;
                let dayRetardMins = 0;
                let dayDetails = [];
                
                shifts.forEach(shift => {
                    if (shift.type === 'work' && shift.hours) {
                        const hours = parseHours(shift.hours);
                        dayHours += hours;
                        dayDetails.push(`üíº ${shift.text} = ${shift.hours} (${hours}h)`);
                    }
                    if (['cours', 'conges', 'ferie'].includes(shift.type)) {
                        if (shift.hours) {
                            const hours = parseHours(shift.hours);
                            dayHours += hours;
                            const icon = shift.type === 'cours' ? 'üìö' : shift.type === 'conges' ? 'üèñÔ∏è' : 'üéå';
                            dayDetails.push(`${icon} ${shift.text || shift.type} = ${shift.hours} (${hours}h)`);
                        } else {
                            const icon = shift.type === 'cours' ? 'üìö' : shift.type === 'conges' ? 'üèñÔ∏è' : 'üéå';
                            dayDetails.push(`${icon} ${shift.text || shift.type} = ‚ö†Ô∏è PAS D'HEURES D√âFINIES!`);
                        }
                    }
                    if (shift.type === 'retard' && shift.retardMinutes) {
                        const retardMinsValue = parseInt(shift.retardMinutes) || 0;
                        dayRetardMins += retardMinsValue;
                        const h = Math.floor(retardMinsValue / 60);
                        const m = retardMinsValue % 60;
                        const retardStr = h > 0 ? `${h}h${m > 0 ? m : ''}` : `${m}min`;
                        dayDetails.push(`‚è∞ Retard: -${retardStr}`);
                    }
                    if (shift.type === 'repos') {
                        dayDetails.push(`üò¥ Repos`);
                    }
                });
                
                if (dayDetails.length > 0) {
                    details += `${jours[day]}: ${dayDetails.join(', ')} ‚Üí ${dayHours}h${dayRetardMins > 0 ? ` (-${dayRetardMins}min retard)` : ''}\n`;
                    totalHours += dayHours;
                    totalRetardMinutes += dayRetardMins;
                } else {
                    details += `${jours[day]}: (vide)\n`;
                }
            }
            
            const totalRetardHours = totalRetardMinutes / 60;
            const effectiveHours = totalHours - totalRetardHours;
            const diff = effectiveHours - employee.contractHours;
            
            details += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            details += `TOTAL BRUT: ${formatHours(totalHours)}\n`;
            if (totalRetardMinutes > 0) {
                details += `RETARDS: -${formatHours(totalRetardHours)}\n`;
                details += `TOTAL EFFECTIF: ${formatHours(effectiveHours)}\n`;
            }
            details += `Contrat: ${employee.contractHours}h\n`;
            details += `Diff: ${diff >= 0 ? '+' : ''}${formatHours(diff)}`;
            
            alert(details);
            console.log(details);
            console.log('Planning brut:', planning);
            
        } catch (error) {
            console.error('Erreur debug:', error);
        }
    }

    function copyEmployeeWeek(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            if (employee.planning && employee.planning[weekKey]) {
                globalState.copiedWeek = JSON.parse(JSON.stringify(employee.planning[weekKey]));
                showToast(`Semaine de ${employee.name} copi√©e`, 'success');
            } else {
                showToast('Aucun planning √† copier', 'error');
            }
        } catch (error) {
            console.error('Erreur copy employee week:', error);
        }
    }

    function pasteEmployeeWeek(targetEmployeeId) {
        try {
            if (!globalState.copiedWeek) {
                showToast('Aucune semaine copi√©e', 'error');
                return;
            }
            
            const employee = globalState.employees.find(emp => emp.id === targetEmployeeId);
            if (!employee) return;
            
            if (confirm(`Coller la semaine sur ${employee.name} ?`)) {
                if (!employee.planning) employee.planning = {};
                const weekKey = getWeekKey();
                
                employee.planning[weekKey] = {};
                Object.keys(globalState.copiedWeek).forEach(day => {
                    employee.planning[weekKey][day] = globalState.copiedWeek[day].map(shift => ({
                        ...shift,
                        id: generateId()
                    }));
                });
                
                renderPlanning();
                updateSummary();
                saveData();
                showToast(`Semaine coll√©e sur ${employee.name}`, 'success');
            }
        } catch (error) {
            console.error('Erreur paste employee week:', error);
        }
    }

    function removeEmployee(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <h2 style="margin-bottom: 20px; color: #374151;">Retirer ${employee.name} du planning ?</h2>
                    <p style="margin-bottom: 20px; color: #6b7280; line-height: 1.6;">
                        Choisissez une action :
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn admin" onclick="archiveEmployee('${employeeId}')" style="padding: 15px; font-size: 15px;">
                            üì¶ Archiver (recommand√©)
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px; font-weight: normal;">
                                Conserve tout l'historique, masque du planning actuel
                            </div>
                        </button>
                        <button class="btn danger" onclick="confirmDeleteEmployee('${employeeId}')" style="padding: 15px; font-size: 15px;">
                            üóëÔ∏è Supprimer d√©finitivement
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px; font-weight: normal;">
                                Efface tout l'historique de mani√®re irr√©versible
                            </div>
                        </button>
                        <button class="btn" onclick="closeModal()" style="padding: 12px;">
                            Annuler
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });
            
        } catch (error) {
            console.error('Erreur remove employee:', error);
        }
    }

    function archiveEmployee(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            saveStateForUndo();
            
            employee.archived = true;
            employee.archivedDate = new Date().toISOString();
            
            closeModal();
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`${employee.name} archiv√© (historique conserv√©)`, 'success');
            
        } catch (error) {
            console.error('Erreur archive employee:', error);
            showToast('Erreur lors de l\'archivage', 'error');
        }
    }

    function confirmDeleteEmployee(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (confirm(`‚ö†Ô∏è CONFIRMER LA SUPPRESSION D√âFINITIVE ?\n\n${employee.name} et tout son historique seront perdus.\n\nCette action est IRR√âVERSIBLE.`)) {
                saveStateForUndo();
                
                globalState.employees = globalState.employees.filter(emp => emp.id !== employeeId);
                
                closeModal();
                renderPlanning();
                updateSummary();
                saveData();
                
                showToast('Employ√© supprim√© d√©finitivement', 'success');
            }
            
        } catch (error) {
            console.error('Erreur delete employee:', error);
            showToast('Erreur lors de la suppression', 'error');
        }
    }

    // ============================================
    // NOUVELLE FONCTION : R√âCAPITULATIF AM√âLIOR√â
    // ============================================
    function updateSummary() {
        try {
            const empCount = globalState.employees?.filter(emp => !emp.archived).length || 0;
let totalShifts = 0;
let totalHours = 0;
            const weekKey = getWeekKey();
            const activeEmployees = getActiveEmployees();
            activeEmployees.forEach(employee => {
                if (employee.planning && employee.planning[weekKey]) {
                    Object.values(employee.planning[weekKey]).forEach(dayShifts => {
                        totalShifts += dayShifts.length;
                        dayShifts.forEach(shift => {
                            if (shift.type === 'work' && shift.hours) {
                                const hours = parseHours(shift.hours);
                                totalHours += hours;
                            }
                        });
                    });
                }
            });
            
            const occupationRate = empCount > 0 ? Math.round((totalShifts / (empCount * 7)) * 100) : 0;
            
            document.getElementById('empCount').textContent = empCount;
            document.getElementById('shiftCount').textContent = totalShifts;
            document.getElementById('occupationRate').textContent = occupationRate + '%';
            
            // ‚Üê APPEL DU R√âCAPITULATIF (TOUJOURS VISIBLE)
            updateEmployeeRecap();
        } catch (error) {
            console.error('Erreur update summary:', error);
            document.getElementById('empCount').textContent = '0';
            document.getElementById('shiftCount').textContent = '0';
            document.getElementById('occupationRate').textContent = '0%';
        }
    }

    // ============================================
    // FONCTION R√âCAPITULATIF CORRIG√âE (TOUJOURS VISIBLE)
    // ============================================
    function updateEmployeeRecap() {
        try {
            const container = document.getElementById('employeeRecap');
            if (!container) return;
            
            container.innerHTML = '';
            
            const activeEmployees = getActiveEmployees();
            if (activeEmployees.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 18px; margin-bottom: 10px;">Aucun employ√© dans le planning</p>
                        <p style="font-size: 14px;">Les statistiques appara√Ætront ici une fois que vous aurez ajout√© des employ√©s.</p>
                    </div>
                `;
                return;
            }
            
            // Calculer selon la p√©riode s√©lectionn√©e
            if (globalState.recapPeriod === 'week') {
                generateWeekRecap(container, activeEmployees);
            } else {
                generateMonthRecap(container, activeEmployees);
            }
            
        } catch (error) {
            console.error('Erreur update employee recap:', error);
        }
    }

    // ============================================
    // R√âCAPITULATIF HEBDOMADAIRE
    // ============================================
    function generateWeekRecap(container, employees) {
        const weekKey = getWeekKey();
        const currentDate = new Date(globalState.currentWeek);
        
        employees.forEach(employee => {
            let workHours = 0;  // Heures conventionnelles (hors dimanches)
            let workDays = 0;
            let absences = 0;
            let conges = 0;
            let repos = 0;
            let cours = 0;
            let retardMinutes = 0;
            let dimanchesCount = 0;
            let dimanchesHours = 0;
            let feriesCount = 0;
            let feriesHours = 0;
            
            const contractHours = employee.contractHours || 35;
            const heuresBaseJourFerie = contractHours >= 39 ? 8 : 7;
            
            if (employee.planning && employee.planning[weekKey]) {
                Object.keys(employee.planning[weekKey]).forEach(dayIndex => {
                    const dayShifts = employee.planning[weekKey][dayIndex];
                    let hasWork = false;
                    
                    // Calculer la date du jour
                    const shiftDate = new Date(currentDate);
                    shiftDate.setDate(shiftDate.getDate() + parseInt(dayIndex));
                    const isDim = isDimanche(shiftDate);
                    const ferie = isJourFerie(shiftDate);
                    
                    dayShifts.forEach(shift => {
                        switch(shift.type) {
                            case 'work':
                                if (shift.hours) {
                                    const hours = parseHours(shift.hours);
                                    hasWork = true;
                                    
                                    if (isDim) {
                                        // Dimanche = heures √† part (pas dans conventionnelles)
                                        dimanchesCount++;
                                        dimanchesHours += hours;
                                    } else if (ferie) {
                                        // F√©ri√© travaill√© = base conventionnelle + heures √† majorer
                                        workHours += heuresBaseJourFerie;
                                        feriesCount++;
                                        feriesHours += hours;
                                    } else {
                                        workHours += hours;
                                    }
                                }
                                break;
                            case 'retard':
                                if (shift.retardMinutes) {
                                    retardMinutes += parseInt(shift.retardMinutes) || 0;
                                }
                                break;
                            case 'absent':
                                absences++;
                                break;
                            case 'conges':
                                conges++;
                                if (shift.hours) {
                                    workHours += parseHours(shift.hours);
                                    hasWork = true;
                                }
                                break;
                            case 'repos':
                                repos++;
                                break;
                            case 'cours':
                                cours++;
                                if (shift.hours) {
                                    workHours += parseHours(shift.hours);
                                    hasWork = true;
                                }
                                break;
                            case 'ferie':
                                // Case F√©ri√© = jour f√©ri√© NON travaill√© (pay√©)
                                if (shift.hours) {
                                    workHours += parseHours(shift.hours);
                                    hasWork = true;
                                }
                                break;
                        }
                    });
                    if (hasWork) workDays++;
                });
            }
            
            const retardHours = retardMinutes / 60;
            const effectiveHours = workHours - retardHours;
            const diff = effectiveHours - contractHours;
            const overtime = Math.max(0, diff);
            const deficit = Math.max(0, -diff);
            
            // Calcul du solde mensuel
            const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
            
            const recapCard = document.createElement('div');
            recapCard.style.cssText = `
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
            `;
            
            // D√©terminer la couleur selon le statut
            let statusColor = '#10b981'; // Vert par d√©faut
            if (overtime > 0) {
                statusColor = '#ef4444'; // Rouge pour heures sup
            } else if (deficit > 0) {
                statusColor = '#f59e0b'; // Orange pour d√©ficit
            }
            
            // Couleur du solde mensuel
            let soldeColor = '#10b981';
            if (monthSolde.solde > 0) soldeColor = '#ef4444';
            else if (monthSolde.solde < 0) soldeColor = '#f59e0b';
            
            const diffText = diff >= 0 ? `+${formatHours(diff)}` : `-${formatHours(Math.abs(diff))}`;
            const soldeText = monthSolde.solde >= 0 ? `+${formatHours(monthSolde.solde)}` : `-${formatHours(Math.abs(monthSolde.solde))}`;
            
            recapCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #374151; font-size: 1.2em; font-weight: 700;">${employee.name}</h4>
                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">üìã ${contractHours}h</span>
                </div>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <span style="background: ${statusColor}15; color: ${statusColor}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">Sem: ${diffText}</span>
                    <span style="background: ${soldeColor}15; color: ${soldeColor}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">üìä Mois: ${soldeText} (${monthSolde.completeWeeks || 0} sem)</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">‚è∞ Heures travail:</span>
                        <span style="font-weight: 700; color: #667eea;">${formatHours(workHours)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: ${retardHours > 0 ? 'rgba(249, 115, 22, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-radius: 8px;">
                        <span style="font-weight: 600;">‚è∞ Retards:</span>
                        <span style="font-weight: 700; color: ${retardHours > 0 ? '#f97316' : '#6b7280'};">${retardHours > 0 ? '-' : ''}${formatHours(retardHours)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: ${overtime > 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-radius: 8px;">
                        <span style="font-weight: 600;">‚ö° Heures sup:</span>
                        <span style="font-weight: 700; color: ${overtime > 0 ? '#ef4444' : '#6b7280'};">${formatHours(overtime)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(107, 114, 128, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üìÖ Jours travail:</span>
                        <span style="font-weight: 700; color: #6b7280;">${workDays}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üèñÔ∏è Cong√©s:</span>
                        <span style="font-weight: 700; color: #10b981;">${conges}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">‚ùå Absences:</span>
                        <span style="font-weight: 700; color: #ef4444;">${absences}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üò¥ Repos:</span>
                        <span style="font-weight: 700; color: #6b7280;">${repos}</span>
                    </div>
                    ${(dimanchesCount > 0 || feriesCount > 0) ? `
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üéå Dim/F√©ri√©s:</span>
                        <span style="font-weight: 700; color: #8b5cf6;">${dimanchesCount > 0 ? dimanchesCount + 'D(' + formatHours(dimanchesHours) + ')' : ''}${dimanchesCount > 0 && feriesCount > 0 ? '/' : ''}${feriesCount > 0 ? feriesCount + 'F(' + formatHours(feriesHours) + ')' : ''}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(recapCard);
        });
    }

    // ============================================
    // R√âCAPITULATIF MENSUEL (m√™me format que semaine)
    // ============================================
    function generateMonthRecap(container, employees) {
        const currentDate = new Date(globalState.currentWeek);
        const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const monthName = currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        
        // Calculer le nombre de semaines COMPL√àTES dans le mois (lundi-dimanche)
        // Trouver le premier lundi du mois
        let firstMonday = new Date(firstDayOfMonth);
        while (firstMonday.getDay() !== 1) {
            firstMonday.setDate(firstMonday.getDate() + 1);
        }
        // Trouver le dernier dimanche du mois
        let lastSunday = new Date(lastDayOfMonth);
        while (lastSunday.getDay() !== 0) {
            lastSunday.setDate(lastSunday.getDate() - 1);
        }
        // Nombre de semaines compl√®tes
        const completeWeeks = Math.max(0, Math.floor((lastSunday - firstMonday) / (7 * 24 * 60 * 60 * 1000)) + 1);
        
        employees.forEach(employee => {
            let workHours = 0;  // Heures conventionnelles (hors dimanches)
            let workDays = 0;
            let absences = 0;
            let conges = 0;
            let repos = 0;
            let cours = 0;
            let retardMinutes = 0;
            let dimanchesCount = 0;
            let dimanchesHours = 0;
            let feriesCount = 0;
            let feriesHours = 0;
            
            const contractHours = employee.contractHours || 35;
            const heuresBaseJourFerie = contractHours >= 39 ? 8 : 7;

            // Parcourir toutes les semaines du mois
            let currentWeekStart = new Date(firstDayOfMonth);
            const dayOfWeek3 = currentWeekStart.getDay();
            const diff3 = dayOfWeek3 === 0 ? -6 : 1 - dayOfWeek3;
            currentWeekStart.setDate(currentWeekStart.getDate() + diff3);

            while (currentWeekStart <= lastDayOfMonth) {
                const year = currentWeekStart.getFullYear();
                const firstDay = new Date(year, 0, 1);
                const pastDays = (currentWeekStart - firstDay) / 86400000;
                const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
                const weekKey = `${year}-W${weekNumber}`;
                
                if (employee.planning && employee.planning[weekKey]) {
                    Object.keys(employee.planning[weekKey]).forEach(dayIndex => {
                        const dayShifts = employee.planning[weekKey][dayIndex];
                        
                        const shiftDate = new Date(currentWeekStart);
                        shiftDate.setDate(shiftDate.getDate() + parseInt(dayIndex));
                        
                        // IMPORTANT: Ne compter que les jours dans les semaines COMPL√àTES
                        // (entre le premier lundi et le dernier dimanche du mois)
                        if (shiftDate >= firstMonday && shiftDate <= lastSunday && shiftDate.getMonth() === currentDate.getMonth()) {
                            let hasWork = false;
                            const isDim = isDimanche(shiftDate);
                            const ferie = isJourFerie(shiftDate);
                            
                            dayShifts.forEach(shift => {
                                switch(shift.type) {
                                    case 'work':
                                        if (shift.hours) {
                                            const hours = parseHours(shift.hours);
                                            hasWork = true;
                                            
                                            if (isDim) {
                                                // Dimanche = heures √† part (pas dans conventionnelles)
                                                dimanchesCount++;
                                                dimanchesHours += hours;
                                            } else if (ferie) {
                                                // F√©ri√© travaill√© = base conventionnelle + heures √† majorer
                                                workHours += heuresBaseJourFerie;
                                                feriesCount++;
                                                feriesHours += hours;
                                            } else {
                                                workHours += hours;
                                            }
                                        }
                                        break;
                                    case 'retard':
                                        if (shift.retardMinutes) {
                                            retardMinutes += parseInt(shift.retardMinutes) || 0;
                                        }
                                        break;
                                    case 'absent':
                                        absences++;
                                        break;
                                    case 'conges':
                                        conges++;
                                        if (shift.hours) {
                                            workHours += parseHours(shift.hours);
                                            hasWork = true;
                                        }
                                        break;
                                    case 'repos':
                                        repos++;
                                        break;
                                    case 'cours':
                                        cours++;
                                        if (shift.hours) {
                                            workHours += parseHours(shift.hours);
                                            hasWork = true;
                                        }
                                        break;
                                    case 'ferie':
                                        // Case F√©ri√© = jour f√©ri√© NON travaill√© (pay√©)
                                        if (shift.hours) {
                                            workHours += parseHours(shift.hours);
                                            hasWork = true;
                                        }
                                        break;
                                }
                            });
                            if (hasWork) workDays++;
                        }
                    });
                }
                
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            }
            
            const retardHours = retardMinutes / 60;
            
            // Calculer les heures attendues = semaines COMPL√àTES √ó contrat
            const expectedHours = completeWeeks * contractHours;
            
            const effectiveHours = workHours - retardHours;
            const diff = effectiveHours - expectedHours;
            const overtime = Math.max(0, diff);
            const deficit = Math.max(0, -diff);
            
            // D√©terminer la couleur selon le statut
            let statusColor = '#10b981';
            if (overtime > 0) {
                statusColor = '#ef4444';
            } else if (deficit > 0) {
                statusColor = '#f59e0b';
            }
            
            const diffText = diff >= 0 ? `+${formatHours(diff)}` : `-${formatHours(Math.abs(diff))}`;
            
            const recapCard = document.createElement('div');
            recapCard.style.cssText = `
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
            `;
            
            recapCard.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <h4 style="color: #374151; font-size: 1.2em; font-weight: 700;">${employee.name}</h4>
                    <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;">üìã ${contractHours}h</span>
                </div>
                <p style="color: #6b7280; font-size: 12px; margin-bottom: 10px; text-transform: capitalize;">${monthName}</p>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <span style="background: ${statusColor}15; color: ${statusColor}; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">Solde: ${diffText}</span>
                    <span style="background: rgba(107, 114, 128, 0.15); color: #6b7280; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;">${completeWeeks} sem √ó ${contractHours}h = ${formatHours(expectedHours)}</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">‚è∞ Heures travail:</span>
                        <span style="font-weight: 700; color: #667eea;">${formatHours(workHours)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: ${retardHours > 0 ? 'rgba(249, 115, 22, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-radius: 8px;">
                        <span style="font-weight: 600;">‚è∞ Retards:</span>
                        <span style="font-weight: 700; color: ${retardHours > 0 ? '#f97316' : '#6b7280'};">${retardHours > 0 ? '-' : ''}${formatHours(retardHours)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: ${overtime > 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-radius: 8px;">
                        <span style="font-weight: 600;">‚ö° Heures sup:</span>
                        <span style="font-weight: 700; color: ${overtime > 0 ? '#ef4444' : '#6b7280'};">${formatHours(overtime)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(107, 114, 128, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üìÖ Jours travail:</span>
                        <span style="font-weight: 700; color: #6b7280;">${workDays}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üèñÔ∏è Cong√©s:</span>
                        <span style="font-weight: 700; color: #10b981;">${conges}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">‚ùå Absences:</span>
                        <span style="font-weight: 700; color: #ef4444;">${absences}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üò¥ Repos:</span>
                        <span style="font-weight: 700; color: #6b7280;">${repos}</span>
                    </div>
                    ${(dimanchesCount > 0 || feriesCount > 0) ? `
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                        <span style="font-weight: 600;">üéå Dim/F√©ri√©s:</span>
                        <span style="font-weight: 700; color: #8b5cf6;">${dimanchesCount > 0 ? dimanchesCount + 'D(' + formatHours(dimanchesHours) + ')' : ''}${dimanchesCount > 0 && feriesCount > 0 ? '/' : ''}${feriesCount > 0 ? feriesCount + 'F(' + formatHours(feriesHours) + ')' : ''}</span>
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(recapCard);
        });
    }

    // ============================================
    // FONCTION POUR CHANGER DE P√âRIODE (SEMAINE/MOIS)
    // ============================================
    function switchRecapPeriod(period) {
        try {
            globalState.recapPeriod = period;
            
            // Mettre √† jour les boutons
            const weekBtn = document.getElementById('weekRecapBtn');
            const monthBtn = document.getElementById('monthRecapBtn');
            
            if (weekBtn && monthBtn) {
                weekBtn.classList.remove('active');
                monthBtn.classList.remove('active');
                
                if (period === 'week') {
                    weekBtn.classList.add('active');
                } else {
                    monthBtn.classList.add('active');
                }
            }
            
            // Mettre √† jour le r√©capitulatif
            updateEmployeeRecap();
            
        } catch (error) {
            console.error('Erreur switch recap period:', error);
        }
    }

    function updateWeekTemplateSelect() {
        try {
            const select = document.getElementById('weekTemplateSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">S√©lectionner une semaine type...</option>';
            
            if (!Array.isArray(globalState.weekTemplates)) {
                globalState.weekTemplates = [];
                return;
            }
            
            globalState.weekTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                
                const date = new Date(template.createdAt).toLocaleDateString('fr-FR', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                option.textContent = `${template.name} (cr√©√© le ${date})`;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Erreur update week template select:', error);
        }
    }

    function saveData() {
        if (isFirebaseEnabled && currentUser) {
            saveToCloudSilent();
        } else {
            console.warn('‚ö†Ô∏è Firebase non disponible - Modifications non sauvegard√©es');
        }
    }

    function saveToCloudSilent() {
    if (!isFirebaseEnabled || !currentUser || !db) return;

    try {
        const cleanData = (obj) => {
            if (Array.isArray(obj)) {
                return obj.map(item => cleanData(item)).filter(item => item !== undefined);
            }
            if (obj && typeof obj === 'object') {
                const cleaned = {};
                Object.keys(obj).forEach(key => {
                    const value = cleanData(obj[key]);
                    if (value !== undefined) {
                        cleaned[key] = value;
                    }
                });
                return cleaned;
            }
            return obj;
        };

        const dataToSave = {
            employees: cleanData(globalState.employees || []),
            customTemplates: cleanData(globalState.customTemplates || []),
            timeSlots: cleanData(globalState.timeSlots || []),
            weekTemplates: cleanData(globalState.weekTemplates || []), // üî• CORRECTION : Ajouter weekTemplates
            currentWeek: globalState.currentWeek.toISOString(), // üî• AJOUT : Sauvegarder la semaine courante
            lastSave: new Date().toISOString(),
            version: '3.1',
            userId: currentUser.uid
        };

        db.collection('plannings').doc('main').set(dataToSave) // üî• CORRECTION : Utiliser 'main' au lieu de currentUser.uid
            .then(() => {
                console.log('‚úÖ Auto-sauvegarde cloud r√©ussie');
            })
            .catch((error) => {
                console.error('‚ùå Erreur auto-sauvegarde cloud:', error);
            });
            
    } catch (error) {
        console.error('‚ùå Erreur auto-sauvegarde:', error);
    }
}

    function loadData() {
        try {
            if (isFirebaseEnabled && currentUser) {
                console.log('‚è≥ Chargement depuis Firebase...');
                loadFromCloud();
                return;
            }
            
            console.warn('‚ö†Ô∏è Firebase non disponible - Impossible de charger les donn√©es');
            showToast('‚ö†Ô∏è Connexion Firebase requise', 'error');
            createDefaultData();
            
        } catch (error) {
            console.error('Erreur chargement:', error);
            createDefaultData();
        }
    }

    function createDefaultData() {
        try {
            globalState = {
                employees: [],
                currentWeek: (() => {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    today.setDate(today.getDate() + diff);
    return today;
})(),
                isAdminMode: false,
                draggedItem: null,
                customTemplates: [],
                timeSlots: [
                    { id: 'journeeA', name: 'Journ√©e A', start: '09:00', end: '18:30' },
                    { id: 'journeeB', name: 'Journ√©e B', start: '10:30', end: '19:30' },
                    { id: 'journeeC', name: 'Journ√©e C', start: '07:00', end: '15:00' }
                ],
                weekTemplates: [],
                copiedShift: null,
                copiedWeek: null,
                recapPeriod: 'week'
            };
            
            saveData();
            renderPlanning();
            updateSummary();
            
            showToast('Planning initialis√© - Passez en mode admin pour ajouter des employ√©s', 'success');
        } catch (error) {
            console.error('Erreur create default data:', error);
        }
    }

    function shareOpening() {
        try {
            const currentUrl = window.location.href;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(currentUrl).then(() => {
                    showToast('Lien copi√© dans le presse-papier !', 'success');
                }).catch(() => {
                    showShareFallback(currentUrl);
                });
            } else {
                showShareFallback(currentUrl);
            }
        } catch (error) {
            console.error('Erreur partage:', error);
            showToast('Erreur lors du partage', 'error');
        }
    }

    function showShareFallback(url) {
        alert(`Copiez ce lien pour partager le planning :\n\n${url}`);
    }

    function exportToJSON() {
        try {
            const dataToExport = {
                employees: globalState.employees || [],
                customTemplates: globalState.customTemplates || [],
                timeSlots: globalState.timeSlots || [],
                weekTemplates: globalState.weekTemplates || [],
                exportDate: new Date().toISOString(),
                version: '3.1'
            };
            
            const dataString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `planning_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Sauvegarde JSON t√©l√©charg√©e', 'success');
        } catch (error) {
            console.error('Erreur export JSON:', error);
            showToast('Erreur lors de l\'export', 'error');
        }
    }
    
    function importFromJSON() {
        try {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!importedData.employees && !importedData.version) {
                            showToast('Ce fichier ne semble pas √™tre une sauvegarde de planning', 'error');
                            return;
                        }
                        
                        const exportDate = importedData.exportDate ? 
                            new Date(importedData.exportDate).toLocaleDateString('fr-FR') : 
                            'Date inconnue';
                        
                        if (confirm(`Importer cette sauvegarde du ${exportDate} ?\n\n‚ö†Ô∏è Cela remplacera TOUTES les donn√©es actuelles.\n\nVoulez-vous continuer ?`)) {
                            saveStateForUndo();
                            
                            if (Array.isArray(importedData.employees)) {
                                globalState.employees = importedData.employees;
                            }
                            
                            if (Array.isArray(importedData.customTemplates)) {
                                globalState.customTemplates = importedData.customTemplates;
                            }
                            
                            if (Array.isArray(importedData.timeSlots)) {
                                globalState.timeSlots = importedData.timeSlots;
                            }
                            
                            if (Array.isArray(importedData.weekTemplates)) {
                                globalState.weekTemplates = importedData.weekTemplates;
                            }
                            
                            renderPlanning();
                            renderTimeSlots();
                            loadCustomTemplates();
                            updateSummary();
                            updateWeekTemplateSelect();
                            saveData();
                            
                            const employeesCount = importedData.employees?.length || 0;
                            showToast(`‚úÖ Sauvegarde import√©e avec succ√®s ! (${employeesCount} employ√©s)`, 'success');
                        }
                    } catch (parseError) {
                        console.error('Erreur parsing JSON:', parseError);
                        showToast('‚ùå Fichier JSON invalide ou corrompu', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('‚ùå Erreur de lecture du fichier', 'error');
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
            
        } catch (error) {
            console.error('Erreur import JSON:', error);
            showToast('‚ùå Erreur lors de l\'import', 'error');
        }
    }

    function clearCurrentWeek() { 
        const weekKey = getWeekKey();
        const weekStart = new Date(globalState.currentWeek);
        const weekEnd = new Date(globalState.currentWeek);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        const weekDisplay = `${weekStart.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}`;
        
        if (confirm(`Vider uniquement la semaine du ${weekDisplay} ?`)) {
            saveStateForUndo();
            
            if (Array.isArray(globalState.employees)) {
                globalState.employees.forEach(emp => {
                    if (emp.planning && emp.planning[weekKey]) {
                        delete emp.planning[weekKey];
                    }
                });
            }
            renderPlanning();
            updateSummary();
            saveData();
            showToast(`Semaine du ${weekDisplay} vid√©e`, 'success');
        }
    }

    function saveStateForUndo() {
        try {
            const currentState = {
                employees: JSON.parse(JSON.stringify(globalState.employees || [])),
                customTemplates: JSON.parse(JSON.stringify(globalState.customTemplates || [])),
                timeSlots: JSON.parse(JSON.stringify(globalState.timeSlots || [])),
                timestamp: Date.now()
            };
            
            undoStack.push(currentState);
            
            if (undoStack.length > MAX_UNDO_STEPS) {
                undoStack.shift();
            }
            
            redoStack = [];
            
            updateUndoRedoButtons();
            
        } catch (error) {
            console.error('Erreur save state for undo:', error);
        }
    }

    function undo() {
        try {
            if (undoStack.length === 0) {
                showToast('Rien √† annuler', 'error');
                return;
            }
            
            const currentState = {
                employees: JSON.parse(JSON.stringify(globalState.employees || [])),
                customTemplates: JSON.parse(JSON.stringify(globalState.customTemplates || [])),
                timeSlots: JSON.parse(JSON.stringify(globalState.timeSlots || []))
            };
            redoStack.push(currentState);
            
            const previousState = undoStack.pop();
            globalState.employees = previousState.employees;
            globalState.customTemplates = previousState.customTemplates;
            globalState.timeSlots = previousState.timeSlots;
            
            renderPlanning();
            renderTimeSlots();
            loadCustomTemplates();
            updateSummary();
            updateUndoRedoButtons();
            saveData();
            
            showToast('Action annul√©e', 'success');
            
        } catch (error) {
            console.error('Erreur undo:', error);
            showToast('Erreur lors de l\'annulation', 'error');
        }
    }

    function redo() {
        try {
            if (redoStack.length === 0) {
                showToast('Rien √† refaire', 'error');
                return;
            }
            
            const currentState = {
                employees: JSON.parse(JSON.stringify(globalState.employees || [])),
                customTemplates: JSON.parse(JSON.stringify(globalState.customTemplates || [])),
                timeSlots: JSON.parse(JSON.stringify(globalState.timeSlots || []))
            };
            undoStack.push(currentState);
            
            const nextState = redoStack.pop();
            globalState.employees = nextState.employees;
            globalState.customTemplates = nextState.customTemplates;
            globalState.timeSlots = nextState.timeSlots;
            
            renderPlanning();
            renderTimeSlots();
            loadCustomTemplates();
            updateSummary();
            updateUndoRedoButtons();
            saveData();
            
            showToast('Action refaite', 'success');
            
        } catch (error) {
            console.error('Erreur redo:', error);
            showToast('Erreur lors du refaire', 'error');
        }
    }

    function updateUndoRedoButtons() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        
        if (undoBtn) {
            undoBtn.disabled = undoStack.length === 0;
            undoBtn.style.opacity = undoStack.length === 0 ? '0.5' : '1';
            undoBtn.textContent = `‚Ü∂ Annuler ${undoStack.length > 0 ? `(${undoStack.length})` : ''}`;
        }
        
        if (redoBtn) {
            redoBtn.disabled = redoStack.length === 0;
            redoBtn.style.opacity = redoStack.length === 0 ? '0.5' : '1';
            redoBtn.textContent = `‚Ü∑ Refaire ${redoStack.length > 0 ? `(${redoStack.length})` : ''}`;
        }
    }

    function showToast(message, type = 'success') {
        try {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        } catch (error) {
            console.error('Erreur show toast:', error);
        }
    }

    function showCloudSyncInfo(lastSaveDate) {
        try {
            let cloudInfo = document.getElementById('cloudSyncInfo');
            
            if (!cloudInfo) {
                cloudInfo = document.createElement('div');
                cloudInfo.id = 'cloudSyncInfo';
                cloudInfo.className = 'cloud-sync-info';
                document.body.appendChild(cloudInfo);
            }
            
            if (lastSaveDate) {
                const date = new Date(lastSaveDate);
                const formattedDate = date.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short'
                });
                const formattedTime = date.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                cloudInfo.innerHTML = `
                    <span class="icon">‚òÅÔ∏è</span>
                    Derni√®re synchro: ${formattedDate} √† ${formattedTime}
                `;
                
                cloudInfo.classList.add('show');
                
                setTimeout(() => {
                    cloudInfo.classList.remove('show');
                }, 5000);
            }
        } catch (error) {
            console.error('Erreur affichage info cloud:', error);
        }
    }

    function saveWeekTemplate() {
        try {
            const templateName = prompt('Nom de la semaine type (ex: Semaine Normale, Vacances √©t√©...) :');
            
            if (!templateName || !templateName.trim()) {
                showToast('Nom requis', 'error');
                return;
            }
            
            const weekKey = getWeekKey();
            let hasData = false;
            
            if (Array.isArray(globalState.employees)) {
                globalState.employees.forEach(employee => {
                    if (employee.planning && employee.planning[weekKey]) {
                        hasData = true;
                    }
                });
            }
            
            if (!hasData) {
                showToast('Aucun planning cette semaine √† sauvegarder', 'error');
                return;
            }
            
            if (!Array.isArray(globalState.weekTemplates)) {
                globalState.weekTemplates = [];
            }
            
            const existingIndex = globalState.weekTemplates.findIndex(t => t.name === templateName.trim());
            
            if (existingIndex !== -1) {
                if (!confirm(`Une semaine type "${templateName}" existe d√©j√†. Voulez-vous la remplacer ?`)) {
                    return;
                }
                globalState.weekTemplates.splice(existingIndex, 1);
            }
            
            const weekTemplate = {
                id: generateId(),
                name: templateName.trim(),
                data: {},
                createdAt: new Date().toISOString()
            };
            
            globalState.employees.forEach(employee => {
                if (employee.planning && employee.planning[weekKey]) {
                    weekTemplate.data[employee.id] = {
                        employeeName: employee.name,
                        employeeRole: employee.role,
                        planning: JSON.parse(JSON.stringify(employee.planning[weekKey]))
                    };
                }
            });
            
            globalState.weekTemplates.push(weekTemplate);
            updateWeekTemplateSelect();
            saveData();
            
            showToast(`Semaine type "${templateName}" sauvegard√©e`, 'success');
            
        } catch (error) {
            console.error('Erreur save week template:', error);
            showToast('Erreur lors de la sauvegarde', 'error');
        }
    }

    function applyWeekTemplate() {
        try {
            const select = document.getElementById('weekTemplateSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                showToast('S√©lectionnez une semaine type', 'error');
                return;
            }
            
            const template = globalState.weekTemplates.find(t => t.id === selectedId);
            if (!template) {
                showToast('Semaine type introuvable', 'error');
                return;
            }
            
            if (!confirm(`Appliquer la semaine type "${template.name}" ?\n\n‚ö†Ô∏è Cela remplacera le planning de la semaine courante.`)) {
                return;
            }
            
            saveStateForUndo();
            
            const weekKey = getWeekKey();
            let appliedCount = 0;
            
            globalState.employees.forEach(emp => {
                if (emp.planning && emp.planning[weekKey]) {
                    delete emp.planning[weekKey];
                }
            });
            
            Object.keys(template.data).forEach(templateEmployeeId => {
                const templateData = template.data[templateEmployeeId];
                
                const currentEmployee = globalState.employees.find(emp => 
                    emp.name === templateData.employeeName
                );
                
                if (currentEmployee) {
                    if (!currentEmployee.planning) currentEmployee.planning = {};
                    
                    currentEmployee.planning[weekKey] = {};
                    Object.keys(templateData.planning).forEach(day => {
                        currentEmployee.planning[weekKey][day] = templateData.planning[day].map(shift => ({
                            ...shift,
                            id: generateId()
                        }));
                    });
                    
                    appliedCount++;
                }
            });
            
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`Semaine type "${template.name}" appliqu√©e √† ${appliedCount} employ√©(s)`, 'success');
            
        } catch (error) {
            console.error('Erreur apply week template:', error);
            showToast('Erreur lors de l\'application', 'error');
        }
    }

    function deleteWeekTemplate() {
        try {
            const select = document.getElementById('weekTemplateSelect');
            const selectedId = select.value;
            
            if (!selectedId) {
                showToast('S√©lectionnez une semaine type', 'error');
                return;
            }
            
            const template = globalState.weekTemplates.find(t => t.id === selectedId);
            if (!template) {
                showToast('Semaine type introuvable', 'error');
                return;
            }
            
            if (!confirm(`Supprimer la semaine type "${template.name}" ?\n\nCette action est irr√©versible.`)) {
                return;
            }
            
            globalState.weekTemplates = globalState.weekTemplates.filter(t => t.id !== selectedId);
            updateWeekTemplateSelect();
            saveData();
            
            showToast(`Semaine type "${template.name}" supprim√©e`, 'success');
            
        } catch (error) {
            console.error('Erreur delete week template:', error);
            showToast('Erreur lors de la suppression', 'error');
        }
    }

    function editShiftTime(employeeId, day, shiftId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            if (!employee.planning?.[weekKey]?.[day]) return;
            
            const shift = employee.planning[weekKey][day].find(s => s.id === shiftId);
            if (!shift) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px;">
                    <h3 style="margin-bottom: 20px; text-align: center; color: #374151;">
                        ‚úèÔ∏è Modifier les horaires
                    </h3>
                    <div class="form-group">
                        <label>Heure de d√©but :</label>
                        <input type="time" id="editStartTime" value="${extractStartTime(shift.text)}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <div class="form-group">
                        <label>Heure de fin :</label>
                        <input type="time" id="editEndTime" value="${extractEndTime(shift.text)}" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeEditModal()">Annuler</button>
                        <button type="button" class="btn admin" onclick="saveEditedTime('${employeeId}', ${day}, '${shiftId}')">Sauver</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeEditModal();
            });
            
        } catch (error) {
            console.error('Erreur edit shift time:', error);
            showToast('Erreur lors de l\'√©dition', 'error');
        }
    }

    function extractStartTime(timeText) {
        const match = timeText.match(/(\d{2}:\d{2})/);
        return match ? match[1] : '09:00';
    }

    function extractEndTime(timeText) {
        const matches = timeText.match(/(\d{2}:\d{2})/g);
        return matches && matches.length > 1 ? matches[1] : '18:00';
    }

    function saveEditedTime(employeeId, day, shiftId) {
        try {
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            
            if (!startTime || !endTime) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            const weekKey = getWeekKey();
            const shift = employee.planning[weekKey][day].find(s => s.id === shiftId);
            if (!shift) return;
            
            const hours = calculateHours(startTime, endTime);
            
            shift.text = `${startTime} - ${endTime}`;
            shift.hours = formatHours(hours);
            
            renderPlanning();
            updateSummary();
            saveData();
            closeEditModal();
            
            showToast('Horaires modifi√©s avec succ√®s', 'success');
            
        } catch (error) {
            console.error('Erreur save edited time:', error);
            showToast('Erreur lors de la sauvegarde', 'error');
        }
    }

    function closeEditModal() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.innerHTML.includes('Modifier les horaires')) {
                modal.remove();
            }
        });
    }

    function handleShiftDragStart(e) {
        if (!globalState.isAdminMode) return;
        
        const card = e.target;
        const employeeId = card.dataset.employeeId;
        const day = parseInt(card.dataset.day);
        const shiftId = card.dataset.shiftId;
        
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        const weekKey = getWeekKey();
        const shift = employee.planning[weekKey][day].find(s => s.id === shiftId);
        if (!shift) return;
        
        draggedShiftData = {
            shift: { ...shift },
            originalEmployeeId: employeeId,
            originalDay: day,
            originalShiftId: shiftId
        };
        
        card.classList.add('dragging');
        card.style.opacity = '0.5';
    }

    function handleShiftDragEnd(e) {
        e.target.classList.remove('dragging');
        e.target.style.opacity = '1';
    }

    function makeEmployeeDraggable(employeeCell, employeeId) {
        if (!globalState.isAdminMode) return;
        
        employeeCell.classList.add('draggable-employee');
        employeeCell.draggable = true;
        
        employeeCell.addEventListener('dragstart', (e) => handleEmployeeDragStart(e, employeeId));
        employeeCell.addEventListener('dragend', handleEmployeeDragEnd);
    }

    function handleEmployeeDragStart(e, employeeId) {
        if (!globalState.isAdminMode) return;
        
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        draggedEmployeeData = {
            employeeId: employeeId,
            employee: { ...employee },
            originalIndex: globalState.employees.findIndex(emp => emp.id === employeeId)
        };
        
        e.currentTarget.classList.add('dragging-employee');
        setupEmployeeDropZones();
        showToast(`D√©placement de ${employee.name}...`, 'success');
    }

    function handleEmployeeDragEnd(e) {
        e.currentTarget.classList.remove('dragging-employee');
        cleanupEmployeeDropZones();
        draggedEmployeeData = null;
    }

    function setupEmployeeDropZones() {
        const grid = document.getElementById('planningGrid');
        if (!grid) return;
        
        cleanupEmployeeDropZones();
        
        const employeeCells = grid.querySelectorAll('.employee-cell');
        
        employeeCells.forEach((empCell, index) => {
            const dropZone = document.createElement('div');
            dropZone.className = 'employee-drop-zone';
            dropZone.dataset.insertIndex = index;
            dropZone.style.cssText = `
                grid-column: 1 / -1;
                height: 20px;
                background: rgba(102, 126, 234, 0.05);
                border: 2px dashed transparent;
                transition: all 0.3s ease;
                cursor: copy;
                margin: 1px 0;
            `;
            
            dropZone.addEventListener('dragover', handleEmployeeDragOver);
            dropZone.addEventListener('dragleave', handleEmployeeDragLeave);
            dropZone.addEventListener('drop', (e) => handleEmployeeDrop(e, index));
            
            grid.insertBefore(dropZone, empCell);
        });
        
        const finalDropZone = document.createElement('div');
        finalDropZone.className = 'employee-drop-zone';
        finalDropZone.dataset.insertIndex = employeeCells.length;
        finalDropZone.style.cssText = `
            grid-column: 1 / -1;
            height: 20px;
            background: rgba(102, 126, 234, 0.05);
            border: 2px dashed transparent;
            transition: all 0.3s ease;
            cursor: copy;
            margin: 1px 0;
        `;
        
        finalDropZone.addEventListener('dragover', handleEmployeeDragOver);
        finalDropZone.addEventListener('dragleave', handleEmployeeDragLeave);
        finalDropZone.addEventListener('drop', (e) => handleEmployeeDrop(e, employeeCells.length));
        
        grid.appendChild(finalDropZone);
    }

    function cleanupEmployeeDropZones() {
        const dropZones = document.querySelectorAll('.employee-drop-zone');
        dropZones.forEach(zone => zone.remove());
    }

    function handleEmployeeDragOver(e) {
        e.preventDefault();
        e.currentTarget.style.border = '2px dashed #667eea';
        e.currentTarget.style.background = 'rgba(102, 126, 234, 0.1)';
    }

    function handleEmployeeDragLeave(e) {
        e.currentTarget.style.border = '2px dashed transparent';
        e.currentTarget.style.background = 'transparent';
    }

    function handleEmployeeDrop(e, insertIndex) {
        e.preventDefault();
        e.currentTarget.style.border = '2px dashed transparent';
        e.currentTarget.style.background = 'transparent';
        
        if (!draggedEmployeeData) return;
        
        try {
            const { employeeId, originalIndex } = draggedEmployeeData;
            
            if (insertIndex === originalIndex || insertIndex === originalIndex + 1) {
                showToast('Position inchang√©e', 'error');
                return;
            }
            
            const employee = globalState.employees.splice(originalIndex, 1)[0];
            let newIndex = insertIndex;
            
            if (insertIndex > originalIndex) {
                newIndex = insertIndex - 1;
            }
            
            globalState.employees.splice(newIndex, 0, employee);
            
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`${employee.name} d√©plac√© √† la position ${newIndex + 1}`, 'success');
            
        } catch (error) {
            console.error('Erreur d√©placement employ√©:', error);
            showToast('Erreur lors du d√©placement', 'error');
        }
    }

    function openArchivesModal() {
        try {
            const modal = document.getElementById('archivesModal');
            const archivesList = document.getElementById('archivesList');
            
            if (!modal || !archivesList) return;
            
            archivesList.innerHTML = '';
            
            const archivedEmployees = globalState.employees.filter(emp => emp.archived);
            
            if (archivedEmployees.length === 0) {
                archivesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p style="font-size: 18px; margin-bottom: 10px;">Aucun employ√© archiv√©</p>
                        <p style="font-size: 14px;">Les employ√©s archiv√©s appara√Ætront ici.</p>
                    </div>
                `;
            } else {
                archivedEmployees.forEach(employee => {
                    const archivedDate = new Date(employee.archivedDate).toLocaleDateString('fr-FR', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    let weekCount = 0;
                    if (employee.planning) {
                        weekCount = Object.keys(employee.planning).length;
                    }
                    
                    const archiveCard = document.createElement('div');
                    archiveCard.style.cssText = `
                        background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(75, 85, 99, 0.05));
                        padding: 20px;
                        border-radius: 12px;
                        border: 1px solid rgba(107, 114, 128, 0.2);
                    `;
                    
                    archiveCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #374151; font-size: 18px; margin-bottom: 5px;">${employee.name}</h4>
                                <p style="color: #6b7280; font-size: 14px;">${employee.role}</p>
                                <p style="color: #6b7280; font-size: 12px; margin-top: 5px;">Archiv√© le ${archivedDate}</p>
                                <p style="color: #8b5cf6; font-size: 12px; font-weight: 600; margin-top: 5px;">üìä ${weekCount} semaine(s) d'historique</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn admin" onclick="restoreEmployee('${employee.id}')" style="padding: 8px 16px; font-size: 13px;">
                                    ‚Ü©Ô∏è Restaurer
                                </button>
                                <button class="btn danger" onclick="deleteArchivedEmployee('${employee.id}')" style="padding: 8px 16px; font-size: 13px;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                    
                    archivesList.appendChild(archiveCard);
                });
            }
            
            modal.style.display = 'block';
            
        } catch (error) {
            console.error('Erreur open archives modal:', error);
            showToast('Erreur d\'ouverture des archives', 'error');
        }
    }

    function restoreEmployee(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (confirm(`Restaurer ${employee.name} dans le planning actif ?`)) {
                saveStateForUndo();
                
                delete employee.archived;
                delete employee.archivedDate;
                
                closeModal();
                renderPlanning();
                updateSummary();
                saveData();
                
                showToast(`${employee.name} restaur√© dans le planning`, 'success');
            }
            
        } catch (error) {
            console.error('Erreur restore employee:', error);
            showToast('Erreur lors de la restauration', 'error');
        }
    }

    function deleteArchivedEmployee(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) return;
            
            if (confirm(`‚ö†Ô∏è Supprimer d√©finitivement ${employee.name} ?\n\nTout l'historique (${Object.keys(employee.planning || {}).length} semaines) sera perdu.`)) {
                saveStateForUndo();
                
                globalState.employees = globalState.employees.filter(emp => emp.id !== employeeId);
                
                openArchivesModal();
                
                saveData();
                showToast(`${employee.name} supprim√© d√©finitivement`, 'success');
            }
            
        } catch (error) {
            console.error('Erreur delete archived employee:', error);
            showToast('Erreur lors de la suppression', 'error');
        }
    }  // <- Cette accolade ferme le try-catch

    // ============================================
    // FONCTIONS D'√âDITION EMPLOY√â
    // ============================================
    function openEditEmployeeModal(employeeId) {
        try {
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showToast('Employ√© non trouv√©', 'error');
                return;
            }
            
            document.getElementById('editEmpId').value = employee.id;
            document.getElementById('editEmpName').value = employee.name;
            document.getElementById('editEmpRole').value = employee.role || '';
            document.getElementById('editEmpContractHours').value = employee.contractHours || 35;
            
            document.getElementById('editEmployeeModal').style.display = 'block';
            
        } catch (error) {
            console.error('Erreur ouverture modale √©dition:', error);
            showToast('Erreur lors de l\'ouverture', 'error');
        }
    }
    
    function saveEditedEmployee(event) {
        event.preventDefault();
        
        try {
            saveStateForUndo();
            
            const employeeId = document.getElementById('editEmpId').value;
            const newName = document.getElementById('editEmpName').value.trim();
            const newRole = document.getElementById('editEmpRole').value.trim();
            const newContractHours = parseFloat(document.getElementById('editEmpContractHours').value) || 35;
            
            if (!newName) {
                showToast('Le nom est requis', 'error');
                return;
            }
            
            // V√©rifier si le nom existe d√©j√† (autre employ√©)
            const existingEmployee = globalState.employees.find(
                emp => emp.id !== employeeId && emp.name.toLowerCase() === newName.toLowerCase()
            );
            if (existingEmployee) {
                showToast('Un autre employ√© avec ce nom existe d√©j√†', 'error');
                return;
            }
            
            // Trouver et mettre √† jour l'employ√©
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showToast('Employ√© non trouv√©', 'error');
                return;
            }
            
            employee.name = newName;
            employee.role = newRole || 'Employ√©';
            employee.contractHours = newContractHours;
            
            closeModal();
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`${newName} modifi√© avec succ√®s (Contrat: ${newContractHours}h)`, 'success');
            
        } catch (error) {
            console.error('Erreur sauvegarde employ√©:', error);
            showToast('Erreur lors de la sauvegarde', 'error');
        }
    }

    // ============================================
    // JOURS F√âRI√âS FRAN√áAIS
    // ============================================
    function getJoursFeries(year) {
        const feries = [];
        
        // F√™tes fixes
        feries.push({ date: new Date(year, 0, 1), nom: "Jour de l'An" });
        feries.push({ date: new Date(year, 4, 1), nom: "F√™te du Travail" });
        feries.push({ date: new Date(year, 4, 8), nom: "Victoire 1945" });
        feries.push({ date: new Date(year, 6, 14), nom: "F√™te Nationale" });
        feries.push({ date: new Date(year, 7, 15), nom: "Assomption" });
        feries.push({ date: new Date(year, 10, 1), nom: "Toussaint" });
        feries.push({ date: new Date(year, 10, 11), nom: "Armistice" });
        feries.push({ date: new Date(year, 11, 25), nom: "No√´l" });
        
        // Calcul de P√¢ques (algorithme de Meeus/Jones/Butcher)
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
        const day = ((h + l - 7 * m + 114) % 31) + 1;
        
        const paques = new Date(year, month, day);
        
        // Lundi de P√¢ques (P√¢ques + 1)
        const lundiPaques = new Date(paques);
        lundiPaques.setDate(lundiPaques.getDate() + 1);
        feries.push({ date: lundiPaques, nom: "Lundi de P√¢ques" });
        
        // Ascension (P√¢ques + 39)
        const ascension = new Date(paques);
        ascension.setDate(ascension.getDate() + 39);
        feries.push({ date: ascension, nom: "Ascension" });
        
        // Lundi de Pentec√¥te (P√¢ques + 50)
        const pentecote = new Date(paques);
        pentecote.setDate(pentecote.getDate() + 50);
        feries.push({ date: pentecote, nom: "Lundi de Pentec√¥te" });
        
        return feries;
    }
    
    function isJourFerie(date) {
        const feries = getJoursFeries(date.getFullYear());
        return feries.find(f => 
            f.date.getDate() === date.getDate() && 
            f.date.getMonth() === date.getMonth()
        );
    }
    
    function isDimanche(date) {
        return date.getDay() === 0;
    }

    // ============================================
    // GESTION DES RETARDS
    // ============================================
    function openRetardModal(employeeId, day) {
        document.getElementById('retardEmployeeId').value = employeeId;
        document.getElementById('retardDay').value = day;
        document.getElementById('retardHeures').value = 0;
        document.getElementById('retardMinutes').value = 30;
        document.getElementById('retardMotif').value = '';
        document.getElementById('retardModal').style.display = 'block';
    }
    
    function saveRetard(event) {
        event.preventDefault();
        
        try {
            const employeeId = document.getElementById('retardEmployeeId').value;
            const day = parseInt(document.getElementById('retardDay').value);
            const heures = parseInt(document.getElementById('retardHeures').value) || 0;
            const minutes = parseInt(document.getElementById('retardMinutes').value) || 0;
            const motif = document.getElementById('retardMotif').value.trim();
            
            const totalMinutes = heures * 60 + minutes;
            if (totalMinutes === 0) {
                showToast('Veuillez saisir une dur√©e de retard', 'error');
                return;
            }
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showToast('Employ√© non trouv√©', 'error');
                return;
            }
            
            if (!employee.planning) employee.planning = {};
            const weekKey = getWeekKey();
            if (!employee.planning[weekKey]) employee.planning[weekKey] = {};
            if (!employee.planning[weekKey][day]) employee.planning[weekKey][day] = [];
            
            // Formater la dur√©e du retard
            let retardText = '';
            if (heures > 0 && minutes > 0) {
                retardText = `‚è∞ -${heures}h${minutes.toString().padStart(2, '0')}`;
            } else if (heures > 0) {
                retardText = `‚è∞ -${heures}h`;
            } else {
                retardText = `‚è∞ -${minutes}min`;
            }
            if (motif) retardText += ` (${motif})`;
            
            const newShift = {
                id: generateId(),
                type: 'retard',
                text: retardText,
                retardMinutes: totalMinutes,
                motif: motif
            };
            
            employee.planning[weekKey][day].push(newShift);
            
            closeModal();
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`Retard de ${heures}h${minutes.toString().padStart(2, '0')} ajout√©`, 'success');
            
        } catch (error) {
            console.error('Erreur sauvegarde retard:', error);
            showToast('Erreur lors de l\'ajout du retard', 'error');
        }
    }

    // ============================================
    // GESTION HEURES COURS / CONG√âS / F√âRI√â
    // ============================================
    function openHeuresAbsenceModal(employeeId, day, type) {
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        const contractHours = employee ? (employee.contractHours || 35) : 35;
        
        // Calculer les heures par d√©faut selon le contrat (heures/jour = contrat/5)
        const defaultHours = Math.floor(contractHours / 5);
        const defaultMinutes = Math.round((contractHours / 5 - defaultHours) * 60);
        
        // Mettre √† jour le titre et le bouton selon le type
        const titles = {
            'cours': 'üìö Cours / Formation',
            'conges': 'üèñÔ∏è Cong√©s',
            'ferie': 'üéå Jour F√©ri√©',
            'absent': '‚ùå Absence'
        };
        const btnColors = {
            'cours': 'background: linear-gradient(135deg, #f59e0b, #d97706);',
            'conges': 'background: linear-gradient(135deg, #10b981, #059669);',
            'ferie': 'background: linear-gradient(135deg, #8b5cf6, #7c3aed);',
            'absent': 'background: linear-gradient(135deg, #ef4444, #dc2626);'
        };
        
        document.getElementById('heuresAbsenceTitle').textContent = titles[type] || 'üìã Saisir les heures';
        document.getElementById('heuresAbsenceSubmitBtn').style.cssText = btnColors[type] || '';
        
        document.getElementById('heuresAbsenceEmployeeId').value = employeeId;
        document.getElementById('heuresAbsenceDay').value = day;
        document.getElementById('heuresAbsenceType').value = type;
        document.getElementById('heuresAbsenceHeures').value = defaultHours;
        document.getElementById('heuresAbsenceMinutes').value = defaultMinutes;
        document.getElementById('heuresAbsenceStart').value = '09:00';
        document.getElementById('heuresAbsenceEnd').value = '17:00';
        document.getElementById('heuresAbsenceNote').value = '';
        
        document.getElementById('heuresAbsenceModal').style.display = 'block';
    }
    
    function calculateHeuresFromTime() {
        const start = document.getElementById('heuresAbsenceStart').value;
        const end = document.getElementById('heuresAbsenceEnd').value;
        
        if (start && end) {
            const hours = calculateHours(start, end);
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            
            document.getElementById('heuresAbsenceHeures').value = h;
            document.getElementById('heuresAbsenceMinutes').value = m;
            
            showToast(`Heures calcul√©es : ${formatHours(hours)}`, 'success');
        }
    }
    
    function saveHeuresAbsence(event) {
        event.preventDefault();
        
        try {
            const employeeId = document.getElementById('heuresAbsenceEmployeeId').value;
            const day = parseInt(document.getElementById('heuresAbsenceDay').value);
            const type = document.getElementById('heuresAbsenceType').value;
            const heures = parseInt(document.getElementById('heuresAbsenceHeures').value) || 0;
            const minutes = parseInt(document.getElementById('heuresAbsenceMinutes').value) || 0;
            const note = document.getElementById('heuresAbsenceNote').value.trim();
            const startTime = document.getElementById('heuresAbsenceStart').value;
            const endTime = document.getElementById('heuresAbsenceEnd').value;
            
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) {
                showToast('Employ√© non trouv√©', 'error');
                return;
            }
            
            if (!employee.planning) employee.planning = {};
            const weekKey = getWeekKey();
            if (!employee.planning[weekKey]) employee.planning[weekKey] = {};
            if (!employee.planning[weekKey][day]) employee.planning[weekKey][day] = [];
            
            // Formater le texte √† afficher
            const totalHours = heures + minutes / 60;
            const hoursText = formatHours(totalHours);
            
            const labels = {
                'cours': 'üìö Cours',
                'conges': 'üèñÔ∏è Cong√©s',
                'ferie': 'üéå F√©ri√©',
                'absent': '‚ùå Absent'
            };
            
            // Afficher les horaires dans la case si renseign√©s
            let displayText = `${labels[type]}`;
            if (startTime && endTime && type !== 'absent') {
                displayText += ` ${startTime}-${endTime}`;
            }
            displayText += ` (${hoursText})`;
            if (note) displayText += ` - ${note}`;
            
            const newShift = {
                id: generateId(),
                type: type,
                text: displayText,
                hours: hoursText,
                startTime: startTime,
                endTime: endTime,
                note: note
            };
            
            employee.planning[weekKey][day].push(newShift);
            
            closeModal();
            renderPlanning();
            updateSummary();
            saveData();
            
            showToast(`${labels[type]} ajout√© (${hoursText})`, 'success');
            
        } catch (error) {
            console.error('Erreur sauvegarde heures absence:', error);
            showToast('Erreur lors de l\'ajout', 'error');
        }
    }

    // ============================================
    // CALCUL DU SOLDE MENSUEL CUMUL√â
    // Le solde repart √† 0 automatiquement chaque 1er du mois
    // ============================================
    function calculateMonthlySolde(employee, targetMonth, targetYear) {
        const contractHours = employee.contractHours || 35;
        let totalWorkedHours = 0;
        let totalRetardMinutes = 0;
        let workDaysInMonth = 0;
        
        // Calculer le nombre de semaines COMPL√àTES dans le mois (lundi-dimanche)
        const firstDayOfMonth = new Date(targetYear, targetMonth, 1);
        const lastDayOfMonth = new Date(targetYear, targetMonth + 1, 0);
        
        // Trouver le premier lundi du mois
        let firstMonday = new Date(firstDayOfMonth);
        while (firstMonday.getDay() !== 1) {
            firstMonday.setDate(firstMonday.getDate() + 1);
        }
        // Trouver le dernier dimanche du mois
        let lastSunday = new Date(lastDayOfMonth);
        while (lastSunday.getDay() !== 0) {
            lastSunday.setDate(lastSunday.getDate() - 1);
        }
        // Nombre de semaines compl√®tes
        const completeWeeks = Math.max(0, Math.floor((lastSunday - firstMonday) / (7 * 24 * 60 * 60 * 1000)) + 1);
        
        // V√©rifier si une RAZ manuelle a √©t√© faite ce mois-ci
        let razDate = null;
        if (employee.soldeRaz) {
            const razD = new Date(employee.soldeRaz);
            if (razD.getMonth() === targetMonth && razD.getFullYear() === targetYear) {
                razDate = razD;
            }
        }
        
        // Parcourir toutes les semaines du mois
        let currentWeekStart = new Date(firstDayOfMonth);
        const dayOfWeek = currentWeekStart.getDay();
        const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        currentWeekStart.setDate(currentWeekStart.getDate() + diff);
        
        while (currentWeekStart <= lastDayOfMonth) {
            const year = currentWeekStart.getFullYear();
            const firstDay = new Date(year, 0, 1);
            const pastDays = (currentWeekStart - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            const weekKey = `${year}-W${weekNumber}`;
            
            if (employee.planning && employee.planning[weekKey]) {
                Object.keys(employee.planning[weekKey]).forEach(dayIndex => {
                    const dayShifts = employee.planning[weekKey][dayIndex];
                    const shiftDate = new Date(currentWeekStart);
                    shiftDate.setDate(shiftDate.getDate() + parseInt(dayIndex));
                    
                    // IMPORTANT: Ne compter que les jours dans les semaines COMPL√àTES
                    // (entre le premier lundi et le dernier dimanche du mois)
                    if (shiftDate >= firstMonday && shiftDate <= lastSunday && shiftDate.getMonth() === targetMonth && shiftDate.getFullYear() === targetYear) {
                        // Si RAZ, ne compter que les jours apr√®s la RAZ
                        if (razDate && shiftDate < razDate) return;
                        
                        let dayHasWork = false;
                        dayShifts.forEach(shift => {
                            // Compter les heures de travail
                            if (shift.type === 'work' && shift.hours) {
                                totalWorkedHours += parseHours(shift.hours);
                                dayHasWork = true;
                            }
                            // Compter les heures de Cours, Cong√©s et F√©ri√© (si elles ont des heures)
                            if (['cours', 'conges', 'ferie'].includes(shift.type) && shift.hours) {
                                totalWorkedHours += parseHours(shift.hours);
                                dayHasWork = true;
                            }
                            // Soustraire les retards
                            if (shift.type === 'retard') {
                                let mins = 0;
                                if (shift.retardMinutes !== undefined && shift.retardMinutes !== null) {
                                    mins = parseInt(shift.retardMinutes) || 0;
                                }
                                totalRetardMinutes += mins;
                            }
                        });
                        if (dayHasWork) workDaysInMonth++;
                    }
                });
            }
            
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        }
        
        // Calculer les heures attendues = semaines COMPL√àTES √ó contrat
        const expectedHours = completeWeeks * contractHours;
        
        // Prendre en compte les r√©gularisations du mois
        let regularisationTotal = 0;
        const targetMonthKey = `${targetYear}-${(targetMonth + 1).toString().padStart(2, '0')}`;
        if (employee.regularisations) {
            employee.regularisations.forEach(reg => {
                // Utiliser le champ 'mois' si disponible, sinon fallback sur la date
                if (reg.mois) {
                    if (reg.mois === targetMonthKey) {
                        regularisationTotal += reg.heures;
                    }
                } else {
                    const regDate = new Date(reg.date);
                    if (regDate.getMonth() === targetMonth && regDate.getFullYear() === targetYear) {
                        regularisationTotal += reg.heures;
                    }
                }
            });
        }
        
        // Soustraire les retards des heures travaill√©es
        const effectiveWorkedHours = totalWorkedHours - (totalRetardMinutes / 60);
        // Calculer le solde AVANT r√©gularisation
        const soldeAvantRegul = effectiveWorkedHours - expectedHours;
        // Le solde APR√àS r√©gularisation : on ajoute les heures r√©gularis√©es (elles "compensent" le solde)
        // Si solde = -5h et on r√©gularise 5h, le nouveau solde = -5h + 5h = 0h
        const solde = soldeAvantRegul + regularisationTotal;
        
        return {
            worked: totalWorkedHours,
            retard: totalRetardMinutes / 60,
            effective: effectiveWorkedHours,
            expected: expectedHours,
            solde: solde,
            workDays: workDaysInMonth,
            completeWeeks: completeWeeks,
            regularise: regularisationTotal
        };
    }

    // ============================================
    // R√âGULARISATION DES HEURES
    // ============================================
    function openRegularisationModal() {
        const select = document.getElementById('regularisationEmploye');
        select.innerHTML = '';
        
        globalState.employees.filter(emp => !emp.archived).forEach(emp => {
            select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
        });
        
        updateRegularisationSolde();
        updateRegularisationUI();
        document.getElementById('regularisationModal').style.display = 'block';
    }
    
    function updateRegularisationSolde() {
        const employeeId = document.getElementById('regularisationEmploye').value;
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        const currentDate = new Date(globalState.currentWeek);
        const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
        
        // Calculer le solde cumul√© (tous les mois jusqu'au mois actuel)
        const soldeCumule = calculateCumulativeSolde(employee, currentDate.getMonth(), currentDate.getFullYear());
        
        const soldeElement = document.getElementById('regularisationSoldeActuel');
        const solde = monthSolde.solde;
        
        // Affichage du solde du mois
        let soldeText = '';
        if (solde >= 0) {
            soldeText = `+${formatHours(solde)}`;
            soldeElement.style.color = solde > 0 ? '#ef4444' : '#10b981';
        } else {
            soldeText = `-${formatHours(Math.abs(solde))}`;
            soldeElement.style.color = '#f59e0b';
        }
        soldeElement.textContent = soldeText;
        
        // Afficher le solde cumul√©
        const cumulElement = document.getElementById('regularisationSoldeCumule');
        let cumulText = soldeCumule >= 0 ? `+${formatHours(soldeCumule)}` : `-${formatHours(Math.abs(soldeCumule))}`;
        let cumulColor = soldeCumule > 0 ? '#ef4444' : soldeCumule < 0 ? '#f59e0b' : '#10b981';
        cumulElement.textContent = cumulText;
        cumulElement.style.color = cumulColor;
        
        // Mettre √† jour les heures par d√©faut
        const heures = Math.floor(Math.abs(solde));
        const minutes = Math.round((Math.abs(solde) - heures) * 60);
        document.getElementById('regularisationHeures').value = heures;
        document.getElementById('regularisationMinutes').value = minutes;
        
        // Afficher l'historique des r√©gularisations
        const historiqueElement = document.getElementById('regularisationHistorique');
        const targetMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
        if (employee.regularisations && employee.regularisations.length > 0) {
            const monthRegs = employee.regularisations.filter(reg => {
                if (reg.mois) {
                    return reg.mois === targetMonthKey;
                } else {
                    const regDate = new Date(reg.date);
                    return regDate.getMonth() === currentDate.getMonth() && regDate.getFullYear() === currentDate.getFullYear();
                }
            });
            
            if (monthRegs.length > 0) {
                let html = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #d1d5db;">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
                html += '<strong>üìú R√©gularisations ce mois :</strong>';
                html += `<button type="button" onclick="clearAllRegularisations('${employee.id}')" style="padding: 2px 8px; font-size: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer;">üóëÔ∏è Tout supprimer</button>`;
                html += '</div>';
                html += '<ul style="margin: 5px 0; padding-left: 15px; list-style: none;">';
                monthRegs.forEach(reg => {
                    const dateStr = new Date(reg.date).toLocaleDateString('fr-FR');
                    const icon = reg.type === 'paye' ? 'üíµ' : reg.type === 'recupere' ? 'üîÑ' : reg.type === 'report_entrant' ? 'üì•' : 'üìÖ';
                    const typeLabel = reg.type === 'paye' ? 'pay√©' : reg.type === 'recupere' ? 'r√©cup√©r√©' : reg.type === 'report_entrant' ? 'report entrant' : 'report√©';
                    const heuresText = reg.heures >= 0 ? `+${formatHours(reg.heures)}` : `-${formatHours(Math.abs(reg.heures))}`;
                    html += `<li style="display: flex; justify-content: space-between; align-items: center; padding: 3px 0;">`;
                    html += `<span>${icon} ${dateStr} : ${heuresText} ${typeLabel}${reg.note ? ` (${reg.note})` : ''}</span>`;
                    html += `<button type="button" onclick="deleteRegularisation('${employee.id}', '${reg.id}')" style="padding: 1px 5px; font-size: 10px; background: #fee2e2; color: #dc2626; border: none; border-radius: 3px; cursor: pointer;">‚úï</button>`;
                    html += `</li>`;
                });
                html += '</ul></div>';
                historiqueElement.innerHTML = html;
            } else {
                historiqueElement.innerHTML = '';
            }
        } else {
            historiqueElement.innerHTML = '';
        }
        
        updateRegularisationReste();
    }
    
    function deleteRegularisation(employeeId, regId) {
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee || !employee.regularisations) return;
        
        const regIndex = employee.regularisations.findIndex(r => r.id === regId);
        if (regIndex === -1) return;
        
        const reg = employee.regularisations[regIndex];
        if (!confirm(`Supprimer cette r√©gularisation ?\n${formatHours(Math.abs(reg.heures))} ${reg.type}`)) return;
        
        employee.regularisations.splice(regIndex, 1);
        saveData();
        updateRegularisationSolde();
        updateSummary();
        showToast('R√©gularisation supprim√©e', 'success');
    }
    
    function clearAllRegularisations(employeeId) {
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee || !employee.regularisations) return;
        
        const currentDate = new Date(globalState.currentWeek);
        const targetMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
        
        const monthRegs = employee.regularisations.filter(reg => {
            if (reg.mois) return reg.mois === targetMonthKey;
            const regDate = new Date(reg.date);
            return regDate.getMonth() === currentDate.getMonth() && regDate.getFullYear() === currentDate.getFullYear();
        });
        
        if (monthRegs.length === 0) return;
        
        if (!confirm(`Supprimer TOUTES les ${monthRegs.length} r√©gularisations de ce mois pour ${employee.name} ?`)) return;
        
        // Supprimer les r√©gularisations du mois
        employee.regularisations = employee.regularisations.filter(reg => {
            if (reg.mois) return reg.mois !== targetMonthKey;
            const regDate = new Date(reg.date);
            return !(regDate.getMonth() === currentDate.getMonth() && regDate.getFullYear() === currentDate.getFullYear());
        });
        
        saveData();
        updateRegularisationSolde();
        updateSummary();
        showToast(`${monthRegs.length} r√©gularisations supprim√©es pour ${employee.name}`, 'success');
    }
    
    // Calculer le solde cumul√© de tous les mois jusqu'au mois cible
    function calculateCumulativeSolde(employee, targetMonth, targetYear) {
        let cumulativeSolde = 0;
        
        // Utiliser la date de RAZ cumul si d√©finie, sinon janvier de l'ann√©e en cours
        let startYear = targetYear;
        let startMonth = 0; // Janvier par d√©faut
        
        if (employee.cumulStartDate) {
            const startDate = new Date(employee.cumulStartDate);
            startYear = startDate.getFullYear();
            startMonth = startDate.getMonth();
        }
        
        // Ajouter le solde de d√©part s'il existe
        if (employee.cumulStartBalance !== undefined) {
            cumulativeSolde = employee.cumulStartBalance;
        }
        
        // Ne pas calculer si la date cible est avant la date de d√©but
        if (targetYear < startYear || (targetYear === startYear && targetMonth < startMonth)) {
            return cumulativeSolde; // Retourner juste le solde de d√©part
        }
        
        for (let year = startYear; year <= targetYear; year++) {
            const monthStart = (year === startYear) ? startMonth : 0;
            const monthEnd = (year === targetYear) ? targetMonth : 11;
            
            for (let month = monthStart; month <= monthEnd; month++) {
                const monthSolde = calculateMonthlySolde(employee, month, year);
                cumulativeSolde += monthSolde.solde;
            }
        }
        
        return cumulativeSolde;
    }
    
    // Fonctions pour la RAZ Cumul
    function openRazCumulModal() {
        const employeeId = document.getElementById('regularisationEmploye').value;
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        document.getElementById('razCumulEmployeeName').textContent = employee.name;
        
        // D√©finir le mois actuel par d√©faut
        const currentDate = new Date(globalState.currentWeek);
        const monthValue = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
        document.getElementById('razCumulDate').value = monthValue;
        
        // R√©initialiser les champs de solde de d√©part
        document.getElementById('razCumulSigne').value = '-';
        document.getElementById('razCumulHeures').value = 0;
        document.getElementById('razCumulMinutes').value = 0;
        
        // Si un solde de d√©part existe d√©j√†, le pr√©-remplir
        if (employee.cumulStartBalance !== undefined && employee.cumulStartBalance !== 0) {
            const balance = employee.cumulStartBalance;
            document.getElementById('razCumulSigne').value = balance >= 0 ? '+' : '-';
            const absBalance = Math.abs(balance);
            document.getElementById('razCumulHeures').value = Math.floor(absBalance);
            document.getElementById('razCumulMinutes').value = Math.round((absBalance - Math.floor(absBalance)) * 60);
        }
        
        document.getElementById('razCumulModal').style.display = 'block';
    }
    
    function closeRazCumulModal() {
        document.getElementById('razCumulModal').style.display = 'none';
    }
    
    function executeRazCumul() {
        const employeeId = document.getElementById('regularisationEmploye').value;
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        const monthInput = document.getElementById('razCumulDate').value;
        if (!monthInput) {
            showToast('Veuillez s√©lectionner un mois', 'error');
            return;
        }
        
        // R√©cup√©rer le solde de d√©part
        const signe = document.getElementById('razCumulSigne').value;
        const heures = parseInt(document.getElementById('razCumulHeures').value) || 0;
        const minutes = parseInt(document.getElementById('razCumulMinutes').value) || 0;
        const soldeDepart = (heures + minutes / 60) * (signe === '-' ? -1 : 1);
        
        // Stocker la date de d√©but et le solde de d√©part
        employee.cumulStartDate = `${monthInput}-01`;
        employee.cumulStartBalance = soldeDepart;
        
        saveData();
        closeRazCumulModal();
        updateRegularisationSolde();
        
        const monthName = new Date(monthInput + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        const soldeText = soldeDepart === 0 ? '0h' : (soldeDepart >= 0 ? `+${formatHours(soldeDepart)}` : `-${formatHours(Math.abs(soldeDepart))}`);
        showToast(`Cumul de ${employee.name} : d√©part ${soldeText} depuis ${monthName}`, 'success');
    }
    
    // Fonctions pour l'export Mail
    function openExportMailModal() {
        // D√©finir le mois actuel
        const currentDate = new Date(globalState.currentWeek);
        const monthValue = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
        document.getElementById('exportMois').value = monthValue;
        
        // G√©n√©rer la liste des employ√©s avec cases √† cocher et prime
        const container = document.getElementById('exportEmployesList');
        container.innerHTML = '';
        
        globalState.employees.filter(emp => !emp.archived).forEach(emp => {
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 10px 8px; border-bottom: 1px solid #e5e7eb;';
            div.innerHTML = `
                <input type="checkbox" id="export_${emp.id}" value="${emp.id}" checked style="width: 18px; height: 18px; cursor: pointer;">
                <label for="export_${emp.id}" style="cursor: pointer; flex: 1; font-weight: 500;">${emp.name}</label>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <span style="font-size: 11px; color: #6b7280;">Prime:</span>
                    <input type="number" id="prime_${emp.id}" min="0" step="0.01" placeholder="0" 
                           style="width: 70px; padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; text-align: right;">
                    <span style="font-size: 11px; color: #6b7280;">‚Ç¨</span>
                </div>
            `;
            container.appendChild(div);
        });
        
        document.getElementById('exportComptableModal').style.display = 'block';
    }
    
    function selectAllExportEmployees(checked) {
        const checkboxes = document.querySelectorAll('#exportEmployesList input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = checked);
    }
    
    function executeExportComptable() {
        const monthInput = document.getElementById('exportMois').value;
        if (!monthInput) {
            showToast('Veuillez s√©lectionner un mois', 'error');
            return;
        }
        
        // R√©cup√©rer les employ√©s s√©lectionn√©s avec leurs primes
        const checkboxes = document.querySelectorAll('#exportEmployesList input[type="checkbox"]:checked');
        const selectedData = Array.from(checkboxes).map(cb => {
            const empId = cb.value;
            const primeInput = document.getElementById(`prime_${empId}`);
            const prime = primeInput ? parseFloat(primeInput.value) || 0 : 0;
            return { id: empId, prime: prime };
        });
        
        if (selectedData.length === 0) {
            showToast('Veuillez s√©lectionner au moins un employ√©', 'error');
            return;
        }
        
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        
        // G√©n√©rer le rapport
        const [year, month] = monthInput.split('-').map(Number);
        const exportDate = new Date(year, month - 1, 15); // Milieu du mois
        const texte = generateExportTexteForMonth(exportDate, selectedData);
        
        if (format === 'email') {
            // Copier dans le presse-papier
            navigator.clipboard.writeText(texte).then(() => {
                showToast('üìã Rapport copi√© dans le presse-papier !', 'success');
            }).catch(() => {
                // Fallback si clipboard ne fonctionne pas
                const textarea = document.createElement('textarea');
                textarea.value = texte;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('üìã Rapport copi√© dans le presse-papier !', 'success');
            });
        } else {
            // T√©l√©charger en fichier texte
            const monthName = exportDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            const blob = new Blob([texte], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Recap_Paie_${monthName.replace(' ', '_')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('üìÑ Fichier t√©l√©charg√© !', 'success');
        }
        
        closeModal();
    }
    
    function updateRegularisationUI() {
        const type = document.querySelector('input[name="regularisationType"]:checked').value;
        const heuresGroup = document.getElementById('regularisationHeuresGroup');
        
        if (type === 'reporte') {
            heuresGroup.style.display = 'none';
        } else {
            heuresGroup.style.display = 'block';
        }
    }
    
    function updateRegularisationReste() {
        const employeeId = document.getElementById('regularisationEmploye').value;
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        const currentDate = new Date(globalState.currentWeek);
        const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
        const soldeCumule = calculateCumulativeSolde(employee, currentDate.getMonth(), currentDate.getFullYear());
        const soldeTotal = Math.abs(monthSolde.solde);
        const soldeCumulTotal = Math.abs(soldeCumule);
        
        const heures = parseInt(document.getElementById('regularisationHeures').value) || 0;
        const minutes = parseInt(document.getElementById('regularisationMinutes').value) || 0;
        const heuresRegul = heures + (minutes / 60);
        
        const resteMois = soldeTotal - heuresRegul;
        const resteCumul = soldeCumulTotal - heuresRegul;
        const resteElement = document.getElementById('regularisationReste');
        
        if (heuresRegul <= 0) {
            resteElement.innerHTML = `üìå Saisissez les heures √† r√©gulariser`;
            resteElement.style.background = '#f3f4f6';
            resteElement.style.color = '#6b7280';
        } else if (resteMois > 0) {
            resteElement.innerHTML = `üìå Reste ce mois : <strong>${formatHours(resteMois)}</strong> | Reste cumul√© : <strong>${formatHours(resteCumul)}</strong>`;
            resteElement.style.background = '#fef3c7';
            resteElement.style.color = '#92400e';
        } else if (resteMois === 0) {
            resteElement.innerHTML = `‚úÖ Solde du mois enti√®rement r√©gularis√©${resteCumul > 0 ? ` | Reste cumul√© : <strong>${formatHours(resteCumul)}</strong>` : ''}`;
            resteElement.style.background = '#dcfce7';
            resteElement.style.color = '#16a34a';
        } else {
            // On r√©gularise plus que le mois
            resteElement.innerHTML = `‚ÑπÔ∏è R√©gularise ${formatHours(heuresRegul)} (${formatHours(Math.abs(resteMois))} de plus que le mois)${resteCumul > 0 ? ` | Reste cumul√© : <strong>${formatHours(resteCumul)}</strong>` : resteCumul < 0 ? ` | ‚ö†Ô∏è D√©passe le cumul de ${formatHours(Math.abs(resteCumul))}` : ' | ‚úÖ Cumul sold√©'}`;
            resteElement.style.background = '#dbeafe';
            resteElement.style.color = '#1e40af';
        }
    }
    
    function regulariserTout() {
        const employeeId = document.getElementById('regularisationEmploye').value;
        const employee = globalState.employees.find(emp => emp.id === employeeId);
        if (!employee) return;
        
        const currentDate = new Date(globalState.currentWeek);
        const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
        const soldeTotal = Math.abs(monthSolde.solde);
        
        const heures = Math.floor(soldeTotal);
        const minutes = Math.round((soldeTotal - heures) * 60);
        
        document.getElementById('regularisationHeures').value = heures;
        document.getElementById('regularisationMinutes').value = minutes;
        updateRegularisationReste();
    }
    
    function executeRegularisation() {
        try {
            // D√©sactiver le bouton pour √©viter double-clic
            const validateBtn = document.querySelector('#regularisationModal .btn.admin');
            if (validateBtn) {
                validateBtn.disabled = true;
                validateBtn.textContent = '‚è≥ Enregistrement...';
            }
            
            const employeeId = document.getElementById('regularisationEmploye').value;
            const employee = globalState.employees.find(emp => emp.id === employeeId);
            if (!employee) {
                if (validateBtn) {
                    validateBtn.disabled = false;
                    validateBtn.textContent = '‚úÖ Valider';
                }
                return;
            }
            
            const type = document.querySelector('input[name="regularisationType"]:checked').value;
            const note = document.getElementById('regularisationNote').value;
            
            const currentDate = new Date(globalState.currentWeek);
            const monthName = currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            const currentMonth = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // Initialiser le tableau des r√©gularisations si n√©cessaire
            if (!employee.regularisations) {
                employee.regularisations = [];
            }
            
            if (type === 'reporte') {
                // Calculer le solde actuel du mois
                const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
                const soldeActuel = monthSolde.solde;
                
                if (soldeActuel === 0) {
                    showToast('Le solde est d√©j√† √† 0, rien √† reporter', 'info');
                    if (validateBtn) {
                        validateBtn.disabled = false;
                        validateBtn.textContent = '‚úÖ Valider';
                    }
                    closeModal();
                    return;
                }
                
                // Cr√©er une r√©gularisation qui annule le solde du mois actuel
                // Si solde = -5h, on ajoute +5h pour remettre √† 0
                // Si solde = +3h, on ajoute -3h pour remettre √† 0
                const heuresRegul = -soldeActuel; // Inverse du solde
                
                employee.regularisations.push({
                    id: generateId(),
                    date: new Date().toISOString(),
                    mois: currentMonth,
                    type: 'reporte',
                    heures: heuresRegul,
                    note: note || `Report√© au mois suivant (${monthName})`
                });
                
                // Calculer le mois suivant
                const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                const nextMonthKey = `${nextMonth.getFullYear()}-${(nextMonth.getMonth() + 1).toString().padStart(2, '0')}`;
                const nextMonthName = nextMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                // Ajouter le solde au mois suivant (inverse de l'inverse = solde original)
                employee.regularisations.push({
                    id: generateId(),
                    date: new Date().toISOString(),
                    mois: nextMonthKey,
                    type: 'report_entrant',
                    heures: soldeActuel,
                    note: `Report de ${monthName}`
                });
                
                const soldeText = soldeActuel >= 0 ? `+${formatHours(soldeActuel)}` : `-${formatHours(Math.abs(soldeActuel))}`;
                showToast(`‚úÖ ${employee.name} : ${soldeText} report√© vers ${nextMonthName}`, 'success');
                
            } else {
                const heures = parseInt(document.getElementById('regularisationHeures').value) || 0;
                const minutes = parseInt(document.getElementById('regularisationMinutes').value) || 0;
                const heuresTotal = heures + (minutes / 60);
                
                if (heuresTotal <= 0) {
                    showToast('Veuillez entrer un nombre d\'heures valide', 'error');
                    if (validateBtn) {
                        validateBtn.disabled = false;
                        validateBtn.textContent = '‚úÖ Valider';
                    }
                    return;
                }
                
                // Calculer le solde actuel pour d√©terminer le signe de la r√©gularisation
                const monthSolde = calculateMonthlySolde(employee, currentDate.getMonth(), currentDate.getFullYear());
                
                // Si solde positif (heures sup): r√©gularisation n√©gative (on soustrait)
                // Si solde n√©gatif (d√©ficit): r√©gularisation positive (on ajoute)
                const heuresRegul = monthSolde.solde >= 0 ? -heuresTotal : heuresTotal;
                
                // Ajouter la r√©gularisation
                employee.regularisations.push({
                    id: generateId(),
                    date: new Date().toISOString(),
                    mois: currentMonth,
                    type: type,
                    heures: heuresRegul,
                    note: note || (type === 'paye' ? `Pay√© sur paie ${monthName}` : `R√©cup√©r√© ${monthName}`)
                });
                
                const typeLabel = type === 'paye' ? 'pay√©es' : 'r√©cup√©r√©es';
                showToast(`‚úÖ ${employee.name} : ${formatHours(heuresTotal)} ${typeLabel}`, 'success');
            }
            
            // Reset des champs pour √©viter confusion
            document.getElementById('regularisationHeures').value = 0;
            document.getElementById('regularisationMinutes').value = 0;
            document.getElementById('regularisationNote').value = '';
            
            // Fermer la modale, sauvegarder, mettre √† jour
            closeModal();
            updateSummary();
            saveData();
            
        } catch (error) {
            console.error('Erreur r√©gularisation:', error);
            showToast('Erreur lors de la r√©gularisation', 'error');
        } finally {
            // R√©activer le bouton dans tous les cas
            const validateBtn = document.querySelector('#regularisationModal .btn.admin');
            if (validateBtn) {
                validateBtn.disabled = false;
                validateBtn.textContent = '‚úÖ Valider';
            }
        }
    }

    // ============================================
    // RAZ SOLDES (ancienne fonction conserv√©e)
    // ============================================
    function openRazSoldesModal() {
        const select = document.getElementById('razSelection');
        select.innerHTML = '<option value="tous">üåü TOUS les employ√©s</option>';
        
        globalState.employees.filter(emp => !emp.archived).forEach(emp => {
            select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
        });
        
        document.getElementById('razSoldesModal').style.display = 'block';
    }
    
    function executeRazSoldes() {
        try {
            const selection = document.getElementById('razSelection').value;
            
            if (selection === 'tous') {
                if (!confirm('‚ö†Ô∏è Remettre √† z√©ro le solde de TOUS les employ√©s ?')) return;
                
                globalState.employees.forEach(emp => {
                    emp.soldeRaz = new Date().toISOString();
                });
                showToast('Soldes de tous les employ√©s remis √† z√©ro', 'success');
            } else {
                const employee = globalState.employees.find(emp => emp.id === selection);
                if (!employee) return;
                
                if (!confirm(`‚ö†Ô∏è Remettre √† z√©ro le solde de ${employee.name} ?`)) return;
                
                employee.soldeRaz = new Date().toISOString();
                showToast(`Solde de ${employee.name} remis √† z√©ro`, 'success');
            }
            
            closeModal();
            updateSummary();
            saveData();
            
        } catch (error) {
            console.error('Erreur RAZ soldes:', error);
            showToast('Erreur lors de la remise √† z√©ro', 'error');
        }
    }

    // ============================================
    // EXPORT TEXTE SIMPLIFI√â POUR COMPTABLE
    // ============================================
    function generateExportTexteForMonth(exportDate, selectedEmployeeIds) {
        try {
            const currentDate = exportDate || new Date(globalState.currentWeek);
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const monthName = currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            
            // Calculer les semaines COMPL√àTES dans le mois (lundi-dimanche)
            let firstMonday = new Date(firstDayOfMonth);
            while (firstMonday.getDay() !== 1) {
                firstMonday.setDate(firstMonday.getDate() + 1);
            }
            let lastSunday = new Date(lastDayOfMonth);
            while (lastSunday.getDay() !== 0) {
                lastSunday.setDate(lastSunday.getDate() - 1);
            }
            const completeWeeks = Math.max(0, Math.floor((lastSunday - firstMonday) / (7 * 24 * 60 * 60 * 1000)) + 1);
            
            const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            
            let texte = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            texte += `                    R√âCAPITULATIF PAIE\n`;
            texte += `                    ${monthName.toUpperCase()}\n`;
            texte += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            // Filtrer les employ√©s selon la s√©lection
            let activeEmployees = globalState.employees.filter(emp => !emp.archived);
            
            // Cr√©er un map des primes par employ√©
            const primesMap = {};
            if (selectedEmployeeIds && selectedEmployeeIds.length > 0) {
                // Nouveau format: [{id, prime}, ...]
                if (typeof selectedEmployeeIds[0] === 'object') {
                    selectedEmployeeIds.forEach(item => {
                        primesMap[item.id] = item.prime || 0;
                    });
                    const selectedIds = selectedEmployeeIds.map(item => item.id);
                    activeEmployees = activeEmployees.filter(emp => selectedIds.includes(emp.id));
                } else {
                    // Ancien format: [id, id, ...]
                    activeEmployees = activeEmployees.filter(emp => selectedEmployeeIds.includes(emp.id));
                }
            }
            
            activeEmployees.forEach(employee => {
                const contractHours = employee.contractHours || 35;
                const primeExceptionnelle = primesMap[employee.id] || 0;
                
                // Structure pour stocker les donn√©es par semaine
                let weeksData = [];
                let totalNormalHours = 0;
                let totalDimanchesHours = 0;
                let totalFeriesHours = 0;
                let totalAbsencesHours = 0;
                let totalRetardMinutes = 0;
                let allDimanchesDetails = [];
                let allFeriesDetails = [];
                let allAbsencesDetails = [];
                let allRetardsDetails = [];
                let allCongesDetails = [];
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // COMPTAGE SUR TOUT LE MOIS (1er au dernier jour)
                // Pour : jours travaill√©s, f√©ri√©s, dimanches
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                let totalDaysWorkedFullMonth = 0;
                let totalFeriesFullMonth = [];
                let totalDimanchesFullMonth = [];
                
                // Parcourir chaque jour du mois complet
                let currentDayCheck = new Date(firstDayOfMonth);
                while (currentDayCheck <= lastDayOfMonth) {
                    // Trouver la cl√© de semaine pour ce jour
                    const dayOfWeek = currentDayCheck.getDay();
                    const mondayOfWeek = new Date(currentDayCheck);
                    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                    mondayOfWeek.setDate(mondayOfWeek.getDate() + diffToMonday);
                    
                    const year = mondayOfWeek.getFullYear();
                    const firstDayOfYear = new Date(year, 0, 1);
                    const pastDays = (mondayOfWeek - firstDayOfYear) / 86400000;
                    const weekNum = Math.ceil((pastDays + firstDayOfYear.getDay() + 1) / 7);
                    const weekKeyCheck = `${year}-W${weekNum}`;
                    
                    const dayIndexInWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    
                    if (employee.planning && employee.planning[weekKeyCheck] && employee.planning[weekKeyCheck][dayIndexInWeek]) {
                        const dayShifts = employee.planning[weekKeyCheck][dayIndexInWeek];
                        const isDimanche = currentDayCheck.getDay() === 0;
                        const ferie = isJourFerie(currentDayCheck);
                        const dateStr = currentDayCheck.toLocaleDateString('fr-FR');
                        
                        let hasWorkThisDay = false;
                        let dayWorkHours = 0;
                        
                        dayShifts.forEach(shift => {
                            if (shift.type === 'work' && shift.hours) {
                                hasWorkThisDay = true;
                                dayWorkHours += parseHours(shift.hours);
                            }
                            if (['cours', 'conges', 'ferie'].includes(shift.type) && shift.hours) {
                                hasWorkThisDay = true;
                            }
                        });
                        
                        if (hasWorkThisDay) {
                            totalDaysWorkedFullMonth++;
                            
                            // Compter f√©ri√©s travaill√©s sur tout le mois
                            if (ferie && dayWorkHours > 0) {
                                totalFeriesFullMonth.push({ date: dateStr, ferie: ferie.nom, hours: dayWorkHours });
                            }
                            // Compter dimanches travaill√©s sur tout le mois
                            if (isDimanche && dayWorkHours > 0) {
                                totalDimanchesFullMonth.push({ date: dateStr, hours: dayWorkHours });
                            }
                        }
                    }
                    
                    currentDayCheck.setDate(currentDayCheck.getDate() + 1);
                }
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PARCOURS DES SEMAINES COMPL√àTES (pour calcul heures conventionnelles)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                // Parcourir chaque semaine du mois
                let weekStart = new Date(firstMonday);
                let weekNumber = 1;
                
                while (weekStart <= lastSunday) {
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    // Calculer la cl√© de semaine
                    const year = weekStart.getFullYear();
                    const firstDayOfYear = new Date(year, 0, 1);
                    const pastDays = (weekStart - firstDayOfYear) / 86400000;
                    const weekNum = Math.ceil((pastDays + firstDayOfYear.getDay() + 1) / 7);
                    const weekKey = `${year}-W${weekNum}`;
                    
                    let weekNormalHours = 0;
                    let weekDimanchesHours = 0;
                    let weekFeriesHours = 0;
                    let weekAbsencesHours = 0;
                    let weekRetardMinutes = 0;
                    let weekDimanchesDetails = [];
                    let weekFeriesDetails = [];
                    let weekAbsencesDetails = [];
                    
                    if (employee.planning && employee.planning[weekKey]) {
                        for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                            const dayShifts = employee.planning[weekKey][dayIndex];
                            if (!dayShifts) continue;
                            
                            const shiftDate = new Date(weekStart);
                            shiftDate.setDate(shiftDate.getDate() + dayIndex);
                            
                            if (shiftDate.getMonth() !== currentDate.getMonth()) continue;
                            
                            const dateStr = shiftDate.toLocaleDateString('fr-FR');
                            const jourNom = jours[shiftDate.getDay()];
                            const isDimanche = shiftDate.getDay() === 0;
                            const ferie = isJourFerie(shiftDate);
                            
                            // Heures de base pour un jour f√©ri√© selon contrat (7h pour 35h, 8h pour 39h)
                            const heuresBaseJourFerie = contractHours >= 39 ? 8 : 7;
                            
                            dayShifts.forEach(shift => {
                                // Heures de travail
                                if (shift.type === 'work' && shift.hours) {
                                    const hours = parseHours(shift.hours);
                                    
                                    if (isDimanche) {
                                        // Dimanche travaill√© = UNIQUEMENT √† majorer (pas dans les heures conventionnelles)
                                        weekDimanchesHours += hours;
                                        weekDimanchesDetails.push({ date: dateStr, hours: hours, text: shift.text });
                                    } else if (ferie) {
                                        // F√©ri√© travaill√© :
                                        // 1. Ajouter la BASE conventionnelle (7h ou 8h) aux heures normales
                                        weekNormalHours += heuresBaseJourFerie;
                                        // 2. Lister les heures R√âELLEMENT travaill√©es pour majoration
                                        weekFeriesHours += hours;
                                        weekFeriesDetails.push({ date: dateStr, ferie: ferie.nom, hours: hours, text: shift.text });
                                    } else {
                                        // Heures normales
                                        weekNormalHours += hours;
                                    }
                                }
                                
                                // Cours (heures normales)
                                if (shift.type === 'cours' && shift.hours) {
                                    weekNormalHours += parseHours(shift.hours);
                                }
                                
                                // Cong√©s (heures normales)
                                if (shift.type === 'conges' && shift.hours) {
                                    weekNormalHours += parseHours(shift.hours);
                                    allCongesDetails.push(`  ‚Ä¢ ${dateStr} (${jourNom}) - ${shift.hours}`);
                                }
                                
                                // F√©ri√© non travaill√© (heures normales - pay√© automatiquement)
                                if (shift.type === 'ferie' && shift.hours) {
                                    weekNormalHours += parseHours(shift.hours);
                                }
                                
                                // Absences
                                if (shift.type === 'absent') {
                                    const absHours = shift.hours ? parseHours(shift.hours) : 7;
                                    weekAbsencesHours += absHours;
                                    weekAbsencesDetails.push({ date: dateStr, jour: jourNom, hours: absHours });
                                }
                                
                                // Retards
                                if (shift.type === 'retard' && shift.retardMinutes) {
                                    const retardMinsValue = parseInt(shift.retardMinutes) || 0;
                                    weekRetardMinutes += retardMinsValue;
                                    const h = Math.floor(retardMinsValue / 60);
                                    const m = retardMinsValue % 60;
                                    const duree = h > 0 ? `${h}h${m > 0 ? m.toString().padStart(2, '0') : ''}` : `${m}min`;
                                    allRetardsDetails.push(`  ‚Ä¢ ${dateStr} (${jourNom}) : -${duree}${shift.motif ? ` (${shift.motif})` : ''}`);
                                }
                            });
                        }
                    }
                    
                    // Stocker les donn√©es de la semaine
                    const weekStartStr = weekStart.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                    const weekEndStr = weekEnd.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                    
                    const weekRetardHours = weekRetardMinutes / 60;
                    // Solde = heures normales - retards - contrat (SANS dim/f√©ri√©s)
                    const weekEffectiveNormal = weekNormalHours - weekRetardHours;
                    const weekSolde = weekEffectiveNormal - contractHours;
                    
                    weeksData.push({
                        number: weekNumber,
                        range: `${weekStartStr} - ${weekEndStr}`,
                        normalHours: weekNormalHours,
                        effectiveHours: weekEffectiveNormal,
                        retardHours: weekRetardHours,
                        dimanchesHours: weekDimanchesHours,
                        feriesHours: weekFeriesHours,
                        absencesHours: weekAbsencesHours,
                        retardMinutes: weekRetardMinutes,
                        solde: weekSolde,
                        dimanchesDetails: weekDimanchesDetails,
                        feriesDetails: weekFeriesDetails,
                        absencesDetails: weekAbsencesDetails
                    });
                    
                    // Cumuler les totaux
                    totalNormalHours += weekNormalHours;
                    totalDimanchesHours += weekDimanchesHours;
                    totalFeriesHours += weekFeriesHours;
                    totalAbsencesHours += weekAbsencesHours;
                    totalRetardMinutes += weekRetardMinutes;
                    
                    // Ajouter aux d√©tails globaux
                    weekDimanchesDetails.forEach(d => allDimanchesDetails.push(d));
                    weekFeriesDetails.forEach(d => allFeriesDetails.push(d));
                    weekAbsencesDetails.forEach(d => allAbsencesDetails.push(d));
                    
                    weekStart.setDate(weekStart.getDate() + 7);
                    weekNumber++;
                }
                
                // G√©n√©rer le texte pour cet employ√©
                texte += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                texte += `                    üë§ ${employee.name.toUpperCase()}\n`;
                texte += `                    Contrat : ${contractHours}h/semaine\n`;
                texte += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
                
                // D√©tail par semaine
                weeksData.forEach(week => {
                    texte += `üìÖ SEMAINE ${week.number} (${week.range})\n`;
                    
                    // Afficher heures travaill√©es (avec retards si pr√©sents)
                    if (week.retardHours > 0) {
                        texte += `   Heures travaill√©es : ${formatHours(week.normalHours)} - ${formatHours(week.retardHours)} retard = ${formatHours(week.effectiveHours)}\n`;
                    } else {
                        texte += `   Heures travaill√©es : ${formatHours(week.effectiveHours)}\n`;
                    }
                    texte += `   Heures attendues   : ${formatHours(contractHours)}\n`;
                    
                    if (week.absencesDetails.length > 0) {
                        texte += `   Absences           : ${week.absencesDetails.length} jour(s) (${formatHours(week.absencesHours)})\n`;
                    }
                    
                    if (week.feriesDetails.length > 0) {
                        week.feriesDetails.forEach(f => {
                            texte += `   F√©ri√© travaill√©    : 1 jour le ${f.date} (${formatHours(f.hours)}) ‚Üê √Ä MAJORER\n`;
                        });
                    }
                    
                    if (week.dimanchesDetails.length > 0) {
                        week.dimanchesDetails.forEach(d => {
                            texte += `   Dimanche travaill√© : 1 jour le ${d.date} (${formatHours(d.hours)}) ‚Üê √Ä MAJORER\n`;
                        });
                    }
                    
                    const soldeText = week.solde >= 0 ? `+${formatHours(week.solde)}` : formatHours(week.solde);
                    texte += `   Solde semaine      : ${soldeText}\n\n`;
                });
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // PARTIE 2 : ACTIONS COMPTABLE (simplifi√©)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                
                const expectedHours = completeWeeks * contractHours;
                const totalRetardHours = totalRetardMinutes / 60;
                const totalEffectiveNormal = totalNormalHours - totalRetardHours;
                const soldeHoraire = totalEffectiveNormal - expectedHours;
                
                texte += `‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n`;
                texte += `‚îÉ                    üíº ACTIONS COMPTABLE                     ‚îÉ\n`;
                texte += `‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n\n`;
                
                texte += `   üìä R√âSUM√â HEURES (hors f√©ri√©s/dimanches travaill√©s)\n`;
                texte += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                texte += `   Heures travaill√©es   : ${formatHours(totalNormalHours)}\n`;
                if (totalRetardHours > 0) {
                    texte += `   Heures effectives    : ${formatHours(totalEffectiveNormal)}\n`;
                }
                texte += `   Heures attendues     : ${formatHours(expectedHours)} (${completeWeeks} sem √ó ${contractHours}h)\n`;
                texte += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                
                // Solde du mois
                const soldeMoisText = soldeHoraire >= 0 ? `+${formatHours(soldeHoraire)}` : formatHours(soldeHoraire);
                const soldeMoisIcon = soldeHoraire > 0 ? '‚úÖ' : soldeHoraire < 0 ? '‚ö†Ô∏è ' : '‚úÖ';
                texte += `   ${soldeMoisIcon} SOLDE DU MOIS    : ${soldeMoisText}\n\n`;
                
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // STATISTIQUES SUR TOUT LE MOIS (1er au dernier jour)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                texte += `   üìÜ STATISTIQUES DU MOIS COMPLET\n`;
                texte += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                texte += `   Jours travaill√©s     : ${totalDaysWorkedFullMonth} jours (du 1er au ${lastDayOfMonth.getDate()})\n`;
                
                // Jours f√©ri√©s travaill√©s (sur tout le mois)
                if (totalFeriesFullMonth.length > 0) {
                    const totalFeriesHoursMonth = totalFeriesFullMonth.reduce((sum, f) => sum + f.hours, 0);
                    const joursFeries = totalFeriesFullMonth.map(f => `${f.date} (${formatHours(f.hours)})`).join(', ');
                    texte += `   üéå F√âRI√âS TRAVAILL√âS  : ${totalFeriesFullMonth.length} jour${totalFeriesFullMonth.length > 1 ? 's' : ''} - ${joursFeries}\n`;
                    texte += `      ‚Üí Total √† majorer : ${formatHours(totalFeriesHoursMonth)}\n`;
                }
                
                // Dimanches travaill√©s (sur tout le mois)
                if (totalDimanchesFullMonth.length > 0) {
                    const totalDimHoursMonth = totalDimanchesFullMonth.reduce((sum, d) => sum + d.hours, 0);
                    const joursDim = totalDimanchesFullMonth.map(d => `${d.date} (${formatHours(d.hours)})`).join(', ');
                    texte += `   üìÖ DIMANCHES TRAVAILL√âS : ${totalDimanchesFullMonth.length} jour${totalDimanchesFullMonth.length > 1 ? 's' : ''} - ${joursDim}\n`;
                    texte += `      ‚Üí Total √† majorer : ${formatHours(totalDimHoursMonth)}\n`;
                }
                
                // Prime exceptionnelle
                if (primeExceptionnelle > 0) {
                    texte += `   üí∞ PRIME EXCEPTIONNELLE : ${primeExceptionnelle.toFixed(2)}‚Ç¨ NET\n`;
                }
                
                // Solde cumul√© (pour information)
                const soldeCumule = calculateCumulativeSolde(employee, currentDate.getMonth(), currentDate.getFullYear());
                const soldeCumuleText = soldeCumule >= 0 ? `+${formatHours(soldeCumule)}` : formatHours(soldeCumule);
                texte += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                texte += `   ‚ÑπÔ∏è  Pour info - Solde cumul√© : ${soldeCumuleText}\n`;
                
                texte += `\n`;
            });
            
            texte += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            texte += `G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR')}\n`;
            texte += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            return texte;
            
        } catch (error) {
            console.error('Erreur export texte:', error);
            showToast('Erreur lors de l\'export', 'error');
            return '';
        }
    }

    // ============================================
    // EXPORT COMPTABLE
    // ============================================
    function openExportComptableModal() {
        // Remplir la liste des employ√©s
        const select = document.getElementById('exportEmployes');
        select.innerHTML = '<option value="tous">Tous les employ√©s</option>';
        
        globalState.employees.filter(emp => !emp.archived).forEach(emp => {
            select.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
        });
        
        // G√©rer l'affichage des dates personnalis√©es
        document.getElementById('exportPeriode').addEventListener('change', function() {
            document.getElementById('periodePersonnalisee').style.display = 
                this.value === 'personnalise' ? 'block' : 'none';
        });
        
        // D√©finir les dates par d√©faut
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        
        document.getElementById('exportDateDebut').value = firstDay.toISOString().split('T')[0];
        document.getElementById('exportDateFin').value = lastDay.toISOString().split('T')[0];
        
        document.getElementById('exportComptableModal').style.display = 'block';
    }
    
    function generateExportComptable() {
        try {
            const periode = document.getElementById('exportPeriode').value;
            const employeSelection = document.getElementById('exportEmployes').value;
            
            let dateDebut, dateFin, periodeLabel;
            const now = new Date();
            
            if (periode === 'mois') {
                dateDebut = new Date(now.getFullYear(), now.getMonth(), 1);
                dateFin = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                periodeLabel = dateDebut.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            } else if (periode === 'moisPrecedent') {
                dateDebut = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                dateFin = new Date(now.getFullYear(), now.getMonth(), 0);
                periodeLabel = dateDebut.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            } else {
                dateDebut = new Date(document.getElementById('exportDateDebut').value);
                dateFin = new Date(document.getElementById('exportDateFin').value);
                periodeLabel = `${dateDebut.toLocaleDateString('fr-FR')} au ${dateFin.toLocaleDateString('fr-FR')}`;
            }
            
            // Filtrer les employ√©s
            let employees = globalState.employees.filter(emp => !emp.archived);
            if (employeSelection !== 'tous') {
                employees = employees.filter(emp => emp.id === employeSelection);
            }
            
            // Cr√©er le workbook Excel
            const wb = XLSX.utils.book_new();
            
            // ===== FEUILLE 1 : R√âCAP GLOBAL =====
            const recapData = [
                ['R√âCAPITULATIF PAIE - ' + periodeLabel.toUpperCase()],
                ['G√©n√©r√© le ' + new Date().toLocaleDateString('fr-FR') + ' √† ' + new Date().toLocaleTimeString('fr-FR')],
                [],
                ['Employ√©', 'Contrat (h/sem)', 'H. Travaill√©es', 'H. Retard', 'H. Effectives', 'H. Sup', 'Absences', 'Cong√©s', 'Dimanches', 'F√©ri√©s', 'Solde']
            ];
            
            employees.forEach(emp => {
                const stats = getEmployeeStats(emp, dateDebut, dateFin);
                recapData.push([
                    emp.name,
                    emp.contractHours || 35,
                    stats.totalHours.toFixed(2),
                    stats.retardHours.toFixed(2),
                    stats.effectiveHours.toFixed(2),
                    stats.overtime.toFixed(2),
                    stats.absences,
                    stats.conges,
                    stats.dimanches,
                    stats.feries,
                    (stats.solde >= 0 ? '+' : '') + stats.solde.toFixed(2)
                ]);
            });
            
            const wsRecap = XLSX.utils.aoa_to_sheet(recapData);
            wsRecap['!cols'] = [
                {wch: 20}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 15}, 
                {wch: 10}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 10}, {wch: 10}
            ];
            XLSX.utils.book_append_sheet(wb, wsRecap, 'R√©cap Global');
            
            // ===== FEUILLE 2 : D√âTAIL PAR EMPLOY√â =====
            employees.forEach(emp => {
                const detailData = [
                    [`D√âTAIL - ${emp.name.toUpperCase()}`],
                    [`P√©riode: ${periodeLabel}`],
                    [`Contrat: ${emp.contractHours || 35}h/semaine`],
                    [],
                    ['Date', 'Jour', 'Cr√©neau', 'H. Travaill√©es', 'Retard', 'Type', 'Dimanche', 'F√©ri√©', 'Observation']
                ];
                
                const details = getEmployeeDetailedStats(emp, dateDebut, dateFin);
                details.forEach(d => {
                    detailData.push([
                        d.date,
                        d.jour,
                        d.creneau,
                        d.heures,
                        d.retard,
                        d.type,
                        d.dimanche ? '‚úì' : '',
                        d.ferie ? '‚úì' : '',
                        d.observation
                    ]);
                });
                
                // Ligne de total
                const stats = getEmployeeStats(emp, dateDebut, dateFin);
                detailData.push([]);
                detailData.push(['TOTAL', '', '', stats.totalHours.toFixed(2), stats.retardHours.toFixed(2), '', stats.dimanches, stats.feries, '']);
                
                const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
                wsDetail['!cols'] = [
                    {wch: 12}, {wch: 10}, {wch: 15}, {wch: 15}, {wch: 10},
                    {wch: 12}, {wch: 10}, {wch: 10}, {wch: 25}
                ];
                XLSX.utils.book_append_sheet(wb, wsDetail, emp.name.substring(0, 30));
            });
            
            // ===== FEUILLE 3 : CALENDRIER √âV√âNEMENTS =====
            const eventsData = [
                ['CALENDRIER DES √âV√âNEMENTS - ' + periodeLabel.toUpperCase()],
                [],
                ['Date', 'Employ√©', 'Type', 'D√©tail']
            ];
            
            const allEvents = getAllEvents(employees, dateDebut, dateFin);
            allEvents.forEach(evt => {
                eventsData.push([evt.date, evt.employe, evt.type, evt.detail]);
            });
            
            const wsEvents = XLSX.utils.aoa_to_sheet(eventsData);
            wsEvents['!cols'] = [{wch: 12}, {wch: 20}, {wch: 15}, {wch: 40}];
            XLSX.utils.book_append_sheet(wb, wsEvents, '√âv√©nements');
            
            // T√©l√©charger le fichier
            const fileName = `Export_Paie_${periodeLabel.replace(/\s/g, '_')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            closeModal();
            showToast(`Export "${fileName}" g√©n√©r√© avec succ√®s !`, 'success');
            
        } catch (error) {
            console.error('Erreur export comptable:', error);
            showToast('Erreur lors de la g√©n√©ration de l\'export', 'error');
        }
    }
    
    function getEmployeeStats(employee, dateDebut, dateFin) {
        let totalHours = 0;
        let retardHours = 0;
        let absences = 0;
        let conges = 0;
        let repos = 0;
        let dimanches = 0;
        let feries = 0;
        let workDays = 0;
        
        const contractHours = employee.contractHours || 35;
        
        // Parcourir chaque jour de la p√©riode
        let currentDate = new Date(dateDebut);
        while (currentDate <= dateFin) {
            const weekStart = getWeekStart(currentDate);
            const year = weekStart.getFullYear();
            const firstDay = new Date(year, 0, 1);
            const pastDays = (weekStart - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            const weekKey = `${year}-W${weekNumber}`;
            const dayIndex = (currentDate.getDay() + 6) % 7; // Lundi = 0
            
            if (employee.planning && employee.planning[weekKey] && employee.planning[weekKey][dayIndex]) {
                const dayShifts = employee.planning[weekKey][dayIndex];
                let dayHasWork = false;
                
                dayShifts.forEach(shift => {
                    switch(shift.type) {
                        case 'work':
                            if (shift.hours) {
                                const hours = parseHours(shift.hours);
                                totalHours += hours;
                                dayHasWork = true;
                                
                                // V√©rifier dimanche et f√©ri√©
                                if (isDimanche(currentDate)) dimanches++;
                                const ferie = isJourFerie(currentDate);
                                if (ferie) feries++;
                            }
                            break;
                        case 'retard':
                            if (shift.retardMinutes) {
                                retardHours += (parseInt(shift.retardMinutes) || 0) / 60;
                            }
                            break;
                        case 'absent':
                            absences++;
                            break;
                        case 'conges':
                            conges++;
                            break;
                        case 'repos':
                            repos++;
                            break;
                    }
                });
                
                if (dayHasWork) workDays++;
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Calculer les heures effectives et overtime
        const effectiveHours = totalHours - retardHours;
        const weeksInPeriod = Math.ceil(workDays / 5) || 1;
        const expectedHours = weeksInPeriod * contractHours;
        const overtime = Math.max(0, effectiveHours - expectedHours);
        const solde = effectiveHours - expectedHours;
        
        return {
            totalHours,
            retardHours,
            effectiveHours,
            expectedHours,
            overtime,
            absences,
            conges,
            repos,
            dimanches,
            feries,
            workDays,
            solde
        };
    }
    
    function getEmployeeDetailedStats(employee, dateDebut, dateFin) {
        const details = [];
        const jours = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        
        let currentDate = new Date(dateDebut);
        while (currentDate <= dateFin) {
            const weekStart = getWeekStart(currentDate);
            const year = weekStart.getFullYear();
            const firstDay = new Date(year, 0, 1);
            const pastDays = (weekStart - firstDay) / 86400000;
            const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
            const weekKey = `${year}-W${weekNumber}`;
            const dayIndex = (currentDate.getDay() + 6) % 7;
            
            const dateStr = currentDate.toLocaleDateString('fr-FR');
            const jourStr = jours[currentDate.getDay()];
            const isDim = isDimanche(currentDate);
            const ferie = isJourFerie(currentDate);
            
            if (employee.planning && employee.planning[weekKey] && employee.planning[weekKey][dayIndex]) {
                const dayShifts = employee.planning[weekKey][dayIndex];
                
                dayShifts.forEach(shift => {
                    let creneau = '';
                    let heures = '';
                    let retard = '';
                    let type = '';
                    let observation = '';
                    
                    switch(shift.type) {
                        case 'work':
                            creneau = shift.text || '';
                            heures = shift.hours || '';
                            type = 'Travail';
                            if (isDim) observation = 'Majoration dimanche';
                            if (ferie) observation = `F√©ri√© (${ferie.nom})`;
                            break;
                        case 'retard':
                            type = 'Retard';
                            const mins = shift.retardMinutes || 0;
                            retard = `-${Math.floor(mins/60)}h${(mins%60).toString().padStart(2,'0')}`;
                            observation = shift.motif || '';
                            break;
                        case 'absent':
                            type = 'Absence';
                            observation = shift.text || 'Non justifi√©e';
                            break;
                        case 'conges':
                            type = 'Cong√©';
                            break;
                        case 'repos':
                            type = 'Repos';
                            break;
                        case 'cours':
                            type = 'Formation';
                            break;
                        default:
                            type = shift.type;
                            observation = shift.text || '';
                    }
                    
                    details.push({
                        date: dateStr,
                        jour: jourStr,
                        creneau,
                        heures,
                        retard,
                        type,
                        dimanche: isDim && shift.type === 'work',
                        ferie: ferie && shift.type === 'work' ? ferie.nom : null,
                        observation
                    });
                });
            }
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        return details;
    }
    
    function getAllEvents(employees, dateDebut, dateFin) {
        const events = [];
        
        // Ajouter les jours f√©ri√©s
        const feries = getJoursFeries(dateDebut.getFullYear());
        feries.forEach(f => {
            if (f.date >= dateDebut && f.date <= dateFin) {
                events.push({
                    date: f.date.toLocaleDateString('fr-FR'),
                    employe: 'TOUS',
                    type: 'üéå F√©ri√©',
                    detail: f.nom
                });
            }
        });
        
        // Parcourir les employ√©s
        employees.forEach(emp => {
            let currentDate = new Date(dateDebut);
            while (currentDate <= dateFin) {
                const weekStart = getWeekStart(currentDate);
                const year = weekStart.getFullYear();
                const firstDay = new Date(year, 0, 1);
                const pastDays = (weekStart - firstDay) / 86400000;
                const weekNumber = Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
                const weekKey = `${year}-W${weekNumber}`;
                const dayIndex = (currentDate.getDay() + 6) % 7;
                
                if (emp.planning && emp.planning[weekKey] && emp.planning[weekKey][dayIndex]) {
                    emp.planning[weekKey][dayIndex].forEach(shift => {
                        const dateStr = currentDate.toLocaleDateString('fr-FR');
                        
                        if (shift.type === 'work' && isDimanche(currentDate)) {
                            events.push({
                                date: dateStr,
                                employe: emp.name,
                                type: 'üìÖ Dimanche',
                                detail: `${shift.text} (${shift.hours})`
                            });
                        }
                        
                        if (shift.type === 'retard') {
                            const mins = shift.retardMinutes || 0;
                            events.push({
                                date: dateStr,
                                employe: emp.name,
                                type: '‚è∞ Retard',
                                detail: `${Math.floor(mins/60)}h${(mins%60).toString().padStart(2,'0')}${shift.motif ? ' - ' + shift.motif : ''}`
                            });
                        }
                        
                        if (shift.type === 'absent') {
                            events.push({
                                date: dateStr,
                                employe: emp.name,
                                type: '‚ùå Absence',
                                detail: shift.text || 'Non justifi√©e'
                            });
                        }
                        
                        if (shift.type === 'conges') {
                            events.push({
                                date: dateStr,
                                employe: emp.name,
                                type: 'üèñÔ∏è Cong√©',
                                detail: 'Journ√©e compl√®te'
                            });
                        }
                    });
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
        });
        
        // Trier par date
        events.sort((a, b) => {
            const dateA = a.date.split('/').reverse().join('');
            const dateB = b.date.split('/').reverse().join('');
            return dateA.localeCompare(dateB);
        });
        
        return events;
    }
    
    function getWeekStart(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = day === 0 ? -6 : 1 - day;
        d.setDate(d.getDate() + diff);
        return d;
    }

    
</script>
</body>
</html>
